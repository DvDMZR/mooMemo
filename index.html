<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#003366">
    <title>mooMemo (Cloud)</title>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        :root {
            /* GEA Brand Colors - Primary Palette */
            --primary: #003366;
            --primary-dark: #002244;
            --primary-light: #e6eef5;
            --primary-hover: #004080;

            /* GEA Accent -*/
            --accent: #e87722;
            --accent-light: #fff4eb;
            --accent-hover: #d66a1a;

            /* Secondary & Neutral */
            --secondary: #64748b;
            --secondary-light: #f1f5f9;

            /* Semantic Colors */
            --success: #10b981;
            --success-bg: #d1fae5;
            --danger: #ef4444;
            --danger-bg: #fee2e2;

            /* Status Colors */
            --status-fresh: #3b82f6;
            --status-fresh-bg: #dbeafe;
            --status-warning: #f59e0b;
            --status-warning-bg: #fff7ed;
            --status-critical: #b91c1c;
            --status-critical-bg: #fef2f2;

            /* Background & Surface */
            --bg: #f8fafc;
            --card-bg: #ffffff;
            --border-color: #e2e8f0;

            /* Typography */
            --text-main: #1e293b;
            --text-sub: #64748b;

            /* Shadows */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
            --shadow-glow: 0 0 20px rgba(0, 51, 102, 0.15);

            /* Animation */
            --transition-fast: 0.15s ease;
            --transition-normal: 0.25s ease;
            --transition-slow: 0.4s cubic-bezier(0.16, 1, 0.3, 1);

            /* Border Radius */
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-full: 9999px;
        }

        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            margin: 0;
            padding-bottom: 90px;
            color: var(--text-main);
            -webkit-tap-highlight-color: transparent;
            line-height: 1.5;
        }

        /* --- HEADER --- */
        .app-logo-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 12px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            position: sticky;
            top: 0;
            z-index: 110;
            height: 60px;
            box-sizing: border-box;
        }
        
        .app-logo-img { height: 32px; width: auto; }
        .header-title { font-weight: 700; font-size: 1.1rem; color: var(--primary); margin-left: 15px; letter-spacing: -0.01em; }
        .header-controls { display: flex; gap: 10px; align-items: center; }

        .back-btn {
            background: transparent; border: none; font-size: 0.95rem; color: var(--primary); cursor: pointer; display: none; font-weight: 600;
            padding: 8px 12px; border-radius: 8px; transition: background 0.2s; display: flex; align-items: center; gap: 6px;
        }
        .back-btn:active { background-color: var(--primary-light); }

        .icon-btn { background: transparent; border: none; color: var(--secondary); cursor: pointer; font-size: 1.1rem; padding: 8px; border-radius: 50%; transition: color 0.2s, background 0.2s; }
        .icon-btn:hover { color: var(--primary); background: #f1f5f9; }

        /* --- TABS --- */
        .nav-header {
            background: var(--card-bg); position: sticky; top: 60px; z-index: 100;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); display: none; justify-content: space-around;
            padding: 0 10px; border-bottom: 1px solid var(--border-color);
        }

        .nav-item {
            flex: 1; text-align: center; padding: 12px 5px; cursor: pointer;
            border-bottom: 2px solid transparent; color: var(--secondary); font-weight: 500; font-size: 0.8rem;
            transition: all 0.2s; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px;
        }
        .nav-item:hover { color: var(--primary); }
        .nav-item.active { border-bottom-color: var(--primary); color: var(--primary); }
        .nav-item i { font-size: 1.1rem; }

        /* --- SECTIONS --- */
        .section { display: none; width: 100%; max-width: 800px; margin: 20px auto; padding: 0 15px; box-sizing: border-box; }
        .section.active { display: block; animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1); }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .status-item-anim { animation: slideIn 0.3s ease-out forwards; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        h2 { font-size: 1.25rem; font-weight: 700; color: var(--text-main); margin-bottom: 1.5rem; display: flex; align-items: center; gap: 10px; }
        h2 i { color: var(--primary); }

        #dashboard { padding-top: 10px; }
        
        .filter-container { background: white; padding: 10px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); display: flex; flex-wrap: wrap; gap: 10px; align-items: center; justify-content: space-between; }
        
        /* SEARCH BOX */
        .search-container { width: 100%; margin-bottom: 10px; }
        .search-input { width: 100%; padding: 10px 14px; border: 1px solid var(--border-color); border-radius: 10px; font-size: 1rem; background: #f9fafb url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="%2364748b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>') no-repeat 10px center; padding-left: 36px; transition: all 0.2s; }
        .search-input:focus { outline: none; border-color: var(--primary); background-color: #fff; box-shadow: 0 0 0 3px rgba(0, 51, 102, 0.1); }

        .filter-tabs { display: flex; background: #f1f5f9; padding: 4px; border-radius: 8px; gap: 4px; }
        .filter-pill { border: none; background: transparent; padding: 6px 12px; font-size: 0.85rem; font-weight: 600; color: var(--text-sub); cursor: pointer; border-radius: 6px; transition: all 0.2s; }
        .filter-pill.active { background: white; color: var(--primary); box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .filter-control-group { display: flex; gap: 10px; align-items: center; }
        .year-select, .sort-select { padding: 6px 10px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 0.85rem; color: var(--text-main); background: white; min-width: 100px; }

        .report-list-item { background: white; border-radius: 12px; padding: 0; margin-bottom: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.1), 0 1px 2px rgba(0,0,0,0.06); display: flex; justify-content: space-between; align-items: stretch; border-left: 4px solid var(--secondary); transition: transform 0.2s, box-shadow 0.2s; overflow: hidden; position: relative; }
        .report-list-item:hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06); }
        .report-list-item.age-fresh { border-left-color: var(--status-fresh); }
        .report-list-item.age-warning { border-left-color: var(--status-warning); background-color: var(--status-warning-bg); }
        .report-list-item.age-critical { border-left-color: var(--status-critical); background-color: var(--status-critical-bg); }
        .report-list-item.all-resolved { border-left-color: var(--success); }
        
        .report-clickable-area { flex-grow: 1; padding: 16px; cursor: pointer; background: transparent; }
        .report-clickable-area:active { background-color: rgba(0,0,0,0.02); }
        
        .report-info h3 { margin: 0 0 6px 0; font-size: 1.05rem; color: var(--text-main); font-weight: 600; display: flex; justify-content: space-between; align-items: center; }
        .report-id { font-size: 0.75rem; font-weight: normal; color: var(--text-sub); background: #f1f5f9; padding: 2px 6px; border-radius: 4px; margin-left: 8px; }

        .report-info p { margin: 0; color: var(--text-sub); font-size: 0.9rem; margin-bottom: 4px; display: flex; align-items: center; gap: 6px; flex-wrap: wrap; }
        .report-info i { width: 16px; text-align: center; }
        
        .report-type-badge { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; font-weight: 700; background: #e2e8f0; color: #475569; margin-right: 6px; vertical-align: middle; }
        .report-age-badge { display: inline-block; font-size: 0.75rem; font-weight: 700; padding: 1px 6px; border-radius: 4px; margin-top: 0; white-space: nowrap; }
        .age-badge-warning { color: #92400e; background: rgba(245, 158, 11, 0.15); border: 1px solid rgba(245, 158, 11, 0.3); }
        .age-badge-critical { color: #7f1d1d; background: rgba(185, 28, 28, 0.1); border: 1px solid rgba(185, 28, 28, 0.3); }

        .report-actions { display: flex; align-items: center; justify-content: center; border-left: 1px solid var(--border-color); background: rgba(255,255,255,0.5); }
        
        .btn-action { background: transparent; border: none; width: 44px; height: 100%; font-size: 1.1rem; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; z-index: 50; color: var(--secondary); }
        .btn-action:hover { background-color: #e2e8f0; color: var(--primary); }
        .btn-action.delete:hover { background-color: var(--danger-bg); color: var(--danger); }

        .card { background: var(--card-bg); border-radius: 16px; padding: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 24px; border: 1px solid rgba(0,0,0,0.05); }

        label { display: block; font-weight: 600; margin-bottom: 8px; color: #374151; font-size: 0.95rem; }
        
        input, textarea, select { width: 100%; padding: 12px 14px; border: 1px solid #d1d5db; border-radius: 10px; font-size: 16px; box-sizing: border-box; transition: border-color 0.2s, box-shadow 0.2s; background: #f9fafb; color: #111827; }
        input:focus, textarea:focus, select:focus { outline: none; border-color: var(--primary); background: #fff; box-shadow: 0 0 0 3px rgba(0, 51, 102, 0.1); }

        .input-group { position: relative; }
        
        /* MERGED INPUT GROUP FOR ADDING USERS */
        .input-group-merged {
            display: flex;
            align-items: stretch;
            margin-bottom: 8px;
        }
        .input-group-merged input {
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;
            border-right: 0;
            flex: 1;
        }
        .input-group-merged .btn {
            margin: 0;
            border-top-left-radius: 0;
            border-bottom-left-radius: 0;
            width: auto;
            padding: 0 18px;
            height: auto;
            font-size: 1.1rem;
        }
        
        .mic-btn { position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: none; border: none; color: #9ca3af; cursor: pointer; font-size: 1.2rem; padding: 8px; z-index: 10; transition: color 0.2s; }
        .mic-btn:hover { color: var(--primary); }
        .mic-btn.listening { color: var(--danger); animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { transform: translateY(-50%) scale(1); } 50% { transform: translateY(-50%) scale(1.1); } 100% { transform: translateY(-50%) scale(1.1); } }
        
        .ai-btn { background: transparent; color: var(--primary); border: 1px solid var(--primary); padding: 6px 12px; border-radius: 8px; font-weight: 600; font-size: 0.85rem; cursor: pointer; transition: all 0.2s; width: auto; display: inline-flex; align-items: center; gap: 6px; }
        .ai-btn:hover { background: #f1f5f9; }
        
        #btn-improve-text { border: none; padding: 8px; font-size: 1.1rem; margin-top: 5px; }
        .ai-btn-disabled { opacity: 0.5 !important; cursor: not-allowed !important; background: #f3f4f6 !important; border-color: #d1d5db !important; color: #9ca3af !important; }

        /* REUSED STYLES FOR AUTHORS AND PARTICIPANTS */
        .tag-list { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px; }
        /* CHANGED: Tags are now Dark Blue with White Text */
        .tag-item { 
            background: var(--primary); 
            color: white; 
            padding: 6px 12px; 
            border-radius: 20px; 
            font-size: 0.9rem; 
            font-weight: 500; 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        /* CHANGED: Remove cross is white */
        .tag-remove { 
            cursor: pointer; 
            font-weight: 800; 
            font-size: 1.1rem; 
            opacity: 0.8; 
            color: white; 
        }
        .tag-remove:hover { opacity: 1; }

        /* POINT ITEM STYLE */
        .point-item { 
            background: white; border-radius: 12px; 
            padding: 16px; 
            margin-bottom: 12px; 
            border-left: 4px solid var(--secondary); 
            cursor: grab;
            transition: transform 0.2s, box-shadow 0.2s; 
            box-shadow: 0 1px 2px rgba(0,0,0,0.05); 
            position: relative;
            display: flex; 
            align-items: flex-start;
        }
        .point-item:active { cursor: grabbing; }
        .point-item.dragging { opacity: 0.5; background: #f9fafb; border: 2px dashed var(--primary); }
        
        .point-content-wrapper { flex-grow: 1; }
        
        .point-sort-column {
            display: flex;
            flex-direction: column;
            gap: 4px;
            margin-left: 12px;
            min-width: 24px;
            align-items: center;
            justify-content: flex-start;
            padding-top: 4px;
        }

        .sort-btn {
            background: #f1f5f9;
            border: none;
            color: var(--secondary);
            cursor: pointer;
            padding: 0;
            border-radius: 4px;
            font-size: 0.75rem;
            transition: all 0.1s;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 28px;
            width: 28px;
        }
        .sort-btn:hover { background: #e2e8f0; color: var(--primary); }

        .point-item:hover { transform: translateY(-1px); box-shadow: 0 2px 6px rgba(0,0,0,0.08); }
        .point-item.resolved { border-left-color: var(--success); }
        .point-item.age-fresh { border-left-color: var(--status-fresh); }
        .point-item.age-warning { border-left-color: var(--status-warning); }
        .point-item.age-critical { border-left-color: var(--status-critical); }
        
        .point-header-row { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 6px; }
        .point-title { font-weight: 600; font-size: 1.1rem; color: #111827; }
        
        .point-meta-row { font-size: 0.85rem; color: var(--text-sub); display: flex; align-items: center; gap: 12px; margin-top: 8px; flex-wrap: wrap; }
        .point-desc { color: #4b5563; margin-bottom: 8px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

        .status-badge { padding: 4px 10px; border-radius: 99px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; display: inline-block; white-space: nowrap; }
        .status-resolved { background: var(--success-bg); color: #065f46; }
        .status-open { background: #fef2f2; color: #991b1b; border: 1px solid #fecaca; }
        .badge-fresh { background: var(--status-fresh-bg); color: #1e40af; }
        .badge-warning { background: #fef3c7; color: #b45309; border: 1px solid #fcd34d; }
        .badge-critical { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }
        
        .ticket-link { color: var(--primary); text-decoration: none; font-weight: 600; background: var(--primary-light); padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; display: inline-block; margin-right: 8px; margin-bottom: 4px; }

        .img-grid { display: flex; gap: 20px; flex-wrap: wrap; margin-top: 15px; } 
        .img-thumb-container { position: relative; display: inline-block; transition: transform 0.1s; }
        .img-thumb { width: 80px; height: 80px; object-fit: cover; border-radius: 8px; border: 2px solid var(--border-color); box-shadow: 0 2px 4px rgba(0,0,0,0.05); display: block; }
        .img-thumb-container.is-large .img-thumb { border-color: var(--success); box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2); }
        .img-btn-remove { position: absolute; top: -8px; right: -8px; background: #ef4444; color: white; border-radius: 50%; width: 22px; height: 22px; text-align: center; line-height: 22px; font-size: 14px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.2); z-index: 10; }
        .img-btn-size { position: absolute; bottom: -10px; right: -10px; background: var(--secondary); color: white; border-radius: 12px; padding: 3px 8px; text-align: center; font-size: 10px; font-weight: 700; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: center; gap: 4px; z-index: 10; transition: all 0.2s; border: 1px solid white; }
        .img-btn-size:hover { transform: scale(1.05); }
        .img-btn-size.active-large { background: var(--success); }

        .img-lightbox-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: none; justify-content: center; align-items: center; z-index: 9999; cursor: zoom-out; }
        .img-lightbox-overlay img { max-width: 92vw; max-height: 92vh; object-fit: contain; border-radius: 8px; box-shadow: 0 0 40px rgba(0,0,0,0.5); }
        .img-lightbox-overlay .lightbox-close { position: absolute; top: 18px; right: 24px; color: white; font-size: 2rem; cursor: pointer; z-index: 10000; background: rgba(0,0,0,0.5); border-radius: 50%; width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; }
        .img-thumb { cursor: pointer; }

        .fab { position: fixed; bottom: 30px; right: 25px; width: 60px; height: 60px; background-color: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; box-shadow: 0 4px 15px rgba(0, 51, 102, 0.4); cursor: pointer; z-index: 90; display: none; transition: transform 0.2s, background-color 0.2s; }
        .fab:hover { transform: scale(1.05); background-color: #002850; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); display: none; justify-content: center; align-items: center; z-index: 200; }
        .modal-content { background: white; width: 90%; max-width: 800px; max-height: 85vh; overflow-y: auto; border-radius: 20px; padding: 30px; position: relative; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1); }
        .modal-content h3 { margin-top: 0; color: var(--text-main); font-size: 1.3rem; }
        .close-modal { position: absolute; top: 20px; right: 25px; font-size: 28px; cursor: pointer; color: #9ca3af; transition: color 0.2s; }
        
        .btn { padding: 14px 24px; border: none; border-radius: 12px; cursor: pointer; font-weight: 600; width: 100%; margin-top: 15px; font-size: 1rem; transition: filter 0.2s, transform 0.1s; }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 6px -1px rgba(0, 51, 102, 0.2); }
        .btn-secondary { background: white; color: var(--text-main); border: 1px solid var(--border-color); }
        .btn-success { background: var(--success); color: white; box-shadow: 0 4px 6px -1px rgba(16, 185, 129, 0.2); }

        .spinner { border: 3px solid #f3f3f3; border-top: 3px solid var(--primary); border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite; display: none; margin-left: 10px; vertical-align: middle; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        #toast { visibility: hidden; min-width: 250px; margin-left: -140px; background-color: #1f2937; color: #fff; text-align: center; border-radius: 50px; padding: 12px 20px; position: fixed; z-index: 1000; left: 50%; bottom: 30px; font-size: 0.95rem; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); font-weight: 500; }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }

        #pdf-preview { background: white; padding: 40px; min-height: 800px; border: 1px solid #e5e7eb; font-size: 14px; color: #374151; }
        .pdf-header { border-bottom: 2px solid #111827; padding-bottom: 20px; margin-bottom: 30px; }
        .pdf-row { display: flex; justify-content: space-between; margin-bottom: 8px; border-bottom: 1px dashed #f3f4f6; padding-bottom: 4px; }
        .pdf-row:last-child { border-bottom: none; }

        /* --- PRINT STYLES --- */
        @media print {
            /* Hide all UI elements */
            .nav-header, .fab, .section:not(#export), .btn, .app-logo-header, #dashboard,
            #sync-status, .modal-overlay, #toast, .img-lightbox-overlay,
            .share-link-container, .shared-header {
                display: none !important;
            }

            /* Show only export section */
            #export {
                display: block !important;
                padding: 0 !important;
                margin: 0 !important;
                max-width: 100% !important;
            }
            #export > h2, #export > .ai-btn, #export > .btn { display: none !important; }

            /* PDF Preview container */
            #pdf-preview {
                border: none !important;
                padding: 0 !important;
                box-shadow: none !important;
                font-size: 11pt !important;
            }

            /* Page setup */
            @page {
                size: A4 portrait;
                margin: 15mm;
            }

            /* Ensure images print well */
            img {
                max-width: 100% !important;
                page-break-inside: avoid !important;
            }

            /* Page breaks */
            .pdf-point-item {
                page-break-inside: avoid;
            }

            /* Logo should be crisp */
            .pdf-header img {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            /* Preserve colors */
            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            body {
                padding: 0 !important;
                margin: 0 !important;
                background: white !important;
            }
        }

        #sync-status { position: fixed; top: 70px; right: 15px; font-size: 12px; padding: 5px 10px; border-radius: 12px; background: rgba(255,255,255,0.8); box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: none; align-items: center; gap: 5px; z-index: 99; }
        #sync-status.online { color: var(--success); display: flex; }
        #sync-status.offline { color: var(--danger); display: flex; }

        /* --- EXPORT ACTION BAR --- */
        .export-action-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        .export-action-btn {
            flex: 1;
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 16px;
            border-radius: 10px;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
        }
        .export-action-btn:hover { background: #002850; }
        .export-action-btn.copied { background: var(--success); }

        /* --- EXPORT FILTER BAR --- */
        .export-filter-bar {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 20px;
        }
        .export-filter-label {
            font-size: 0.8rem;
            color: var(--text-sub);
        }
        .export-filter-btn {
            background: transparent;
            border: none;
            color: var(--text-sub);
            padding: 4px 10px;
            border-radius: 4px;
            font-weight: 500;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .export-filter-btn:hover {
            color: var(--text-main);
            background: #f1f5f9;
        }
        .export-filter-btn.active {
            color: var(--primary);
            font-weight: 600;
        }

        /* Read-only mode indicator */
        .readonly-banner {
            background: #fef3c7;
            border: 1px solid #fcd34d;
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9rem;
            color: #92400e;
        }
        .readonly-banner i { font-size: 1.1rem; }

        /* --- SHARED/PUBLIC VIEW MODE --- */
        .shared-mode .app-logo-header,
        .shared-mode .nav-header,
        .shared-mode #dashboard,
        .shared-mode #header,
        .shared-mode #points,
        .shared-mode #status,
        .shared-mode .fab,
        .shared-mode #sync-status,
        .shared-mode .export-action-bar,
        .shared-mode #readonly-banner {
            display: none !important;
        }

        .shared-mode #export {
            display: block !important;
            margin-top: 0 !important;
            padding-top: 0 !important;
        }

        .shared-mode #export > h2,
        .shared-mode #export > .ai-btn,
        .shared-mode #export > .btn,
        .shared-mode #export > .export-filter-bar {
            display: none !important;
        }

        .shared-header {
            display: none;
            background: linear-gradient(135deg, var(--primary) 0%, #004080 100%);
            color: white;
            padding: 20px;
            margin-bottom: 0;
        }

        .shared-mode .shared-header {
            display: block;
        }

        .shared-header-content {
            max-width: 800px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .shared-header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .shared-header-logo {
            height: 36px;
            filter: brightness(0) invert(1);
        }

        .shared-header-title {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .shared-header-subtitle {
            font-size: 0.8rem;
            opacity: 0.85;
            margin-top: 2px;
        }

        .shared-header-badge {
            background: rgba(255,255,255,0.2);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .shared-header-actions {
            display: flex;
            gap: 10px;
        }

        .shared-btn {
            background: rgba(255,255,255,0.15);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 10px 18px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
            text-decoration: none;
        }

        .shared-btn:hover {
            background: rgba(255,255,255,0.25);
        }

        .shared-btn-primary {
            background: white;
            color: var(--primary);
            border-color: white;
        }

        .shared-btn-primary:hover {
            background: #f0f0f0;
        }

        .shared-mode #export .btn {
            max-width: 350px;
        }

        .shared-mode body,
        .shared-mode {
            padding-bottom: 30px !important;
        }

        /* Mobile adjustments for shared header */
        @media (max-width: 600px) {
            .shared-header-content {
                flex-direction: column;
                align-items: flex-start;
            }
            .shared-header-actions {
                width: 100%;
                justify-content: stretch;
            }
            .shared-btn {
                flex: 1;
                justify-content: center;
            }
        }
        
        .lang-toggle-container { display: flex; gap: 10px; margin-top: 15px; justify-content: center; }
        .lang-btn { border: 2px solid var(--primary); background: white; color: var(--primary); padding: 8px 16px; border-radius: 8px; font-weight: bold; cursor: pointer; transition: all 0.2s; }
        .lang-btn.active { background: var(--primary); color: white; }

        /* --- DRAG & DROP STYLES --- */
        .drop-zone {
            border: 2px dashed #cbd5e1;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            color: #64748b;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 15px;
            background: #f8fafc;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 80px;
        }
        .drop-zone:hover {
            border-color: var(--primary);
            color: var(--primary);
            background: #f1f5f9;
        }
        .drop-zone.dragover {
            border-color: var(--primary);
            background: #e0f2fe; /* Light Blue */
            color: var(--primary);
            transform: scale(1.02);
        }
        .drop-zone i {
            font-size: 28px;
            margin-bottom: 8px;
            display: block;
        }
        .drop-zone span {
            font-weight: 500;
            font-size: 0.9rem;
        }

        /* --- INFO & LEGAL SECTION IN SETTINGS --- */
        .settings-section { margin-top: 25px; border-top: 1px solid #e2e8f0; padding-top: 20px; }
        .info-toggle-btn {
            background: transparent; border: none; width: 100%; text-align: left; padding: 10px;
            font-weight: 600; color: var(--text-sub); display: flex; justify-content: space-between; align-items: center;
            cursor: pointer; border-radius: 8px; transition: background 0.2s;
        }
        .info-toggle-btn:hover { background: #f8fafc; color: var(--primary); }
        .info-content { display: none; padding: 10px; font-size: 0.85rem; color: var(--text-sub); text-align: left; animation: fadeIn 0.3s; }
        .info-content.open { display: block; }
        .info-logo-area { text-align: center; margin-bottom: 15px; }
        .info-version { font-weight: 700; color: var(--primary); font-size: 1rem; }
        .info-author { font-size: 0.8rem; margin-top: 4px; }
        .changelog-btn { width: 100%; margin-top: 10px; font-size: 0.8rem; padding: 8px; background: #f1f5f9; border: 1px solid #e2e8f0; color: var(--text-main); }
        .legal-text { margin-top: 15px; font-size: 0.75rem; line-height: 1.4; border-top: 1px dashed #e2e8f0; padding-top: 10px; }

        /* CHANGELOG MODAL STYLES */
        .changelog-list { text-align: left; margin-top: 15px; max-height: 300px; overflow-y: auto; }
        .cl-item { margin-bottom: 15px; border-bottom: 1px solid #f1f5f9; padding-bottom: 10px; }
        .cl-ver { font-weight: 700; color: var(--primary); display: flex; justify-content: space-between; }
        .cl-date { font-weight: 400; font-size: 0.75rem; color: #94a3b8; }
        .cl-changes { margin: 5px 0 0 0; padding-left: 20px; font-size: 0.9rem; color: #475569; }
        .cl-changes li { margin-bottom: 4px; }

        /* --- RELATED REPORTS SIDEBAR (Desktop only, positioned in margin) --- */
        .export-layout {
            position: relative;
        }
        .export-main {
            width: 100%;
        }
        .related-reports-sidebar {
            display: none;
            position: fixed;
            right: 20px;
            top: 200px;
            width: 220px;
            max-height: calc(100vh - 220px);
            overflow-y: auto;
            z-index: 50;
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(8px);
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border: 1px solid #e2e8f0;
        }
        @media (min-width: 1400px) {
            .related-reports-sidebar {
                display: block;
            }
        }
        .related-reports-sidebar::-webkit-scrollbar {
            width: 4px;
        }
        .related-reports-sidebar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        .related-reports-title {
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--text-sub);
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .related-reports-title i {
            color: var(--primary);
            font-size: 0.8rem;
        }
        .related-reports-count {
            background: var(--primary);
            color: white;
            font-size: 0.65rem;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 99px;
            margin-left: auto;
        }
        .related-reports-customer {
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--text-main);
            margin-bottom: 12px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e2e8f0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .related-reports-list {
            display: flex;
            flex-direction: column;
            gap: 0;
            position: relative;
            padding-left: 16px;
        }
        .related-reports-list::before {
            content: '';
            position: absolute;
            left: 4px;
            top: 8px;
            bottom: 8px;
            width: 2px;
            background: linear-gradient(to bottom, var(--primary), #e2e8f0);
            border-radius: 2px;
        }
        .related-report-item {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 10px 12px;
            display: flex;
            flex-direction: column;
            gap: 4px;
            font-size: 0.8rem;
            transition: all 0.2s;
            cursor: pointer;
            position: relative;
            margin-bottom: 8px;
        }
        .related-report-item::before {
            content: '';
            position: absolute;
            left: -12px;
            top: 50%;
            transform: translateY(-50%);
            width: 8px;
            height: 8px;
            background: white;
            border: 2px solid #cbd5e1;
            border-radius: 50%;
            z-index: 1;
        }
        .related-report-item.has-open-points::before {
            border-color: var(--danger);
            background: #fef2f2;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.15);
        }
        .related-report-item:hover {
            background: #f1f5f9;
            border-color: var(--primary);
            transform: translateX(2px);
        }
        .related-report-item:hover::before {
            border-color: var(--primary);
        }
        .related-report-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .related-report-date {
            font-weight: 600;
            color: var(--text-main);
            font-size: 0.85rem;
        }
        .related-report-id {
            font-size: 0.7rem;
            color: var(--text-sub);
            font-weight: 500;
        }
        .related-report-meta {
            font-size: 0.75rem;
            color: var(--text-sub);
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .related-report-meta i {
            font-size: 0.65rem;
        }
        .related-report-badge {
            font-size: 0.65rem;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 99px;
            align-self: flex-start;
        }
        .related-report-badge.has-open {
            background: #fef2f2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }
        .related-report-badge.all-resolved {
            background: #dcfce7;
            color: #065f46;
            border: 1px solid #bbf7d0;
        }
        .no-related-reports {
            font-size: 0.75rem;
            color: #94a3b8;
            font-style: italic;
            padding: 12px;
            text-align: center;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px dashed #e2e8f0;
        }
        @media print {
            .related-reports-sidebar {
                display: none !important;
            }
        }

        /* =================================================================
           DESIGN IMPROVEMENTS
           ================================================================= */

        /* --- SKELETON LOADING --- */
        @keyframes skeleton-shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e8e8e8 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: skeleton-shimmer 1.5s ease-in-out infinite;
            border-radius: var(--radius-sm);
        }
        .skeleton-text { height: 1em; margin-bottom: 0.5em; }
        .skeleton-title { height: 1.4em; width: 60%; margin-bottom: 0.75em; }
        .skeleton-card {
            background: white;
            border-radius: var(--radius-md);
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: var(--shadow-sm);
        }
        .skeleton-card .skeleton-line { height: 12px; margin-bottom: 8px; border-radius: 4px; }
        .skeleton-card .skeleton-line:last-child { width: 40%; }

        /* --- ENHANCED MICRO-INTERACTIONS --- */
        @keyframes pop-in {
            0% { transform: scale(0.95); opacity: 0; }
            70% { transform: scale(1.02); }
            100% { transform: scale(1); opacity: 1; }
        }
        @keyframes success-pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4); }
            50% { box-shadow: 0 0 0 8px rgba(16, 185, 129, 0); }
        }
        .pop-in { animation: pop-in 0.3s ease-out forwards; }
        .success-pulse { animation: success-pulse 0.6s ease-out; }

        /* Button Press Effect */
        .btn:active, .export-action-btn:active, .filter-pill:active {
            transform: scale(0.97);
        }

        /* Focus Ring for Accessibility */
        .btn:focus-visible, input:focus-visible, select:focus-visible, textarea:focus-visible {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
        }

        /* --- IMPROVED CARD DESIGN --- */
        .card {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            padding: 24px;
            box-shadow: var(--shadow-md);
            margin-bottom: 24px;
            border: 1px solid var(--border-color);
            transition: box-shadow var(--transition-normal), transform var(--transition-normal);
        }
        .card:hover {
            box-shadow: var(--shadow-lg);
        }

        /* Report List Item Enhancement */
        .report-list-item {
            border-radius: var(--radius-md);
            transition: transform var(--transition-fast), box-shadow var(--transition-fast);
        }
        .report-list-item:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-lg);
        }
        .report-list-item:active {
            transform: translateY(-1px);
        }

        /* Point Item Enhancement */
        .point-item {
            border-radius: var(--radius-md);
            transition: transform var(--transition-fast), box-shadow var(--transition-fast), border-color var(--transition-fast);
        }
        .point-item:hover {
            box-shadow: var(--shadow-md);
        }

        /* --- TYPOGRAPHY IMPROVEMENTS --- */
        h2 {
            font-size: 1.35rem;
            font-weight: 700;
            letter-spacing: -0.02em;
            color: var(--text-main);
        }
        h2 i {
            color: var(--accent);
        }

        .header-title {
            font-weight: 800;
            font-size: 1.15rem;
            letter-spacing: -0.02em;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-hover) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        label {
            font-weight: 600;
            font-size: 0.9rem;
            letter-spacing: -0.01em;
            color: var(--text-main);
        }

        /* --- NAVIGATION IMPROVEMENTS --- */
        .nav-item {
            position: relative;
            transition: color var(--transition-fast);
        }
        .nav-item::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            width: 0;
            height: 2px;
            background: var(--accent);
            transition: width var(--transition-normal), left var(--transition-normal);
        }
        .nav-item:hover::after {
            width: 50%;
            left: 25%;
        }
        .nav-item.active::after {
            width: 100%;
            left: 0;
            background: var(--primary);
        }
        .nav-item.active {
            border-bottom-color: transparent;
        }

        /* Tab Icon Animation */
        .nav-item i {
            transition: transform var(--transition-fast);
        }
        .nav-item:hover i {
            transform: scale(1.1);
        }
        .nav-item.active i {
            color: var(--accent);
        }

        /* --- FLOATING ACTION BUTTON ENHANCEMENT --- */
        .fab {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            box-shadow: var(--shadow-lg), 0 4px 20px rgba(0, 51, 102, 0.3);
            transition: transform var(--transition-fast), box-shadow var(--transition-fast);
        }
        .fab:hover {
            transform: scale(1.08);
            box-shadow: var(--shadow-lg), 0 6px 25px rgba(0, 51, 102, 0.4);
        }
        .fab:active {
            transform: scale(1.02);
        }

        /* --- ACCENT COLOR USAGE --- */
        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-hover) 100%);
            box-shadow: var(--shadow-md);
            transition: all var(--transition-fast);
        }
        .btn-primary:hover {
            box-shadow: var(--shadow-lg);
            filter: brightness(1.05);
        }

        /* Accent Button Variant */
        .btn-accent {
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-hover) 100%);
            color: white;
            box-shadow: 0 4px 6px -1px rgba(232, 119, 34, 0.3);
        }
        .btn-accent:hover {
            filter: brightness(1.05);
        }

        /* --- INPUT ENHANCEMENTS --- */
        input, textarea, select {
            border-radius: var(--radius-sm);
            transition: border-color var(--transition-fast), box-shadow var(--transition-fast), background var(--transition-fast);
        }
        input:hover, textarea:hover, select:hover {
            border-color: var(--secondary);
        }
        input:focus, textarea:focus, select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0, 51, 102, 0.1);
            background: white;
        }

        /* --- STATUS BADGES ENHANCEMENT --- */
        .status-badge {
            font-weight: 700;
            letter-spacing: 0.03em;
            transition: transform var(--transition-fast);
        }
        .status-badge:hover {
            transform: scale(1.05);
        }

        /* --- TOAST NOTIFICATION ENHANCEMENT --- */
        #toast {
            background: linear-gradient(135deg, var(--text-main) 0%, #374151 100%);
            border-radius: var(--radius-full);
            box-shadow: var(--shadow-lg);
        }
        #toast.success {
            background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
        }
        #toast.error {
            background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%);
        }

        /* --- MODAL ENHANCEMENT --- */
        .modal-content {
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg), 0 0 40px rgba(0, 0, 0, 0.1);
        }
        .modal-overlay {
            backdrop-filter: blur(6px);
        }

        /* --- ICON BUTTON ENHANCEMENT --- */
        .icon-btn {
            transition: all var(--transition-fast);
            border-radius: var(--radius-sm);
        }
        .icon-btn:hover {
            background: var(--primary-light);
            color: var(--primary);
            transform: scale(1.05);
        }

        /* --- FILTER PILLS ENHANCEMENT --- */
        .filter-pill {
            transition: all var(--transition-fast);
        }
        .filter-pill:hover:not(.active) {
            background: rgba(0, 51, 102, 0.08);
            color: var(--primary);
        }
        .filter-pill.active {
            background: var(--primary);
            color: white;
            box-shadow: var(--shadow-sm);
        }

        /* --- TAG ENHANCEMENT --- */
        .tag-item {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-hover) 100%);
            transition: transform var(--transition-fast), box-shadow var(--transition-fast);
        }
        .tag-item:hover {
            transform: scale(1.02);
            box-shadow: var(--shadow-md);
        }

        /* --- EMPTY STATE PLACEHOLDER --- */
        .empty-state {
            text-align: center;
            padding: 48px 24px;
            color: var(--text-sub);
        }
        .empty-state-icon {
            font-size: 3rem;
            color: var(--border-color);
            margin-bottom: 16px;
        }
        .empty-state-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-main);
            margin-bottom: 8px;
        }
        .empty-state-desc {
            font-size: 0.9rem;
        }

        /* --- SCROLLBAR STYLING --- */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: var(--bg);
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb {
            background: var(--secondary);
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }

        /* --- SMOOTH PAGE TRANSITIONS --- */
        .section.active {
            animation: fadeIn var(--transition-slow);
        }

        /* --- RIPPLE EFFECT --- */
        @keyframes ripple {
            to {
                transform: scale(4);
                opacity: 0;
            }
        }
        .ripple {
            position: absolute;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.4);
            transform: scale(0);
            animation: ripple 0.6s linear;
            pointer-events: none;
        }

    </style>
</head>
<body>

    <!-- SHARED VIEW HEADER (only visible in shared mode) -->
    <div class="shared-header" id="shared-header">
        <div class="shared-header-content">
            <div class="shared-header-left">
                <img src="https://cdn.gea.com/-/jssmedia/common/logos/gea-logo.svg?mw=85" alt="GEA" class="shared-header-logo">
                <div>
                    <div class="shared-header-title" id="shared-report-title">Besuchsbericht</div>
                    <div class="shared-header-subtitle" id="shared-report-subtitle">Geteilter Bericht</div>
                </div>
                <div class="shared-header-badge" id="shared-open-badge" style="display:none;">
                    <i class="fa-solid fa-circle-exclamation"></i> <span id="shared-open-count">0</span> Offen
                </div>
            </div>
            <div class="shared-header-actions">
                <button class="shared-btn" onclick="window.printReport()">
                    <i class="fa-solid fa-file-pdf"></i> PDF Speichern
                </button>
                <a class="shared-btn shared-btn-primary" id="shared-back-link" href="?">
                    <i class="fa-solid fa-arrow-right"></i> Zur App
                </a>
            </div>
        </div>
    </div>

    <!-- DATALIST FOR AUTOCOMPLETE (Will be populated by JS) -->
    <datalist id="list-names"></datalist>
    <datalist id="list-assignees"></datalist>

    <!-- APP HEADER -->
    <div class="app-logo-header">
        <div style="display:flex; align-items:center;">
            <button class="back-btn" id="nav-back-btn" onclick="window.goToDashboard()" data-i18n="overview" style="display:none;">
                <i class="fa-solid fa-chevron-left"></i> bersicht
            </button>
            <img src="https://cdn.gea.com/-/jssmedia/common/logos/gea-logo.svg?mw=85" alt="GEA" class="app-logo-img" id="header-logo">
            <span id="app-title" class="header-title" data-i18n="app_title">mooMemo (v1.5.8)</span>
        </div>
        <div class="header-controls">
            <button class="icon-btn" onclick="window.openSettings()" style="color:var(--primary);" title="Settings"><i class="fa-solid fa-gear"></i></button>
        </div>
    </div>

    <div id="sync-status"><i class="fas fa-cloud"></i> <span id="sync-text">Verbunden</span></div>

    <!-- TABS -->
    <div class="nav-header" id="tab-navigation">
        <div class="nav-item active" onclick="window.switchTab('header')"><i class="fa-solid fa-clipboard-user"></i> <span data-i18n="tab_base">Basis</span></div>
        <div class="nav-item" onclick="window.switchTab('points')"><i class="fa-solid fa-list-check"></i> <span data-i18n="tab_points">Punkte</span></div>
        <div class="nav-item" onclick="window.switchTab('status')"><i class="fa-solid fa-check-double"></i> <span data-i18n="tab_status">Status</span></div>
        <div class="nav-item" onclick="window.switchTab('export')"><i class="fa-solid fa-file-pdf"></i> <span data-i18n="tab_export">Export</span></div>
    </div>

    <!-- DASHBOARD -->
    <div id="dashboard" class="section active">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 1.5rem;">
            <h2 style="margin-bottom:0;"><i class="fa-solid fa-folder-open"></i> <span data-i18n="dash_title">Berichte (Cloud)</span></h2>
            <button class="icon-btn" onclick="window.askAdminTools()" style="color:var(--primary);" title="Admin Tools"><i class="fa-solid fa-user-shield"></i></button>
        </div>
        <div class="filter-container">
             <div class="search-container">
                <input type="text" class="search-input" id="search-input" placeholder="Suchen... (ID, Kunde, von:Name)" oninput="window.renderReportList()">
            </div>
            
            <div class="filter-tabs" id="filter-type-container">
                <button class="filter-pill active" onclick="window.setFilterType('all')" data-i18n="filter_all">Alle</button>
                <button class="filter-pill" onclick="window.setFilterType('AMS')">AMS</button>
                <button class="filter-pill" onclick="window.setFilterType('CMS')">CMS</button>
                <button class="filter-pill" onclick="window.setFilterType('AS')">AS</button>
            </div>
            <div class="filter-control-group">
                <select class="year-select" id="year-filter" onchange="window.setFilterYear(this.value)"><option value="all" data-i18n="filter_all_years">Alle Jahre</option></select>
                <select class="sort-select" id="sort-filter" onchange="window.setSortMethod(this.value)">
                    <option value="date_desc" data-i18n="sort_date_desc">Datum (Neu)</option>
                    <option value="date_asc" data-i18n="sort_date_asc">Datum (Alt)</option>
                    <option value="author" data-i18n="sort_author">Ersteller</option>
                    <option value="open_points" data-i18n="sort_open">Offene Punkte</option>
                </select>
            </div>
        </div>
        <button class="btn btn-primary" onclick="window.createNewReport()"><i class="fa-solid fa-plus"></i> <span data-i18n="btn_new">Neuer Bericht erstellen</span></button>
        <div id="report-list" style="margin-top:25px;">
            <div style="text-align:center; padding: 20px; color: #64748b;"><i class="fas fa-circle-notch fa-spin"></i> <span data-i18n="loading">Lade Daten aus der Cloud...</span></div>
        </div>
        <hr style="border:0; border-top:1px solid #e2e8f0; margin:35px 0 20px 0;">
        <h3 style="font-size:1rem; color:var(--text-sub); margin-bottom:10px;"><i class="fa-solid fa-screwdriver-wrench"></i> <span data-i18n="tools_title">Tools</span></h3>
        <button class="btn btn-secondary" onclick="document.getElementById('import-input').click()" style="width:auto; padding: 8px 16px; font-size: 0.85rem; margin-top:0;"><i class="fa-solid fa-file-import"></i> <span data-i18n="btn_import">Bericht importieren / Update</span></button>
        <input type="file" id="import-input" style="display:none" accept=".json" onchange="window.importBackup(this)">
    </div>

    <!-- HEADER DATA -->
    <div id="header" class="section">
        <h2><i class="fa-solid fa-info-circle"></i> <span data-i18n="h_base">Basisdaten</span></h2>
        <div class="card">
            <label data-i18n="lbl_area">Bereich</label>
            <select id="h_type" onchange="window.updateCurrentReportHeader()" style="margin-bottom: 20px;"><option value="AMS">AMS</option><option value="CMS">CMS</option><option value="AS">AS</option></select>
            <label data-i18n="lbl_customer">Kunde / Projekt</label>
            <div class="input-group"><input type="text" id="h_customer" placeholder="z.B. Mller GmbH" oninput="window.updateCurrentReportHeader()"><button class="mic-btn" onclick="window.listen('h_customer')"><i class="fa-solid fa-microphone"></i></button></div>
            <br><label data-i18n="lbl_date">Datum (von - bis)</label>
            <div style="display:flex; gap:15px;"><input type="date" id="h_date_from" onchange="window.updateCurrentReportHeader()"><input type="date" id="h_date_to" onchange="window.updateCurrentReportHeader()"></div>
            
            <br><label data-i18n="lbl_author">Verfasser</label>
            <div id="authors-list" class="tag-list"></div>
            <div class="input-group-merged">
                <input type="text" id="new_author" placeholder="Name whlen..." oninput="window.handleInputAutofill(this, 'list-names', window.addAuthor)" onkeydown="if(event.key==='Enter'){event.preventDefault(); window.addAuthor();}">
                <button class="btn btn-primary" onclick="window.addAuthor()"><i class="fa-solid fa-plus"></i></button>
            </div>
            
            <br><hr style="border:0; border-top:1px solid #eee; margin:25px 0;"><label data-i18n="lbl_participants">Teilnehmer</label>
            <div id="participants-list" class="tag-list"></div>
            <div class="input-group-merged">
                <input type="text" id="new_participant" placeholder="Name whlen..." oninput="window.handleInputAutofill(this, 'list-names', window.addParticipant)" onkeydown="if(event.key==='Enter'){event.preventDefault(); window.addParticipant();}">
                <button class="btn btn-primary" onclick="window.addParticipant()"><i class="fa-solid fa-plus"></i></button>
            </div>
        </div>
        <button class="btn btn-primary" onclick="window.switchTab('points')" data-i18n="btn_next_points">Weiter zu den Punkten</button>
    </div>

    <!-- POINTS LIST -->
    <div id="points" class="section">
        <h2><i class="fa-solid fa-list"></i> <span data-i18n="h_points">Besuchs-Punkte</span></h2>
        <p style="color:var(--text-sub); font-size:0.9rem; margin-bottom:15px;" data-i18n="points_hint">Tippe auf einen Punkt zum Bearbeiten.</p>
        <div id="points-list"></div>
        <div class="fab" id="fab-btn" onclick="window.openModal()"><i class="fa-solid fa-plus"></i></div>
    </div>

    <!-- STATUS OVERVIEW -->
    <div id="status" class="section">
        <h2><i class="fa-solid fa-tasks"></i> <span data-i18n="h_status">Status bersicht</span></h2>
        <div style="display:flex; gap:20px; flex-wrap:wrap; align-items:flex-start;">
            <div style="flex:1 1 300px;">
                <div style="background:white; padding:20px; border-radius:16px; border-top:5px solid var(--danger); text-align:center; margin-bottom:20px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);"><div style="font-size:2.5rem; font-weight:800; color:var(--danger); line-height:1;" id="count-open">0</div><div style="font-size:0.85rem; color:var(--text-sub); font-weight:600; margin-top:5px;" data-i18n="status_open_uc">OFFEN</div></div>
                <div id="list-open"></div>
            </div>
            <div style="flex:1 1 300px;">
                <div style="background:white; padding:20px; border-radius:16px; border-top:5px solid var(--success); text-align:center; margin-bottom:20px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);"><div style="font-size:2.5rem; font-weight:800; color:var(--success); line-height:1;" id="count-resolved">0</div><div style="font-size:0.85rem; color:var(--text-sub); font-weight:600; margin-top:5px;" data-i18n="status_resolved_uc">GELST / INFO</div></div>
                <div id="list-resolved"></div>
            </div>
        </div>
    </div>

    <!-- EXPORT -->
    <div id="export" class="section">
        <h2><i class="fa-solid fa-print"></i> <span data-i18n="h_export">Bericht Abschlieen</span></h2>

        <!-- READ-ONLY BANNER (shown when viewing shared link) -->
        <div id="readonly-banner" class="readonly-banner" style="display:none;">
            <i class="fa-solid fa-eye"></i>
            <span data-i18n="readonly_info">Du siehst einen geteilten Bericht (Nur-Lesen-Modus).</span>
        </div>

        <!-- EXPORT ACTION BAR -->
        <div class="export-action-bar" id="export-action-bar">
            <button class="export-action-btn" onclick="window.printReport()">
                <i class="fa-solid fa-file-pdf"></i> <span data-i18n="btn_download_pdf">Als PDF speichern</span>
            </button>
            <button class="export-action-btn" id="share-link-btn" onclick="window.copyShareLink()">
                <i class="fa-solid fa-copy"></i> <span data-i18n="share_title">Link kopieren</span>
            </button>
        </div>

        <!-- EXPORT FILTER BUTTONS -->
        <div class="export-filter-bar" id="export-filter-bar">
            <span class="export-filter-label">Anzeigen:</span>
            <button class="export-filter-btn active" id="filter-all-btn" onclick="window.setExportFilter('all')">
                Alle
            </button>
            <button class="export-filter-btn" id="filter-open-btn" onclick="window.setExportFilter('open')">
                Nur Offene
            </button>
        </div>

        <!-- Export Layout with Sidebar -->
        <div class="export-layout">
            <div class="export-main">
                <div id="pdf-preview"></div>
            </div>

            <!-- Related Reports Sidebar (Desktop only) -->
            <div id="related-reports-sidebar" class="related-reports-sidebar">
                <div class="related-reports-title">
                    <i class="fa-solid fa-folder-tree"></i>
                    <span>Weitere Berichte</span>
                </div>
                <div id="related-reports-list" class="related-reports-list"></div>
            </div>
        </div>
    </div>

    <!-- MODALS & TOAST -->
    <div class="modal-overlay" id="settings-modal">
        <div class="modal-content" style="max-width:350px; text-align:center;">
            <span class="close-modal" onclick="window.closeSettings()">&times;</span>
            <h3 style="color:var(--text-main)"><i class="fa-solid fa-gear"></i> <span data-i18n="settings_title">Einstellungen</span></h3>
            
            <p data-i18n="settings_lang">App Sprache / App Language</p>
            <div class="lang-toggle-container">
                <button class="lang-btn active" data-lang="de" onclick="window.setLanguage('de')">DE</button>
                <button class="lang-btn" data-lang="en" onclick="window.setLanguage('en')">EN</button>
            </div>
            
            <p style="font-weight:600; margin-bottom:5px; margin-top:15px;">KI Zielsprache (Textverbesserung)</p>
            <div class="lang-toggle-container" id="ai-lang-container">
                <button class="lang-btn active" onclick="window.setAiTargetLang('de')">Deutsch</button>
                <button class="lang-btn" onclick="window.setAiTargetLang('en')">English</button>
            </div>
            
            <!-- CHANGELOG BUTTON MOVED HERE -->
            <button class="btn btn-secondary changelog-btn" onclick="window.openChangelog()" style="margin-top: 20px; width: 100%;">
                <i class="fa-solid fa-list-ul"></i> Was ist neu? (Changelog)
            </button>

            <!-- APP INFO & LEGAL SECTION -->
            <div class="settings-section">
                <button class="info-toggle-btn" onclick="window.toggleInfoSection()">
                    <span><i class="fa-solid fa-circle-info" style="color:var(--primary); margin-right:5px;"></i> App-Info & Rechtliches</span>
                    <i class="fa-solid fa-chevron-down" id="info-chevron"></i>
                </button>
                <div id="info-content" class="info-content">
                    <div class="info-logo-area">
                        <img src="https://cdn.gea.com/-/jssmedia/common/logos/gea-logo.svg?mw=85" style="height:30px; opacity:0.8;">
                        <div class="info-version">mooMemo v1.5.8</div>
                        <div class="info-author"> 2026 David Mazur</div>
                    </div>
                    
                    <div class="legal-text">
                        <strong>Impressum & Kontakt:</strong><br>
                        Angaben gem  5 TMG:<br><br>
                        David Mazur<br>
                        c/o GEA Farm Technologies GmbH<br>
                        Siemensstrae 25-27<br>
                        59199 Bnen<br><br>
                        Kontakt:<br>
                        E-Mail: david.mazur@gea.com<br>
                        <br>
                        <em>Lizenziert zur internen Nutzung durch die GEA Farm Technologies GmbH.</em>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- NEW CHANGELOG MODAL -->
    <div class="modal-overlay" id="changelog-modal">
        <div class="modal-content" style="max-width:500px;">
            <span class="close-modal" onclick="document.getElementById('changelog-modal').style.display='none'">&times;</span>
            <h3 style="color:var(--primary); text-align:center;"><i class="fa-solid fa-rocket"></i> Was ist neu?</h3>
            <div id="changelog-container" class="changelog-list"></div>
            <button class="btn btn-primary" onclick="document.getElementById('changelog-modal').style.display='none'">Verstanden</button>
        </div>
    </div>
    
    <div class="modal-overlay" id="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="window.closeModal()">&times;</span><h3 id="modal-title" data-i18n="modal_new_point">Neuer Punkt</h3><input type="hidden" id="edit-index" value="-1">
            <label data-i18n="lbl_ticket">Ticketnummer</label><div class="input-group"><input type="text" id="p_ticket" placeholder="z.B. 123456"><button class="mic-btn" onclick="window.listen('p_ticket')"><i class="fa-solid fa-microphone"></i></button></div><br>
            <label data-i18n="lbl_title">Titel / Thema</label><div class="input-group"><input type="text" id="p_title" placeholder="..."><button class="mic-btn" onclick="window.listen('p_title')"><i class="fa-solid fa-microphone"></i></button></div><br>
            <label data-i18n="lbl_desc">Beschreibung</label><div class="input-group"><textarea id="p_desc" rows="4" placeholder="..."></textarea><button class="mic-btn" onclick="window.listen('p_desc')"><i class="fa-solid fa-microphone"></i></button></div>
            <button id="btn-improve-text" class="ai-btn" onclick="window.improveDescription()" title="Text mit KI berarbeiten" style="margin-top:5px;">
                <i class="fa-solid fa-wand-magic-sparkles"></i>
            </button>
            <br>
            <label data-i18n="lbl_assignee">Verantwortlich</label><div class="input-group"><input type="text" id="p_assignee" placeholder="Name whlen..." autocomplete="off" oninput="window.handleInputAutofill(this, 'list-assignees', null)"><button class="mic-btn" onclick="window.listen('p_assignee')"><i class="fa-solid fa-microphone"></i></button></div><br>
            <label data-i18n="lbl_status">Status</label><select id="p_status"><option value="open" data-i18n="opt_open">Offen (Zu erledigen)</option><option value="resolved" data-i18n="opt_resolved">Gelst / Info</option></select><br>
            
            <label><span data-i18n="lbl_images">Bilder hinzufgen</span> <div class="spinner" id="img-spinner"></div></label>
            
            <!-- DROP ZONE -->
            <div id="drop-zone" class="drop-zone" onclick="document.getElementById('p_images').click()" 
                 ondragover="event.preventDefault(); this.classList.add('dragover');" 
                 ondragleave="this.classList.remove('dragover');" 
                 ondrop="event.preventDefault(); this.classList.remove('dragover'); window.processFiles(event.dataTransfer.files);">
                <i class="fa-solid fa-cloud-arrow-up"></i>
                <span>Bilder hier ablegen oder klicken</span>
                <input type="file" id="p_images" multiple accept="image/*" style="display:none" onchange="window.handleImageUpload()">
            </div>

            <div id="modal-img-preview" class="img-grid"></div>
            
            <button class="btn btn-success" onclick="window.savePoint()"><span data-i18n="btn_save">Speichern</span></button><button class="btn" style="background:#fee2e2; color:#991b1b; margin-top:10px;" onclick="window.askDeletePoint()" id="btn-delete"><span data-i18n="btn_delete">Lschen</span></button>
        </div>
    </div>
    
    <div class="modal-overlay" id="pin-auth-modal">
        <div class="modal-content" style="max-width:400px; text-align:center;"><div style="font-size:3rem; margin-bottom:10px;" id="pin-icon"><i class="fa-solid fa-lock"></i></div><h3 style="color:var(--text-main)" id="pin-title" data-i18n="admin_title">Admin Zugriff</h3><p style="color:var(--text-sub)" id="pin-desc" data-i18n="admin_desc">Bitte Admin-PIN eingeben.</p><div style="margin: 20px 0;"><label style="text-align:left; font-size:0.8rem; margin-bottom:5px;">Admin PIN</label><input type="password" id="auth-pin" placeholder="PIN" style="text-align:center; letter-spacing: 5px; font-size: 1.2rem; font-weight:bold;"></div><div style="display:flex; gap:10px; justify-content:center; margin-top:25px;"><button class="btn btn-secondary" onclick="window.closePinModal()" style="margin-top:0"><span data-i18n="btn_cancel">Abbrechen</span></button><button class="btn" id="pin-confirm-btn" style="color:white; margin-top:0" onclick="window.verifyPin()"><span data-i18n="btn_confirm">Besttigen</span></button></div></div>
    </div>
    
    <div class="modal-overlay" id="delete-point-confirm-modal">
        <div class="modal-content" style="max-width:400px; text-align:center;"><div style="font-size:3rem; color:var(--danger); margin-bottom:10px;"><i class="fa-solid fa-trash-can"></i></div><h3 style="color:var(--text-main)" data-i18n="confirm_del_title">Punkt lschen?</h3><p style="color:var(--text-sub)" data-i18n="confirm_del_msg">Mchtest du diesen Punkt unwiderruflich entfernen?</p><div style="display:flex; gap:10px; justify-content:center; margin-top:25px;"><button class="btn btn-secondary" onclick="window.closeDeletePointModal()" style="margin-top:0"><span data-i18n="btn_cancel">Abbrechen</span></button><button class="btn" style="background:var(--danger); color:white; margin-top:0" onclick="window.executeDeletePoint()"><span data-i18n="btn_delete_confirm">Ja, Lschen</span></button></div></div>
    </div>
    
    <div class="modal-overlay" id="admin-tools-modal">
        <div class="modal-content" style="max-width:400px; text-align:center;">
            <span class="close-modal" onclick="window.closeAdminToolsModal()">&times;</span>
            <div style="font-size:3rem; color:var(--primary); margin-bottom:10px;"><i class="fa-solid fa-toolbox"></i></div>
            <h3 style="color:var(--text-main)" data-i18n="admin_area">Admin Bereich</h3>
            
            <div style="background:#f8fafc; padding:15px; border-radius:12px; margin-top:20px; border:1px solid #e2e8f0;">
                <p style="font-weight:700; margin-top:0; font-size:0.9rem;">Globaler API Key (Cloud)</p>
                <input type="password" id="admin-api-key-input" placeholder="Hier Key eingeben..." style="text-align:center; margin-bottom:10px; width:100%; box-sizing:border-box; padding:10px; border-radius:8px; border:1px solid #ccc;">
                <button class="btn btn-primary" onclick="window.saveGlobalApiKey()" style="margin-top:0; font-size:0.85rem; width:100%;">
                    In Cloud speichern
                </button>
                <p style="font-size:0.75rem; color:#64748b; margin-bottom:0; margin-top:8px;">
                    Dieser Key wird zentral gespeichert. Alle Mitarbeiter nutzen ihn automatisch.
                </p>
            </div>

            <p style="color:var(--text-sub); margin-top:25px;" data-i18n="data_backup">Datensicherung</p>
            <div style="display:flex; flex-direction:column; gap:10px; margin-top:10px;">
                <button class="btn btn-secondary" onclick="window.performExport()" style="margin-top:0"><i class="fa-solid fa-download"></i> <span data-i18n="backup_save">Backup speichern</span></button>
                <button class="btn btn-secondary" onclick="document.getElementById('import-input').click(); window.closeAdminToolsModal();" style="margin-top:0"><i class="fa-solid fa-upload"></i> <span data-i18n="backup_load">Backup importieren</span></button>
            </div>
        </div>
    </div>

    <div id="toast"></div>

    <!-- LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, deleteDoc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        // IMPORT STORAGE
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // --- KONFIGURATION START ---
        const myFirebaseConfig = {
            apiKey: "AIzaSyDw4L6j1QPHUsA9ExJdZwbmGyLWvo0VGBI",
            authDomain: "moomemo-a9012.firebaseapp.com",
            projectId: "moomemo-a9012",
            storageBucket: "moomemo-a9012.firebasestorage.app",
            messagingSenderId: "1096220000219",
            appId: "1:1096220000219:web:6abb389d502f93b6b271fe"
        };
        const myAppId = "moomemo-a9012"; 
        
        const APP_VERSION = "1.5.8";
        const APP_AUTHOR = "David Mazur";
        
        // --- KONFIGURATION NAMEN ---
        const CONST_NAMES = [
            "Marc Kleinheinrich", "Markus Krampe", "Salih Cetinkilic", "Stephan Dutka", 
            "Jakub Mechlinski", "Adam Antolik", "Ron Oostdam", "Dick Valk", 
            "Herman Lubbers", "Karsten Kristensen", "Victor Del Rincon", "Thorsten Gerling", 
            "David Mazur", "Lena Krippendorf", "Stefan Marten", "Walter Weymann", 
            "Jan Mhlnickel", "Simon Kirchhof", "Katrin Schilkowski", "Ibrar Aslam", 
            "Ismail Songur", "Tobias Haupt", "Manuel Bury", "Philipp Wiemann", 
            "Armin Hhnscheid", "Christina Jerichen", "Dennis Jeffries", "Kevin Preece", "Michael Maffo Lando"
        ];
        const CONST_DEPARTMENTS = ["T&I", "QM", "Customer Care", "TSS", "Hndler", "Dealer"];

        // CHANGELOG DEFINITION
        const CHANGELOG = [
            {
                ver: "1.5.8",
                date: "2026-01-29",
                changes: [
                    "GEA-Farbsystem",
                    "Micro-Interactions: Hover, Press & Focus-Effekte.",
                    "Card-Design mit Animationen.",
                    "Navigation mit animiertem Unterstrich.",
                    "Custom Scrollbar & verbesserte Accessibility.",
                    "NEU: Sidebar zeigt Berichte des selben Kunden (Nur Desktop).",
                    "Roter Indikator bei offenen Punkten.",
                    "Fix: Verfasser-nderungen in bersicht sichtbar."
                ]
            },
            {
                ver: "1.5.7",
                date: "2026-01-29",
                changes: [
                    "NEU: Zauberstab generiert automatisch kurze berschrift wenn keine vorhanden.",
                    "Zauberstab: Bei vorhandener berschrift nur Rechtschreibprfung.",
                    "Punkte-Tab: Neues 'OFFEN' Badge statt 'Neu' fr offene Punkte.",
                    "Export: Farbige Badge-Styles wie in der App (rot/grn)."
                ]
            },
            {
                ver: "1.5.6",
                date: "2026-01-28",
                changes: [
                    "NEU: Berichte per Link teilen - Empfnger knnen den Export direkt ffnen.",
                    "Verbesserter PDF-Export: Native Browser-Druckfunktion fr bessere Qualitt.",
                    "GEA-Logo wird als SVG eingebunden fr scharfe Darstellung.",
                    "Export-Filter: Nur offene Punkte anzeigen."
                ]
            },
            {
                ver: "1.5.4",
                date: "2026-01-27",
                changes: [
                    "Bilder-Lightbox: Thumbnails in Punkten knnen per Klick vergrert angezeigt werden.",
                    "Bilder-Lightbox: Bilder im Export/PDF-Vorschau knnen per Klick als Popup vergrert werden.",
                    "PDF-Export als BETA gekennzeichnet."
                ]
            },
            {
                ver: "1.5.3",
                date: "2026-01-26",
                changes: [
                    "Fix: Bilder werden nun im PDF-Export korrekt angezeigt.",
                    "Fix: Logo im PDF-Header wird nun korrekt dargestellt.",
                    "Bilder werden beim Upload als Base64 gespeichert fr zuverlssigen PDF-Export."
                ]
            },
            {
                ver: "1.5.2",
                date: "2026-01-25",
                changes: [
                    "Fix: Zeichenkodierung korrigiert (Umlaute werden nun korrekt dargestellt).",
                    "Code-Optimierungen und Bereinigung."
                ]
            },
             {
                ver: "1.5.1",
                date: "2026-01-23",
                changes: [
                    "Funktion: Mehrere Verfasser pro Bericht optimiert.",
                    "Autofill fr Namen (Verfasser, Teilnehmer, Verantwortlich).",
                    "Optimierung der PDF-Ausgabe.",
                    "UI-Textanpassungen (Verantwortlich statt Adressat)."
                ]
            },
            {
                ver: "1.5.0",
                date: "2026-01-23",
                changes: [
                    "Bilder Upload per Drag & Drop am PC.",
                    "Mobile: Auswahl zwischen Kamera und Galerie gefixt.",
                    "Neuer Info-Bereich: Changelog & Impressum.",
                    "Copyright & Kontaktinformationen aktualisiert.",
                    "Kleinere Anpassungen & Fehlerbehebungen."
                ]
            },
            {
                ver: "1.4.9",
                date: "2026-01-17",
                changes: [
                    "Cloud-Speicher fr API Keys.",
                    "Settings bleiben nach Neustart erhalten.",
                    "Verbesserte Bildqualitt & Zoom.",
                    "Logo-Update (GEA)."
                ]
            }
        ];

        console.log("mooMemo Version:", APP_VERSION);
        // --- KONFIGURATION ENDE ---

        let firebaseConfig;
        let appId;
        
        // --- NDERUNG: ZWINGENDE VERWENDUNG DER USER-CONFIG ---
        firebaseConfig = myFirebaseConfig;
        appId = myAppId;

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app); // Init Storage

        let currentUser = null;
        let allReports = []; 
        let currentReportId = null;
        let points = []; 
        let tempImages = []; 
        let pendingPinAction = null; 
        let headerUpdateTimeout = null; 
        const LOGO_SRC = "data:image/svg+xml;base64,PHN2ZyB2aWV3Qm94PSIwIDAgODUgMjciIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHBhdGggZD0iTTcxLjc2MSAwLjczMTM0Nkg2NS4zMzY5TDYxLjA1NDIgOS4yOTg4M0w2NS44MTkzIDkuMjk5ODNMNjguNTY2MSAzLjgxMjFMNzkuODU3NCAyNi40MzM4SDg0LjYyMjVMNzEuNzYxIDAuNzMxMzQ2WiIgZmlsbD0iIzAzMDNCOCIvPjxwYXRoIGQ9Ik02OS42MiAxMS40NDM2TDEzLjk0NDggMTEuNDQxNkwxMS44MDM0IDE1LjcyNTNIMjAuMzY4OVYyMi4xNTA5SDEyLjc3N0M4LjA4Mjc4IDIyLjE1MDkgNC4yNjM2OCAxOC4zMjQ2IDQuMjYzNjggMTMuNTg2NUM0LjI2MzY4IDguODQ4NDEgOC4wODI3OCA1LjAxNDg5IDEyLjc3NyA1LjAxNDg5SDIyLjUwMjJWMC43MjkwNzNMMTIuNzc3IDAuNzI5MDc0QzUuNzMxNzMgMC43MjkwNzQgMCA2LjQ5Njk0IDAgMTMuNTg2NUMwIDIwLjY3NjEgNS43MzE3MyAyNi40MzQ3IDEyLjc3NyAyNi40MzQ3SDI0LjY1MTZWMTUuNzI1M0gzMS4wNzU2VjI2LjQzNDdINDguMjA2NEw1MC4zNDc4IDIyLjE1MDlIMzUuMzU4M1YxNS43MjUzSDU3LjgxNTdMNTIuNDg5MSAyNi40MzQ3SDU3LjI1MTlMNjIuNjA2IDE1LjcyNTNINzEuNzYxM0w2OS42MiAxMS40NDM2WiIgZmlsbD0iIzAzMDNCOCIvPjxwYXRoIGQ9Ik0zNS4zNTg0IDUuMDEzOTZMNTAuMzQ3NiA1LjAxNTA0VjAuNzMxMjkyTDMxLjA3MzIgMC43MjgxNDJMMzEuMDczNiA5LjI5OTc3SDM1LjM1ODRWNS4wMTM5NloiIGZpbGw9IiMwMzAzQjgiLz48L3N2Zz4K";
        let LOGO_PNG = null; // Will be set at runtime by converting SVG to PNG
        
        let filterType = 'all';
        let filterYear = 'all';
        let sortMethod = 'date_desc';
        let currentLang = 'de';
        let aiTargetLang = 'de';

        // SHARE LINK PARAMETERS
        let isReadOnly = false;
        let sharedReportId = null;
        let sharedTab = null;
        let exportFilter = 'all'; // 'all' | 'open'

        // DYNAMIC API KEY
        let globalGeminiKey = ""; 

        const translations = {
            de: {
                app_title: "mooMemo", overview: "bersicht", tab_base: "Basis", tab_points: "Punkte", tab_status: "Status", tab_export: "Export", dash_title: "Berichte (Cloud)", filter_all: "Alle", filter_all_years: "Alle Jahre", sort_date_desc: "Datum (Neu)", sort_date_asc: "Datum (Alt)", sort_author: "Ersteller", sort_open: "Offene Punkte", btn_new: "Neuer Bericht erstellen", loading: "Lade Daten aus der Cloud...", tools_title: "Tools", btn_import: "Bericht importieren / Update", h_base: "Basisdaten", lbl_area: "Bereich", lbl_customer: "Kunde / Projekt", lbl_date: "Datum (von - bis)", lbl_author: "Verfasser", lbl_participants: "Teilnehmer", btn_next_points: "Weiter zu den Punkten", h_points: "Besuchs-Punkte", points_hint: "Tippe auf einen Punkt zum Bearbeiten.", h_status: "Status bersicht", status_open_uc: "OFFEN", status_resolved_uc: "GELST / INFO", h_export: "Bericht Abschlieen", btn_download_pdf: "Als PDF speichern", modal_new_point: "Neuer Punkt", lbl_ticket: "Ticketnummer", lbl_title: "Titel / Thema", lbl_desc: "Beschreibung", lbl_assignee: "Verantwortlich", lbl_status: "Status", opt_open: "Offen (Zu erledigen)", opt_resolved: "Gelst / Info", lbl_images: "Bilder hinzufgen", btn_save: "Speichern", btn_delete: "Lschen", btn_delete_confirm: "Ja, Lschen", btn_cancel: "Abbrechen", btn_confirm: "Besttigen", admin_title: "Admin Zugriff", admin_desc: "Bitte Admin-PIN eingeben.", confirm_del_title: "Punkt lschen?", confirm_del_msg: "Mchtest du diesen Punkt unwiderruflich entfernen?", admin_area: "Admin Bereich", data_backup: "Datensicherung & Wiederherstellung", backup_save: "Backup speichern (Export)", backup_load: "Backup importieren", status_open: "OFFEN", status_resolved: "GELST / INFO", no_assignee: "Nicht zugewiesen", no_points: "Keine Punkte.", no_open_points: "Keine offenen Punkte", no_resolved_points: "Keine gelsten Punkte", overdue: "berfllig", months_short: "Mon.", new: "Neu", settings_title: "Einstellungen", settings_lang: "Sprache / Language", delete_report_title: "Bericht lschen?", delete_report_msg: "Mchtest du diesen Bericht unwiderruflich aus der Cloud lschen?", toast_saved: "Gespeichert", toast_deleted: "Gelscht", toast_removed: "Bericht wurde entfernt", ai_generating: "Generiere Titel...", ai_improving: "berarbeite Text...", ai_error: "Fehler bei der berarbeitung.", pdf_title: "Besuchsbericht", lbl_responsible: "Verantwortlich", search_placeholder: "Suchen... (ID, Kunde, von:Name)", ai_translating: "bersetze Bericht...", share_title: "Link kopieren", share_desc: "Link kopieren und versenden", btn_copy: "Kopieren", toast_copied: "Link kopiert!", readonly_info: "Du siehst einen geteilten Bericht (Nur-Lesen-Modus)."
            },
            en: {
                app_title: "mooMemo", overview: "Overview", tab_base: "Basic", tab_points: "Points", tab_status: "Status", tab_export: "Export", dash_title: "Reports (Cloud)", filter_all: "All", filter_all_years: "All Years", sort_date_desc: "Date (New)", sort_date_asc: "Date (Old)", sort_author: "Author", sort_open: "Open Points", btn_new: "Create New Report", loading: "Loading cloud data...", tools_title: "Tools", btn_import: "Import Report / Update", h_base: "Basic Data", lbl_area: "Area", lbl_customer: "Customer / Project", lbl_date: "Date (from - to)", lbl_author: "Author", lbl_participants: "Participants", btn_next_points: "Go to Points", h_points: "Visit Points", points_hint: "Tap on a point to edit.", h_status: "Status Overview", status_open_uc: "OPEN", status_resolved_uc: "RESOLVED / INFO", h_export: "Complete Report", btn_download_pdf: "Save as PDF", modal_new_point: "New Point", lbl_ticket: "Ticket Number", lbl_title: "Title / Topic", lbl_desc: "Description", lbl_assignee: "Responsible", lbl_status: "Status", opt_open: "Open (To do)", opt_resolved: "Resolved / Info", lbl_images: "Add Images", btn_save: "Save", btn_delete: "Delete", btn_delete_confirm: "Yes, Delete", btn_cancel: "Cancel", btn_confirm: "Confirm", admin_title: "Admin Access", admin_desc: "Please enter Admin PIN.", confirm_del_title: "Delete Point?", confirm_del_msg: "Do you want to permanently delete this point?", admin_area: "Admin Area", data_backup: "Backup & Restore", backup_save: "Save Backup (Export)", backup_load: "Import Backup", status_open: "OPEN", status_resolved: "RESOLVED / INFO", no_assignee: "Unassigned", no_points: "No points yet.", no_open_points: "No open points", no_resolved_points: "No resolved points", overdue: "Overdue", months_short: "mo.", new: "New", settings_title: "Settings", settings_lang: "Sprache / Language", delete_report_title: "Delete Report?", delete_report_msg: "Do you want to permanently delete this report from the cloud?", toast_saved: "Saved", toast_deleted: "Deleted", toast_removed: "Report was removed", ai_generating: "Generating Title...", ai_improving: "Improving Text...", ai_error: "Error improving text.", pdf_title: "Visit Report", lbl_responsible: "Responsible", search_placeholder: "Search... (ID, Customer, from:Name)", ai_translating: "Translating Report...", share_title: "Copy link", share_desc: "Copy and send link", btn_copy: "Copy", toast_copied: "Link copied!", readonly_info: "You are viewing a shared report (Read-only mode)."
            }
        };

        // --- HELPER FUNCTIONS ---
        window.getAgeInMonths = function(dateStr) {
            if (!dateStr) return 0;
            const start = new Date(dateStr);
            const now = new Date();
            if(isNaN(start.getTime())) return 0;
            let months = (now.getFullYear() - start.getFullYear()) * 12;
            months -= start.getMonth();
            months += now.getMonth();
            return months <= 0 ? 0 : months;
        };

        window.getAgeClass = function(dateStr) {
            const months = window.getAgeInMonths(dateStr);
            if (months >= 6) return 'age-critical';
            if (months >= 3) return 'age-warning';
            return 'age-fresh';
        };

        window.getAgeBadge = function(dateStr) {
            const months = window.getAgeInMonths(dateStr);
            const t = translations[currentLang];
            if (months >= 6) return `<span class="status-badge badge-critical"><i class="fa-solid fa-triangle-exclamation"></i> ${months} ${t.months_short}</span>`;
            if (months >= 3) return `<span class="status-badge badge-warning"><i class="fa-solid fa-clock"></i> ${months} ${t.months_short}</span>`;
            return `<span class="status-badge badge-fresh">${t.new}</span>`;
        };
        
        window.getDashboardAgeBadge = function(dateStr) {
            const months = window.getAgeInMonths(dateStr);
            const t = translations[currentLang];
            if (months >= 6) return `<span style="color:#7f1d1d; font-weight:700; margin-left:8px; font-size:0.85rem;"><i class="fa-solid fa-triangle-exclamation"></i> ${t.overdue}: ${months}. ${t.months_short}</span>`;
            if (months >= 3) return `<span style="color:#92400e; font-weight:700; margin-left:8px; font-size:0.85rem;"><i class="fa-solid fa-clock"></i> ${t.overdue}: ${months}. ${t.months_short}</span>`;
            return '';
        };

        window.getWeekNumber = function(d) {
            d=new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7));
            var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
            return [Math.ceil((((d - yearStart) / 86400000) + 1) / 7), d.getUTCFullYear()];
        };

        // --- CONVERT SVG LOGO TO PNG AT STARTUP (html2canvas can't render SVGs reliably) ---
        window.prepareLogo = function() {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = function() {
                    // Render at 4x for crisp PDF output (85*4=340, 27*4=108)
                    const canvas = document.createElement('canvas');
                    canvas.width = 340;
                    canvas.height = 108;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, 340, 108);
                    LOGO_PNG = canvas.toDataURL('image/png');
                    console.log('Logo PNG prepared for PDF export');
                    resolve();
                };
                img.onerror = function() {
                    console.warn('Could not prepare logo PNG');
                    resolve();
                };
                img.src = LOGO_SRC;
            });
        };
        // Run immediately
        window.prepareLogo();

        // --- UI HELPERS ---
        window.updateSyncStatus = function(isOnline) {
            const el = document.getElementById('sync-status');
            const txt = document.getElementById('sync-text');
            if(!el) return;
            if(isOnline) { el.classList.add('online'); el.classList.remove('offline'); txt.textContent = "Cloud Verbunden"; }
            else { el.classList.add('offline'); el.classList.remove('online'); txt.textContent = "Offline"; }
        };

        window.showToast = function(message) {
            const x = document.getElementById("toast"); 
            if(x) {
                x.className = "show"; 
                x.textContent = message; 
                setTimeout(() => x.className = x.className.replace("show", ""), 3000);
            }
        };

        // --- AUTH ---
        window.initAuth = async function() {
            try {
                // Prevent loop if already signed in
                if (!auth.currentUser) {
                     await signInAnonymously(auth);
                }
            } catch(e) { 
                console.error("Auth failed", e);
                if(document.getElementById('sync-text')) document.getElementById('sync-text').textContent = "Auth Fehler";
                if(document.getElementById('sync-status')) document.getElementById('sync-status').classList.add('offline');
            }
        };

        // --- MAIN LOGIC FUNCTIONS ---
        
        window.renderParticipantsList = function(l) { 
            const el = document.getElementById('participants-list');
            if(el) el.innerHTML = l.length===0 ? '<span style="color:#aaa;">Keine Teilnehmer</span>' : l.map((p,i)=>`<div class="tag-item">${p} <span class="tag-remove" onclick="window.removeParticipant(${i})">&times;</span></div>`).join(''); 
        };

        window.renderAuthorsList = function(l) { 
            const el = document.getElementById('authors-list');
            if(el) el.innerHTML = l.length===0 ? '<span style="color:#aaa;">Keine Verfasser</span>' : l.map((p,i)=>`<div class="tag-item">${p} <span class="tag-remove" onclick="window.removeAuthor(${i})">&times;</span></div>`).join(''); 
        };

        window.renderModalImages = function() { 
            const el = document.getElementById('modal-img-preview');
            if(el) el.innerHTML = tempImages.map((img,i)=>`<div class="img-thumb-container ${img.isLarge?'is-large':''}"><img src="${img.src}" class="img-thumb" onclick="window.openLightbox(this.src)"><div class="img-btn-remove" onclick="window.removeTempImage(${i})">&times;</div><div class="img-btn-size ${img.isLarge?'active-large':''}" onclick="window.toggleImageSize(${i})"><i class="fa-solid ${img.isLarge?'fa-compress':'fa-expand'}"></i> <span>${img.isLarge?'GROSS':'NORMAL'}</span></div></div>`).join(''); 
        };

        window.renderPointsList = function() {
            const container = document.getElementById('points-list');
            if(!container) return;
            const t = translations[currentLang];
            if(points.length===0) { container.innerHTML=`<div style="text-align:center; padding:40px; color:#9ca3af;">${t.no_points}</div>`; return; }
            const r = allReports.find(x=>x.id===currentReportId);
            const rDate = r ? r.header.date_from : new Date();
            
            container.innerHTML = points.map((p,i) => {
                const statusClass = (p.status==='open') ? window.getAgeClass(rDate) : 'resolved';
                const badge = (p.status==='open') ? `<span class="status-badge status-open">${t.status_open}</span>` : `<span class="status-badge status-resolved">${t.status_resolved}</span>`;
                const moveUp = i > 0 ? `<button class="sort-btn" onclick="event.stopPropagation(); window.movePoint(${i}, -1)"><i class="fa-solid fa-chevron-up"></i></button>` : '';
                const moveDown = i < points.length - 1 ? `<button class="sort-btn" onclick="event.stopPropagation(); window.movePoint(${i}, 1)"><i class="fa-solid fa-chevron-down"></i></button>` : '';

                return `
                <div class="point-item ${statusClass}" draggable="true" ondragstart="window.handleDragStart(event, ${i})" ondragover="window.handleDragOver(event)" ondrop="window.handleDrop(event, ${i})" ondragend="window.handleDragEnd(event)" onclick="window.openModal(${i})">
                    <div class="point-content-wrapper">
                        <div class="point-header-row">
                            <div class="point-title">
                                ${p.ticket ? `<span class="ticket-link"><i class="fa-solid fa-ticket"></i> CRM ${p.ticket}</span>` : ''}
                                ${p.title}
                            </div>
                            <div>${badge}</div>
                        </div>
                        <div class="point-desc">${(p.desc||'').substring(0,80)}...</div>
                        <div class="point-meta-row"><span><i class="fa-solid fa-user"></i> ${p.assignee||t.no_assignee}</span>${p.images&&p.images.length?`<span><i class="fa-solid fa-image"></i> ${p.images.length}</span>`:''}</div>
                    </div>
                    <div class="point-sort-column">${moveUp}${moveDown}</div>
                </div>`;
            }).join('');
        };

        window.renderStatusList = function() {
            const listOpen = document.getElementById('list-open');
            const listResolved = document.getElementById('list-resolved');
            if(!listOpen || !listResolved) return;
            
            const t = translations[currentLang];
            let htmlOpen='', htmlResolved='', cOpen=0, cRes=0;
            points.forEach((p,i) => {
                const btnText = p.status==='open' ? t.status_open : t.status_resolved;
                const btnBg = p.status==='open' ? 'var(--danger-bg)' : 'var(--success-bg)';
                const btnColor = p.status==='open' ? '#991b1b' : '#065f46';
                const imgCount = p.images&&p.images.length>0 ? `<span style="margin-left:8px; opacity:0.8;"><i class="fa-solid fa-image"></i> ${p.images.length}</span>` : '';
                const ticket = p.ticket ? `<span style="font-size:0.75rem; background:#eff6ff; color:#1d4ed8; padding:1px 6px; border-radius:4px; margin-right:6px; border:1px solid #bfdbfe; vertical-align:middle; display:inline-block;"><i class="fa-solid fa-ticket"></i> CRM ${p.ticket}</span>` : '';
                const item = `<div class="status-item-anim" style="background:white; padding:15px; margin-bottom:10px; border-radius:12px; display:flex; justify-content:space-between; align-items:center; border-left:4px solid ${p.status==='open'?'var(--danger)':'var(--success)'}; cursor:pointer; box-shadow: 0 1px 3px rgba(0,0,0,0.05);" onclick="window.openModal(${i})"><div style="flex:1"><div style="margin-bottom:2px;">${ticket}<strong style="vertical-align:middle;">${p.title}</strong></div><div style="font-size:0.8rem; color:gray; margin-top:2px;"><i class="fa-solid fa-user" style="font-size:0.7rem;"></i> ${p.assignee||t.no_assignee} ${imgCount}</div></div><button class="btn" style="width:auto; margin:0; margin-left:10px; font-size:0.75rem; padding:6px 12px; background:${btnBg}; color:${btnColor}; font-weight:700; border-radius:8px;" onclick="event.stopPropagation(); window.toggleStatus(${i})">${btnText}</button></div>`;
                if(p.status==='open') { cOpen++; htmlOpen+=item; } else { cRes++; htmlResolved+=item; }
            });
            listOpen.innerHTML=htmlOpen||`<div style="text-align:center; color:#9ca3af; font-style:italic;">${t.no_open_points}</div>`;
            listResolved.innerHTML=htmlResolved||`<div style="text-align:center; color:#9ca3af; font-style:italic;">${t.no_resolved_points}</div>`;
            document.getElementById('count-open').innerText=cOpen; document.getElementById('count-resolved').innerText=cRes;
        };

        window.renderPDFPreviewWithData = function(r) {
             if(!r) return;
             const h=r.header; const pList=r.header.participants?r.header.participants.join(', '):'-';
             const aList=r.header.authors?r.header.authors.join(', '):(r.header.author || '-');
             const t=translations[currentLang];
             const formatDate=(d)=>{if(!d)return'';const p=d.split('-');if(p.length===3)return`${p[2]}.${p[1]}.${p[0]}`;return d;};

             // Use SVG logo directly - native browser print handles SVGs perfectly
             const logoSrc = "https://cdn.gea.com/-/jssmedia/common/logos/gea-logo.svg?mw=85";

             // Apply export filter
             const filteredPoints = exportFilter === 'open' ? r.points.filter(p => p.status === 'open') : r.points;

             const html = filteredPoints.map(p => {
                 // Use base64 if available (for PDF export), fallback to src URL
                 const safeImages = (p.images||[]).map(img => {
                     const src = typeof img==='string' ? img : (img.base64 || img.src);
                     const isLarge = typeof img==='string' ? false : img.isLarge;
                     return {src, isLarge};
                 });
                 const stTxt = p.status==='open'?t.status_open:t.status_resolved;
                 const badgeStyle = p.status==='open' ? 'background:#fef2f2; color:#991b1b; border:1px solid #fecaca;' : 'background:#dcfce7; color:#065f46; border:1px solid #bbf7d0;';
                 const assHtml = p.assignee ? `<p style="font-size:0.9rem;"><strong>${t.lbl_responsible}:</strong> ${p.assignee}</p>` : '';
                 return `<div style="margin-bottom:25px; page-break-inside: avoid;"><div style="border-bottom:1px solid #ddd; padding-bottom:5px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center;"><div>${p.ticket?`<b><i class="fa-solid fa-ticket" style="color:#666; margin-right:4px;"></i> CRM ${p.ticket}</b> `:''}<span style="font-size:1.2rem; font-weight:bold; color:${p.status==='open'?'#dc2626':'#16a34a'}">${p.title}</span></div><span style="font-size:0.7rem; font-weight:700; text-transform:uppercase; padding:4px 10px; border-radius:99px; ${badgeStyle}">${stTxt}</span></div><p>${p.desc}</p>${assHtml}<div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;">${safeImages.map(img=>{ const s=img.isLarge?'width:100%; height:auto; margin-bottom:10px; border:1px solid #ddd; border-radius:4px; max-height: 250mm; object-fit: contain; page-break-inside: avoid; display: block;' : 'width:48%; height:auto; border:1px solid #ddd; border-radius:4px; max-height: 250mm; object-fit: contain; page-break-inside: avoid; display: block;'; return `<img src="${img.src}" style="${s} cursor:pointer;" onclick="window.openLightbox(this.src)">`; }).join('')}</div></div>`;
             }).join('');

             const devBuild = "DEV-20260127A";
             const previewEl = document.getElementById('pdf-preview');
             if(previewEl) previewEl.innerHTML = `<div class="pdf-header" style="display:flex; justify-content:space-between; align-items:flex-start;"><div><h1 style="margin:0;">${t.pdf_title}</h1><p style="color:#666;">${new Date().toLocaleDateString(currentLang==='de'?'de-DE':'en-US')}</p></div><img src="${logoSrc}" style="height:40px; width:126px; object-fit:contain; flex-shrink:0;"></div><div style="background:#f8fafc; padding:15px; margin-bottom:30px; border-radius:8px;"><div><strong>${t.lbl_customer}:</strong> ${h.customer}</div><div><strong>${t.lbl_date}:</strong> ${formatDate(h.date_from)} bis ${formatDate(h.date_to)}</div><div><strong>${t.lbl_author}:</strong> ${aList}</div><div><strong>${t.lbl_participants}:</strong> ${pList}</div></div>${html}<div style="margin-top:30px; text-align:right; font-size:0.55rem; color:#ccc;">${devBuild}</div>`;
        };
        
        window.renderPDFPreview = () => window.renderPDFPreviewWithData(allReports.find(x=>x.id===currentReportId));

        window.setExportFilter = function(filter) {
            exportFilter = filter;

            // Update button states
            document.getElementById('filter-all-btn').classList.toggle('active', filter === 'all');
            document.getElementById('filter-open-btn').classList.toggle('active', filter === 'open');

            // Re-render preview
            window.renderPDFPreview();
        };

        window.renderRelatedReports = function() {
            const container = document.getElementById('related-reports-list');
            const sidebar = document.getElementById('related-reports-sidebar');
            if (!container) return;

            const currentReport = allReports.find(r => r.id === currentReportId);
            if (!currentReport || !currentReport.header.customer) {
                if (sidebar) sidebar.style.display = 'none';
                return;
            }

            // Normalize customer name for matching (lowercase, trimmed)
            const currentCustomer = currentReport.header.customer.toLowerCase().trim();

            // Find other reports with the same customer (exclude current report)
            const relatedReports = allReports.filter(r => {
                if (r.id === currentReportId) return false;
                const rCustomer = (r.header.customer || '').toLowerCase().trim();
                return rCustomer === currentCustomer;
            });

            // Sort by date descending
            relatedReports.sort((a, b) => new Date(b.header.date_from) - new Date(a.header.date_from));

            // Update sidebar header with count and customer name
            const titleEl = sidebar.querySelector('.related-reports-title');
            if (titleEl) {
                titleEl.innerHTML = `
                    <i class="fa-solid fa-folder-tree"></i>
                    <span>Berichte</span>
                    <span class="related-reports-count">${relatedReports.length}</span>
                `;
            }

            // Add customer name header
            let customerHeader = sidebar.querySelector('.related-reports-customer');
            if (!customerHeader) {
                customerHeader = document.createElement('div');
                customerHeader.className = 'related-reports-customer';
                sidebar.insertBefore(customerHeader, container);
            }
            customerHeader.textContent = currentReport.header.customer;
            customerHeader.title = currentReport.header.customer;

            if (relatedReports.length === 0) {
                container.innerHTML = '<div class="no-related-reports">Keine weiteren Berichte</div>';
                return;
            }

            // Format as KW (calendar week)
            const formatKW = (d) => {
                if (!d) return '';
                const date = new Date(d);
                if (isNaN(date)) return '';
                const [week, year] = window.getWeekNumber(date);
                return `KW ${week}/${year}`;
            };

            container.innerHTML = relatedReports.map(r => {
                const openCount = (r.points || []).filter(p => p.status === 'open').length;
                const hasOpen = openCount > 0;
                const badgeClass = hasOpen ? 'has-open' : 'all-resolved';
                const badgeText = hasOpen ? `${openCount} Offen` : 'Erledigt';
                const displayId = r.readable_id ? `#${r.readable_id}` : `#${r.id.slice(-5)}`;
                const kwStr = formatKW(r.header.date_from);
                const authorsStr = r.header.authors && r.header.authors.length
                    ? r.header.authors.join(', ')
                    : (r.header.author || '-');

                return `
                    <div class="related-report-item ${hasOpen ? 'has-open-points' : ''}" onclick="window.openRelatedReport('${r.id}')">
                        <div class="related-report-header">
                            <span class="related-report-date">${kwStr}</span>
                            <span class="related-report-id">${displayId}</span>
                        </div>
                        <span class="related-report-meta"><i class="fa-solid fa-user"></i> ${authorsStr}</span>
                        <span class="related-report-badge ${badgeClass}">${badgeText}</span>
                    </div>
                `;
            }).join('');
        };

        window.openRelatedReport = function(id) {
            window.openReport(id);
            window.switchTab('export');
        };

        window.translateReport = async function() {
            // DEPRECATED / DISABLED
            window.showToast("Funktion aktuell deaktiviert.");
        };

        // --- NEW: FETCH GLOBAL CONFIG ---
        window.fetchGlobalConfig = async function() {
            try {
                // IMPORTANT: The path must match strict rules
                // artifacts/{appId}/public/data/app_config/secrets
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'app_config', 'secrets');
                const docSnap = await getDoc(docRef);
                
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    if(data.gemini_key) {
                        globalGeminiKey = data.gemini_key;
                        console.log("Global Config Loaded");
                    }
                }
            } catch(e) {
                console.warn("Could not fetch global config (maybe not set yet):", e);
            }
        };

        // --- NEW: SAVE GLOBAL API KEY ---
        window.saveGlobalApiKey = async function() {
            const key = document.getElementById('admin-api-key-input').value.trim();
            if(!key) { alert("Bitte Key eingeben"); return; }
            
            try {
                // Ensure document exists
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'app_config', 'secrets');
                await setDoc(docRef, { gemini_key: key }, { merge: true });
                globalGeminiKey = key;
                alert("Key erfolgreich in der Cloud gespeichert. Alle Nutzer haben nun Zugriff.");
                document.getElementById('admin-api-key-input').value = '';
                window.closeAdminToolsModal();
            } catch(e) {
                console.error(e);
                alert("Fehler beim Speichern: " + e.message);
            }
        };

        window.improveDescription = async function() {
            const descField = document.getElementById('p_desc');
            const titleField = document.getElementById('p_title');
            const desc = descField.value.trim();
            const title = titleField.value.trim();

            if (desc.length < 10) { window.showToast("Bitte geben Sie mehr Text zur berarbeitung ein."); return; }

            // PRIORITY: Global Cloud Key -> Local Storage Key
            const apiKey = globalGeminiKey || localStorage.getItem('moo_gemini_api_key');

            if(!apiKey) {
                alert("Kein API Key gefunden. Bitte als Admin im 'Admin Tools' Bereich einen Key fr alle hinterlegen.");
                return;
            }

            const btn = document.getElementById('btn-improve-text');
            const originalButtonHTML = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            const targetLang = aiTargetLang === 'de' ? 'German' : 'English';
            const context = "GEA FarmTechnologies Melktechnik/Ftterungstechnik";

            let userPrompt;
            if (!title) {
                // Keine berschrift vorhanden: Kurze berschrift generieren + Text korrigieren
                userPrompt = `Du bist ein technischer Redakteur fr ${context}. Fhre folgende Aufgaben aus:

1. Erstelle eine SEHR KURZE berschrift (max. 3-5 Wrter) basierend auf dem Text. Die berschrift soll prgnant den Kerninhalt erfassen.
2. Korrigiere Rechtschreibung und Grammatik im Text. Bleibe dabei MGLICHST NAH AM ORIGINAL. ndere nur echte Fehler, keine stilistischen Anpassungen.

Antworte NUR im folgenden JSON-Format (keine anderen Texte):
{"headline": "Kurze berschrift hier", "text": "Korrigierter Text hier"}

Sprache: ${targetLang}

Text: "${desc}"`;
            } else {
                // berschrift vorhanden: Nur Rechtschreibprfung fr Titel + Text korrigieren
                userPrompt = `Du bist ein technischer Redakteur fr ${context}. Fhre folgende Aufgaben aus:

1. Prfe die berschrift NUR auf Rechtschreibfehler. ndere nichts anderes, bleibe mglichst nah am Original.
2. Korrigiere Rechtschreibung und Grammatik im Text. Bleibe dabei MGLICHST NAH AM ORIGINAL. ndere nur echte Fehler, keine stilistischen Anpassungen.

Antworte NUR im folgenden JSON-Format (keine anderen Texte):
{"headline": "Korrigierte berschrift hier", "text": "Korrigierter Text hier"}

Sprache: ${targetLang}

berschrift: "${title}"
Text: "${desc}"`;
            }

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            let attempt = 0;
            let success = false;

            try {
                while(attempt < 3 && !success) {
                    try {
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                contents: [{ parts: [{ text: userPrompt }] }],
                                generationConfig: { temperature: 0.1 }
                            })
                        });

                        if (response.status === 403) {
                            throw new Error("API Key ungltig oder gesperrt.");
                        }

                        if (response.status === 429 || response.status >= 500) {
                            attempt++;
                            console.warn(`API Busy/Limit (Status ${response.status}). Retrying ${attempt}/3...`);
                            await new Promise(r => setTimeout(r, 1000 * attempt));
                            continue;
                        }

                        if(!response.ok) {
                            const errText = await response.text();
                            throw new Error(`API Error: ${response.status} ${response.statusText}`);
                        }

                        const result = await response.json();
                        if(result.candidates?.[0]?.content?.parts?.[0]?.text) {
                            let aiResponse = result.candidates[0].content.parts[0].text.trim();
                            // JSON aus der Antwort extrahieren (falls in Markdown-Block)
                            const jsonMatch = aiResponse.match(/\{[\s\S]*\}/);
                            if (jsonMatch) {
                                try {
                                    const parsed = JSON.parse(jsonMatch[0]);
                                    if (parsed.headline) {
                                        titleField.value = parsed.headline;
                                    }
                                    if (parsed.text) {
                                        descField.value = parsed.text;
                                    }
                                    window.showToast(title ? "Rechtschreibung korrigiert!" : "berschrift erstellt & Text korrigiert!");
                                    success = true;
                                } catch(parseErr) {
                                    console.error("JSON Parse Error:", parseErr);
                                    // Fallback: Nur den Text bernehmen
                                    descField.value = aiResponse;
                                    window.showToast("Text berarbeitet!");
                                    success = true;
                                }
                            } else {
                                // Kein JSON gefunden: Fallback
                                descField.value = aiResponse;
                                window.showToast("Text berarbeitet!");
                                success = true;
                            }
                        }
                    } catch(innerEx) {
                        console.warn("Attempt failed", innerEx);
                        if(attempt >= 2 || innerEx.message.includes("Key")) throw innerEx;
                        attempt++;
                        await new Promise(r => setTimeout(r, 1000));
                    }
                }
            } catch(e) {
                console.error("Final API Failure:", e);
                alert(e.message);
            }

            btn.innerHTML = originalButtonHTML;
        };

        window.renderReportList = function() {
            const t = translations[currentLang];
            const yearSelect = document.getElementById('year-filter');
            const uniqueYears = [...new Set(allReports.map(r => r.header.date_from ? r.header.date_from.substring(0,4) : ''))].filter(y => y).sort().reverse();
            const currentVal = yearSelect.value;
            yearSelect.innerHTML = `<option value="all">${t.filter_all_years}</option>`;
            uniqueYears.forEach(y => yearSelect.innerHTML += `<option value="${y}">${y}</option>`);
            if(uniqueYears.includes(filterYear)) yearSelect.value = filterYear; else if(filterYear !== 'all') yearSelect.value = 'all'; else yearSelect.value = currentVal;
            
            const searchInput = document.getElementById('search-input');
            const searchQuery = searchInput ? searchInput.value.toLowerCase().trim() : '';
            const list = document.getElementById('report-list');
            if(allReports.length === 0) { list.innerHTML = `<div style="text-align:center; padding:20px;">${t.no_points}</div>`; return; }

            let filteredReports = allReports.filter(r => {
                const rType = r.header.type || 'AMS';
                const rYear = r.header.date_from ? r.header.date_from.substring(0,4) : '';
                const matchType = (filterType === 'all') || (rType === filterType);
                const matchYear = (filterYear === 'all') || (rYear === filterYear);
                let matchSearch = true;
                if(searchQuery) {
                    const rId = (r.readable_id || r.id).toLowerCase();
                    const rCustomer = (r.header.customer || '').toLowerCase();
                    const rAuthor = (r.header.author || '').toLowerCase();
                    if(searchQuery.startsWith('von:')) {
                        matchSearch = rAuthor.includes(searchQuery.replace('von:', '').trim());
                    } else {
                        let inPoints = false;
                        if(r.points) inPoints = r.points.some(p => (p.title && p.title.toLowerCase().includes(searchQuery)) || (p.desc && p.desc.toLowerCase().includes(searchQuery)));
                        matchSearch = rId.includes(searchQuery) || rCustomer.includes(searchQuery) || inPoints;
                    }
                }
                return matchType && matchYear && matchSearch;
            });

            filteredReports.sort((a, b) => {
                if(sortMethod==='date_asc') return new Date(a.header.date_from)-new Date(b.header.date_from);
                if(sortMethod==='author') {
                    const aAuthor = (a.header.authors && a.header.authors.length) ? a.header.authors[0] : (a.header.author || '');
                    const bAuthor = (b.header.authors && b.header.authors.length) ? b.header.authors[0] : (b.header.author || '');
                    return aAuthor.localeCompare(bAuthor);
                }
                if(sortMethod==='open_points') return ((b.points||[]).filter(p=>p.status==='open').length)-((a.points||[]).filter(p=>p.status==='open').length);
                return new Date(b.header.date_from)-new Date(a.header.date_from);
            });

            list.innerHTML = filteredReports.map(r => {
                let title = r.header.customer || "Neuer Bericht";
                if(r.header.date_from) { const d = new Date(r.header.date_from); if(!isNaN(d)) { const [w,y] = window.getWeekNumber(d); title = `KW ${w} ${y} - ${r.header.customer}`; } }
                const openCount = (r.points||[]).filter(p=>p.status==='open').length;
                const total = (r.points||[]).length;
                const displayId = r.readable_id ? `#${r.readable_id}` : `#${r.id.slice(-5)}`;
                let statusClass = (total>0 && openCount===0) ? 'all-resolved' : (openCount>0 ? window.getAgeClass(r.header.date_from) : '');
                let badge = (openCount>0) ? window.getDashboardAgeBadge(r.header.date_from) : '';
                // Create styled badge for points status
                let pointsStatusBadge = '';
                if (total > 0) {
                    if (openCount > 0) {
                        pointsStatusBadge = `<span class="status-badge status-open">${openCount} ${t.status_open}</span>`;
                    } else {
                        pointsStatusBadge = `<span class="status-badge status-resolved">${t.status_resolved}</span>`;
                    }
                }
                const pointsTxt = total > 0 ? `${total} ${t.tab_points}` : t.no_points;
                // Use authors array, fallback to deprecated author field
                const authorsDisplay = (r.header.authors && r.header.authors.length) ? r.header.authors.join(', ') : (r.header.author || '-');
                return `<div class="report-list-item ${statusClass}"><div class="report-clickable-area" onclick="window.openReport('${r.id}')"><div class="report-info"><h3><span><span class="report-type-badge">${r.header.type||'AMS'}</span> ${title}</span><span class="report-id">${displayId}</span></h3><p><i class="fa-solid fa-user"></i> ${authorsDisplay}</p><p><i class="fa-solid fa-list-check"></i> <span>${pointsTxt}</span> ${pointsStatusBadge}${badge}</p></div></div><div class="report-actions"><button type="button" class="btn-action" onclick="window.exportSingleReport(event, '${r.id}')" title="Exportieren"><i class="fa-solid fa-file-export"></i></button><button type="button" class="btn-action delete" onclick="window.askDeleteReport(event, '${r.id}')" title="Lschen"><i class="fa-solid fa-trash"></i></button></div></div>`;
            }).join('');
        };

        window.saveReportToFirestore = async function(report) {
            if (!currentUser) return;
            try {
                // Public collection for shared access
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'reports', report.id), report);
            } catch(e) {
                console.error("Save failed", e);
                if(e.code === 'storage/quota-exceeded') {
                     alert("Speicher voll.");
                } else if (e.message && e.message.includes("exceeds the maximum allowed size")) {
                     alert("Fehler: Der Bericht ist zu gro (max. 1 MB). Das passiert bei zu vielen Bildern. Bitte lsche ein paar Bilder, damit gespeichert werden kann.");
                } else if(e.code === 'permission-denied') {
                     alert("Speichern fehlgeschlagen: Keine Berechtigung (Firebase Rules prfen).");
                } else {
                     alert("Fehler beim Speichern: " + e.message);
                }
            }
        };

        window.deleteReportFromFirestore = async function(id) {
            if (!currentUser) return;
            try {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'reports', id));
            } catch(e) { 
                console.error("Delete failed", e);
                alert("Lschen fehlgeschlagen: " + e.message);
            }
        };
        
        window.configurePinModal = function(title, desc, color, icon, callback) {
            document.getElementById('pin-title').innerText = title;
            document.getElementById('pin-desc').innerText = desc;
            
            const iconEl = document.getElementById('pin-icon');
            iconEl.style.color = color;
            iconEl.innerHTML = `<i class="fa-solid ${icon}"></i>`;
            
            const btn = document.getElementById('pin-confirm-btn');
            btn.style.background = color;
            
            document.getElementById('auth-pin').value = '';
            pendingPinAction = callback;
            
            document.getElementById('pin-auth-modal').style.display = 'flex';
            setTimeout(() => document.getElementById('auth-pin').focus(), 100);
        };

        window.setupRealtimeListener = function() {
            const q = collection(db, 'artifacts', appId, 'public', 'data', 'reports');
            let isFirstLoad = true;

            onSnapshot(q, (snapshot) => {
                const newReports = [];
                snapshot.forEach(doc => newReports.push(doc.data()));
                allReports = newReports;

                // UPDATE AUTOFILL NAMES (Using STRICT list now)
                window.updateNameSuggestions();

                window.renderReportList();

                // SHARED LINK MODE: Apply on first load if URL has report parameter
                if (isFirstLoad && sharedReportId) {
                    isFirstLoad = false;
                    window.applySharedLinkMode();
                    return; // Skip normal auto-restore logic
                }
                isFirstLoad = false;

                // AUTO RESTORE LOGIC - Check if we had an open report
                if (!currentReportId) {
                    const lastId = localStorage.getItem('mooMemo_lastReport');
                    if (lastId) {
                        const exists = allReports.find(r => r.id === lastId);
                        if(exists) {
                            window.openReport(lastId); // Auto-open
                        }
                    }
                }

                if (currentReportId) {
                    const r = allReports.find(x => x.id === currentReportId);
                    if (r) {
                        points = r.points;
                        if(document.getElementById('points').classList.contains('active')) window.renderPointsList();
                        if(document.getElementById('status').classList.contains('active')) window.renderStatusList();
                    } else {
                        window.goToDashboard(); window.showToast(translations[currentLang].toast_removed);
                    }
                }
            }, (error) => {
                console.error("Sync error:", error);
                if (error.code === 'permission-denied') {
                    alert("  ZUGRIFF VERWEIGERT: Bitte stelle sicher, dass in der Firebase Konsole unter 'Firestore Database' -> 'Rules' der Zugriff erlaubt ist (allow read, write: if true;).");
                }
                window.updateSyncStatus(false);
            });
        };
        
        window.setFilterType = function(type) {
            filterType = type;
            document.querySelectorAll('#filter-type-container .filter-pill').forEach(btn => btn.classList.remove('active'));
            window.renderReportList();
        };
        window.setFilterYear = function(year) { filterYear = year; window.renderReportList(); };
        window.setSortMethod = function(method) { sortMethod = method; window.renderReportList(); };

        window.openSettings = function() { document.getElementById('settings-modal').style.display = 'flex'; };
        window.closeSettings = function() { document.getElementById('settings-modal').style.display = 'none'; };
        
        window.setLanguage = function(lang) {
            currentLang = lang;
            localStorage.setItem('mooMemo_lang', lang); // PERSISTENCE
            const t = translations[lang];
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if(t[key]) {
                    if(el.children.length > 0 && el.tagName === 'BUTTON') {
                        const icon = el.querySelector('i');
                        if(icon) { el.innerHTML = ''; el.appendChild(icon); el.appendChild(document.createTextNode(' ' + t[key])); }
                        else el.innerText = t[key];
                    } else el.innerText = t[key];
                }
            });
            document.getElementById('search-input').placeholder = t.search_placeholder;
            document.querySelectorAll('.lang-btn').forEach(btn => btn.classList.remove('active'));
            const activeBtn = document.querySelector(`.lang-btn[data-lang="${lang}"]`);
            if(activeBtn) activeBtn.classList.add('active');
            window.renderReportList();
            if(document.getElementById('points').classList.contains('active')) window.renderPointsList();
            if(document.getElementById('status').classList.contains('active')) window.renderStatusList();
            window.closeSettings();
        };
        
        window.setAiTargetLang = function(lang) {
            aiTargetLang = lang;
            localStorage.setItem('mooMemo_ai_lang', lang); // PERSISTENCE
            const container = document.getElementById('ai-lang-container');
            const buttons = container.getElementsByClassName('lang-btn');
            for(let btn of buttons) {
                btn.classList.remove('active');
                if((lang === 'de' && btn.innerText === 'Deutsch') || (lang === 'en' && btn.innerText === 'English')) {
                    btn.classList.add('active');
                }
            }
        };

        window.goToDashboard = function() {
            currentReportId = null;
            points = [];
            
            // Clear memory
            localStorage.removeItem('mooMemo_lastReport');
            
            document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
            document.getElementById('dashboard').classList.add('active');
            document.getElementById('tab-navigation').style.display = 'none';
            document.getElementById('nav-back-btn').style.display = 'none';
            document.getElementById('header-logo').style.display = 'inline-block';

            window.renderReportList();
        };

        window.openReport = function(id) {
            currentReportId = id;

            // SAVE STATE for refresh
            localStorage.setItem('mooMemo_lastReport', id);

            const report = allReports.find(r => String(r.id) === String(id));
            if(!report) return;
            points = report.points || [];

            document.getElementById('h_type').value = report.header.type || 'AMS';
            document.getElementById('h_customer').value = report.header.customer || '';
            document.getElementById('h_date_from').value = report.header.date_from || '';
            document.getElementById('h_date_to').value = report.header.date_to || '';
            // AUTHOR HANDLING
            let auths = report.header.authors || [];
            if (!auths.length && report.header.author) auths = [report.header.author];
            window.renderAuthorsList(auths);

            window.renderParticipantsList(report.header.participants || []);

            document.getElementById('dashboard').classList.remove('active');
            document.getElementById('tab-navigation').style.display = 'flex';
            document.getElementById('nav-back-btn').style.display = 'inline-block';
            document.getElementById('header-logo').style.display = 'none';

            // Check if Basisdaten are complete - if so, skip to points
            const h = report.header;
            const hasCustomer = h.customer && h.customer.trim().length > 0;
            const hasDate = h.date_from && h.date_from.trim().length > 0;
            const hasAuthor = (h.authors && h.authors.length > 0) || (h.author && h.author.trim().length > 0);
            const isBasisdatenComplete = hasCustomer && hasDate && hasAuthor;

            window.switchTab(isBasisdatenComplete ? 'points' : 'header');
        };
        
        window.createNewReport = function() {
            const readableId = Math.floor(10000 + Math.random() * 90000).toString();
            const r = { 
                id: Date.now().toString(), 
                readable_id: readableId, 
                created_at: Date.now(), 
                header: { type: 'AMS', customer: '', date_from: new Date().toISOString().split('T')[0], date_to: '', authors: [], participants: [] }, 
                points: [] 
            };
            window.saveReportToFirestore(r).then(() => window.openReport(r.id));
        };

        window.updateCurrentReportHeader = function() {
            if(!currentReportId) return;
            if (headerUpdateTimeout) clearTimeout(headerUpdateTimeout);
            headerUpdateTimeout = setTimeout(() => {
                const report = allReports.find(r => r.id === currentReportId);
                if(report) {
                    report.header.type = document.getElementById('h_type').value;
                    report.header.customer = document.getElementById('h_customer').value;
                    report.header.date_from = document.getElementById('h_date_from').value;
                    report.header.date_to = document.getElementById('h_date_to').value;
                    // report.header.author is deprecated, using header.authors array now (updated via add/remove funcs)
                    window.saveReportToFirestore(report);
                }
            }, 500);
        };
        
        window.switchTab = function(id) {
            document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            const map = {'header':0, 'points':1, 'status':2, 'export':3};
            document.querySelectorAll('.nav-item')[map[id]].classList.add('active');
            document.getElementById('fab-btn').style.display = (id==='points') ? 'flex' : 'none';
            if(id==='points') window.renderPointsList();
            if(id==='status') window.renderStatusList();
            if(id==='export') {
                window.renderPDFPreview();
                window.updateShareLink();
                window.renderRelatedReports();
            }
        };

        window.savePoint = function() {
             const idx = parseInt(document.getElementById('edit-index').value);
             const p = {
                ticket: document.getElementById('p_ticket').value,
                title: document.getElementById('p_title').value,
                desc: document.getElementById('p_desc').value,
                assignee: document.getElementById('p_assignee').value,
                status: document.getElementById('p_status').value,
                images: tempImages 
             };
             if(idx === -1) points.push(p); else points[idx] = p;
             const r = allReports.find(x => x.id === currentReportId);
             if(r) { r.points = points; window.saveReportToFirestore(r).then(() => window.showToast(translations[currentLang].toast_saved)); }
             window.closeModal(); window.renderPointsList(); window.renderStatusList();
        };
        
        window.askDeleteReport = function(e, id) {
            if(e) e.stopPropagation();
            window.configurePinModal(translations[currentLang].delete_report_title, translations[currentLang].delete_report_msg, 'var(--danger)', 'fa-triangle-exclamation', () => window.deleteReportFromFirestore(id));
        };
        
        window.askAdminTools = function() {
             window.configurePinModal(translations[currentLang].admin_title, translations[currentLang].admin_desc, 'var(--primary)', 'fa-user-shield', () => document.getElementById('admin-tools-modal').style.display = 'flex');
        };

        window.exportSingleReport = function(e, id) {
            if(e) e.stopPropagation();
            const r = allReports.find(x => x.id === id);
            if(!r) return;
            const a = document.createElement('a');
            a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(r));
            a.download = `bericht_${r.id}.json`;
            document.body.appendChild(a); a.click(); a.remove();
        };

        window.askExportBackup = function() {
             window.configurePinModal(translations[currentLang].backup_save, translations[currentLang].admin_desc, 'var(--primary)', 'fa-file-export', window.performExport);
        };

        window.askImportBackup = function() {
            window.configurePinModal(translations[currentLang].backup_load, translations[currentLang].admin_desc, 'var(--primary)', 'fa-file-export', () => document.getElementById('import-input').click());
        };

        window.closeAdminToolsModal = function() {
            document.getElementById('admin-tools-modal').style.display = 'none';
        };

        window.closePinModal = function() {
            document.getElementById('pin-auth-modal').style.display = 'none';
            pendingPinAction = null;
        };

        window.closeDeleteModal = window.closePinModal;

        window.verifyPin = function() {
            const pin = document.getElementById('auth-pin').value;
            if (pin === '0000') {
                if (pendingPinAction) pendingPinAction();
                window.closePinModal();
            } else {
                alert("Falsch");
                document.getElementById('auth-pin').value = '';
            }
        };
        
        // --- NEW: AUTOFILL LOGIC (Only on input > 0 chars) ---
        // Also checks if input matches an option exactly to auto-add
        window.handleInputAutofill = function(input, listId, addCallback) {
             const val = input.value;
             if(val.length > 0) {
                 input.setAttribute('list', listId);
             } else {
                 input.removeAttribute('list');
             }

             // Auto-Add if match found in list
             if (addCallback) {
                 const opts = document.getElementById(listId).options;
                 for (let i = 0; i < opts.length; i++) {
                     if (opts[i].value === val) {
                         addCallback(); // Call the add function immediately
                         return;
                     }
                 }
             }
        };

        window.updateNameSuggestions = function() {
            // STRICT MODE: Only use CONST_NAMES
            const names = CONST_NAMES.slice().sort();
            const assignees = [...CONST_NAMES, ...CONST_DEPARTMENTS].sort();
            
            // Populate "list-names" (For Authors/Participants)
            const listNames = document.getElementById('list-names');
            if(listNames) {
                listNames.innerHTML = names.map(n => `<option value="${n}">`).join('');
            }

            // Populate "list-assignees" (For Responsible Person)
            const listAssignees = document.getElementById('list-assignees');
            if(listAssignees) {
                listAssignees.innerHTML = assignees.map(n => `<option value="${n}">`).join('');
            }
        };

        window.addParticipant = function() {
            const input = document.getElementById('new_participant');
            const name = input.value.trim();
            if(!name || !currentReportId) return;
            const r = allReports.find(x => x.id === currentReportId);
            if(!r.header.participants) r.header.participants = [];
            
            // Prevent duplicates
            if(!r.header.participants.includes(name)) {
                r.header.participants.push(name);
                window.saveReportToFirestore(r);
            }
            
            input.value = '';
            input.removeAttribute('list'); // Hide suggestions after adding
            window.renderParticipantsList(r.header.participants);
        };

        window.removeParticipant = function(i) {
            const r = allReports.find(x => x.id === currentReportId);
            r.header.participants.splice(i, 1);
            window.saveReportToFirestore(r);
            window.renderParticipantsList(r.header.participants);
        };
        
        window.addAuthor = function() {
            const input = document.getElementById('new_author');
            const name = input.value.trim();
            if(!name || !currentReportId) return;
            const r = allReports.find(x => x.id === currentReportId);

            // Migration check
            if(!r.header.authors) r.header.authors = [];
            if(r.header.authors.length === 0 && r.header.author) r.header.authors.push(r.header.author);

            // Prevent duplicates
            if(!r.header.authors.includes(name)) {
                r.header.authors.push(name);
                // Sync deprecated author field with first author
                r.header.author = r.header.authors[0] || '';
                window.saveReportToFirestore(r);
            }

            input.value = '';
            input.removeAttribute('list'); // Hide suggestions
            window.renderAuthorsList(r.header.authors);
        };

        window.removeAuthor = function(i) {
            const r = allReports.find(x => x.id === currentReportId);
            if(r.header.authors) {
                r.header.authors.splice(i, 1);
                // Sync deprecated author field with first author
                r.header.author = r.header.authors[0] || '';
                window.saveReportToFirestore(r);
                window.renderAuthorsList(r.header.authors);
            }
        };
        
        window.closeModal = function() { document.getElementById('modal').style.display = 'none'; };

        window.openModal = function(index = -1) {
            document.getElementById('edit-index').value = index;
            tempImages = [];
            if(index > -1) {
                const p = points[index];
                document.getElementById('p_ticket').value = p.ticket || "";
                document.getElementById('p_title').value = p.title || "";
                document.getElementById('p_desc').value = p.desc || "";
                document.getElementById('p_assignee').value = p.assignee || "";
                document.getElementById('p_status').value = p.status || "open";
                
                tempImages = (p.images || []).map(img => {
                    if (typeof img === 'string') {
                        return { src: img, isLarge: false };
                    }
                    return img;
                });
            } else {
                document.getElementById('p_ticket').value = "";
                document.getElementById('p_title').value = "";
                document.getElementById('p_desc').value = "";
                document.getElementById('p_assignee').value = "";
                document.getElementById('p_status').value = "open";
            }
            window.renderModalImages();
            document.getElementById('modal').style.display = 'flex';
        };
        
        window.toggleImageSize = function(i) {
            if(tempImages[i]) {
                tempImages[i].isLarge = !tempImages[i].isLarge;
                window.renderModalImages();
            }
        };

        window.removeTempImage = function(i) {
            tempImages.splice(i, 1);
            window.renderModalImages();
        };

        window.openLightbox = function(src) {
            const el = document.getElementById('img-lightbox');
            document.getElementById('lightbox-img').src = src;
            el.style.display = 'flex';
        };
        window.closeLightbox = function() {
            document.getElementById('img-lightbox').style.display = 'none';
        };
        
        window.askDeletePoint = function() {
            document.getElementById('delete-point-confirm-modal').style.display = 'flex';
        };

        window.closeDeletePointModal = function() {
            document.getElementById('delete-point-confirm-modal').style.display = 'none';
        };

        window.executeDeletePoint = function() {
             const idx = parseInt(document.getElementById('edit-index').value);
             if(idx > -1) {
                 points.splice(idx, 1);
                 const r = allReports.find(x => x.id === currentReportId);
                 if(r) { r.points = points; window.saveReportToFirestore(r).then(() => window.showToast(translations[currentLang].toast_deleted)); }
                 window.closeModal(); window.renderPointsList(); window.renderStatusList();
             }
             window.closeDeletePointModal();
        };

        window.toggleFullScreen = function() {
            if(!document.fullscreenElement) document.documentElement.requestFullscreen().catch(e=>{});
            else if(document.exitFullscreen) document.exitFullscreen().catch(e=>{});
        };

        window.handleDragStart = function(e, i) { draggedItemIndex = i; e.dataTransfer.effectAllowed = 'move'; e.dataTransfer.setData('text/plain', i); e.target.classList.add('dragging'); setTimeout(() => e.target.style.opacity = '0.5', 0); };
        window.handleDragOver = function(e) { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; return false; };
        window.handleDragEnd = function(e) { e.target.classList.remove('dragging'); e.target.style.opacity = '1'; draggedItemIndex = null; };
        window.handleDrop = function(e, newIndex) {
            e.stopPropagation();
            if (draggedItemIndex !== null && draggedItemIndex !== newIndex) {
                const item = points[draggedItemIndex];
                points.splice(draggedItemIndex, 1);
                points.splice(newIndex, 0, item);
                const r = allReports.find(x => x.id === currentReportId);
                if(r) { r.points = points; window.saveReportToFirestore(r); }
                window.renderPointsList();
            }
            return false;
        };
        window.movePoint = function(index, direction) {
            const newIndex = index + direction;
            if (newIndex >= 0 && newIndex < points.length) {
                const item = points[index];
                points.splice(index, 1);
                points.splice(newIndex, 0, item);
                const r = allReports.find(x => x.id === currentReportId);
                if(r) { r.points = points; window.saveReportToFirestore(r); }
                window.renderPointsList();
            }
        };
        
        window.performExport = function() { 
            const a=document.createElement('a'); 
            a.href="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(allReports)); 
            a.download=`backup_${new Date().toISOString().slice(0,10)}.json`; 
            document.body.appendChild(a); a.click(); a.remove(); 
        };

        window.importBackup = function(input) { 
            const f=input.files[0]; if(!f)return; 
            const r=new FileReader(); 
            r.onload=e=>{ try { const d=JSON.parse(e.target.result); if(Array.isArray(d)) { if(confirm('OK=berschreiben, Abbrechen=Anfgen')) d.forEach(x=>window.saveReportToFirestore(x)); else d.forEach(x=>{ if(!allReports.find(y=>y.id===x.id))window.saveReportToFirestore(x); }); alert("Import verarbeitet."); } else if(d.id) { window.saveReportToFirestore(d); alert("Importiert."); } } catch(err){alert("Fehler");} }; 
            r.readAsText(f); input.value=''; 
        };
        
        // --- PRINT REPORT (Native Browser Print for better quality) ---
        window.printReport = function() {
            // Re-render preview fresh
            window.renderPDFPreview();
            // Small delay to ensure images are loaded, then print
            setTimeout(() => {
                window.print();
            }, 100);
        };

        // --- SHARE LINK FUNCTIONS ---
        window.getShareLink = function(tab) {
            if (!currentReportId) return '';
            const baseUrl = window.location.origin + window.location.pathname;
            let url = `${baseUrl}?report=${currentReportId}`;
            if (tab) url += `&tab=${tab}`;
            return url;
        };

        window.copyShareLink = function(tab) {
            const link = window.getShareLink(tab || 'export');
            navigator.clipboard.writeText(link).then(() => {
                window.showToast(translations[currentLang].toast_copied);
                // Open shared view in new tab
                window.open(link, '_blank');
                const btn = document.getElementById('share-link-btn');
                if (btn) {
                    btn.classList.add('copied');
                    btn.innerHTML = '<i class="fa-solid fa-check"></i> Kopiert!';
                    setTimeout(() => {
                        btn.classList.remove('copied');
                        btn.innerHTML = `<i class="fa-solid fa-copy"></i> ${translations[currentLang].share_title}`;
                    }, 2000);
                }
            }).catch(() => {
                // Fallback for older browsers
                const link = window.getShareLink(tab || 'export');
                window.open(link, '_blank');
                window.showToast(translations[currentLang].toast_copied);
            });
        };

        window.updateShareLink = function() {
            // Share link is generated on-demand when button is clicked
        };

        // --- URL PARAMETER PARSING ---
        window.parseUrlParams = function() {
            const params = new URLSearchParams(window.location.search);
            const reportId = params.get('report');
            const tab = params.get('tab');

            if (reportId) {
                sharedReportId = reportId;
                sharedTab = tab || 'export';
                isReadOnly = true; // Shared links are read-only by default
            }
        };

        window.applySharedLinkMode = function() {
            if (!sharedReportId) return;

            // Find the report
            const report = allReports.find(r => String(r.id) === String(sharedReportId));
            if (!report) {
                console.warn('Shared report not found:', sharedReportId);
                // Show error message
                document.body.innerHTML = `
                    <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100vh; text-align:center; padding:20px;">
                        <i class="fa-solid fa-file-circle-question" style="font-size:4rem; color:#cbd5e1; margin-bottom:20px;"></i>
                        <h2 style="color:#1f2937; margin-bottom:10px;">Bericht nicht gefunden</h2>
                        <p style="color:#64748b; margin-bottom:20px;">Der angeforderte Bericht existiert nicht oder wurde gelscht.</p>
                        <a href="?" style="color:var(--primary); font-weight:600;">Zur App</a>
                    </div>
                `;
                return;
            }

            // ACTIVATE SHARED MODE
            document.body.classList.add('shared-mode');

            // Update shared header with report info
            const h = report.header;
            const formatDate = (d) => { if(!d) return ''; const p = d.split('-'); return p.length === 3 ? `${p[2]}.${p[1]}.${p[0]}` : d; };
            const titleEl = document.getElementById('shared-report-title');
            const subtitleEl = document.getElementById('shared-report-subtitle');

            if (titleEl) {
                titleEl.textContent = h.customer || 'Besuchsbericht';
            }
            if (subtitleEl) {
                let subtitle = '';
                if (h.date_from) subtitle += formatDate(h.date_from);
                if (h.date_to && h.date_to !== h.date_from) subtitle += ' - ' + formatDate(h.date_to);
                if (h.authors && h.authors.length) subtitle += ' | ' + h.authors.join(', ');
                subtitleEl.textContent = subtitle || 'Geteilter Bericht';
            }

            // Show open points count
            const openCount = (report.points || []).filter(p => p.status === 'open').length;
            const openBadge = document.getElementById('shared-open-badge');
            const openCountEl = document.getElementById('shared-open-count');
            if (openBadge && openCountEl) {
                openCountEl.textContent = openCount;
                if (openCount > 0) {
                    openBadge.style.display = 'flex';
                    openBadge.style.background = 'rgba(239, 68, 68, 0.3)';
                    openBadge.style.border = '1px solid rgba(239, 68, 68, 0.5)';
                }
            }

            // Set back link to open app with this report's status tab
            const backLink = document.getElementById('shared-back-link');
            if (backLink) {
                // Store report ID to open status tab when clicked
                backLink.href = '#';
                backLink.onclick = function(e) {
                    e.preventDefault();
                    window.openAppWithStatus(sharedReportId);
                };
            }

            // Open the report and render export
            currentReportId = sharedReportId;
            points = report.points || [];

            // Render PDF preview directly
            window.renderPDFPreviewWithData(report);

            // Render related reports in sidebar
            window.renderRelatedReports();

            // Make export section visible
            document.getElementById('export').classList.add('active');
        };

        window.openAppWithStatus = function(reportId) {
            // Exit shared mode and open the report's status tab
            document.body.classList.remove('shared-mode');
            isReadOnly = false;
            sharedReportId = null;

            // Clear URL parameters
            history.replaceState(null, '', window.location.pathname);

            // Open report and switch to status tab
            window.openReport(reportId);
            window.switchTab('status');
        };
        
        window.executeDelete = function() {}; // Stub
        
        window.toggleStatus = function(i) {
            points[i].status = points[i].status==='open' ? 'resolved' : 'open'; 
            const r = allReports.find(x=>x.id===currentReportId); 
            if(r) window.saveReportToFirestore(r); 
            setTimeout(()=>{window.renderStatusList();window.renderPointsList();},10); 
        };
        
        window.listen = function(id) {
            if(!('webkitSpeechRecognition' in window)) return alert('Browser nicht untersttzt');
            const r = new webkitSpeechRecognition();
            r.lang = currentLang === 'de' ? "de-DE" : "en-US";
            const btn = document.querySelector(`button[onclick*="${id}"]`);
            btn.classList.add('listening');
            r.start();
            r.onresult = e => { 
                const txt = e.results[0][0].transcript;
                const field = document.getElementById(id);
                field.value += " " + txt; 
                btn.classList.remove('listening'); 
                if(id.startsWith('h_')) window.updateCurrentReportHeader();
            };
            r.onerror = () => btn.classList.remove('listening');
            r.onend = () => btn.classList.remove('listening');
        };
        
        // --- NEW FILE UPLOAD HANDLER ---
        
        window.processFiles = async function(files) {
            if(!files || !files.length) return;

            document.getElementById('img-spinner').style.display = 'inline-block';

            for (let i = 0; i < files.length; i++) {
                const file = files[i];

                // 1. Resize/Compress using Canvas - return both blob and base64
                try {
                    const { blob: processedBlob, base64 } = await new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = e => {
                            const img = new Image();
                            img.onload = () => {
                                const cvs = document.createElement('canvas');
                                let w = img.width, h = img.height;
                                // 2K Resolution
                                if(w > 2048) { h *= 2048/w; w = 2048; }
                                cvs.width = w; cvs.height = h;
                                const ctx = cvs.getContext('2d');
                                ctx.drawImage(img, 0, 0, w, h);

                                // Get base64 data URL for PDF export
                                const base64DataUrl = cvs.toDataURL('image/jpeg', 0.8);

                                cvs.toBlob(blob => {
                                    if (blob) resolve({ blob, base64: base64DataUrl });
                                    else reject(new Error("Canvas to Blob failed"));
                                }, 'image/jpeg', 0.8);
                            };
                            img.onerror = reject;
                            img.src = e.target.result;
                        };
                        reader.onerror = reject;
                        reader.readAsDataURL(file);
                    });

                    // 2. Upload to Firebase Storage
                    const reportId = currentReportId || 'temp_uploads';
                    const path = `images/${reportId}/${Date.now()}_${Math.random().toString(36).substr(2, 9)}.jpg`;
                    const storageRef = ref(storage, path);

                    await uploadBytes(storageRef, processedBlob);
                    const downloadURL = await getDownloadURL(storageRef);

                    // 3. Add to local state with both URL and base64 for PDF
                    tempImages.push({
                        src: downloadURL,
                        base64: base64,
                        isLarge: false
                    });
                } catch (error) {
                    console.error("Upload failed", error);
                    alert("Upload fehlgeschlagen: " + error.message);
                }
            }

            document.getElementById('img-spinner').style.display = 'none';
            window.renderModalImages();
        };

        window.handleImageUpload = function() {
            window.processFiles(document.getElementById('p_images').files);
        };

        // --- INFO & SETTINGS LOGIC ---
        window.toggleInfoSection = function() {
            const content = document.getElementById('info-content');
            const icon = document.getElementById('info-chevron');
            if (content.classList.contains('open')) {
                content.classList.remove('open');
                icon.className = "fa-solid fa-chevron-down";
            } else {
                content.classList.add('open');
                icon.className = "fa-solid fa-chevron-up";
            }
        };

        window.openChangelog = function() {
            const container = document.getElementById('changelog-container');
            let html = '';
            CHANGELOG.forEach(entry => {
                html += `
                    <div class="cl-item">
                        <div class="cl-ver">
                            <span>v${entry.ver}</span>
                            <span class="cl-date">${entry.date}</span>
                        </div>
                        <ul class="cl-changes">
                            ${entry.changes.map(c => `<li>${c}</li>`).join('')}
                        </ul>
                    </div>
                `;
            });
            container.innerHTML = html;
            document.getElementById('changelog-modal').style.display = 'flex';
        };

        window.checkVersion = function() {
            const storedVer = localStorage.getItem('mooMemo_version');
            if (!storedVer || storedVer !== APP_VERSION) {
                // New version detected!
                localStorage.setItem('mooMemo_version', APP_VERSION);
                window.openChangelog();
            }
        };

        // --- STARTUP LOGIC ---
        // Parse URL parameters immediately at startup
        window.parseUrlParams();

        // Only run after everything is defined
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                window.updateSyncStatus(true);
                // NEW: FETCH GLOBAL CONFIG & PERSISTENT SETTINGS

                // Load Settings
                const savedLang = localStorage.getItem('mooMemo_lang');
                if(savedLang) window.setLanguage(savedLang);

                const savedAiLang = localStorage.getItem('mooMemo_ai_lang');
                if(savedAiLang) window.setAiTargetLang(savedAiLang);

                // Check Version for Changelog (skip if viewing shared link)
                if (!sharedReportId) {
                    window.checkVersion();
                }

                // Fetch Key & Listen
                window.fetchGlobalConfig().then(() => {
                    window.setupRealtimeListener();
                });
            } else {
                window.updateSyncStatus(false);
                window.initAuth();
            }
        });
    </script>
    <div class="img-lightbox-overlay" id="img-lightbox" onclick="window.closeLightbox()">
        <div class="lightbox-close" onclick="window.closeLightbox()">&times;</div>
        <img id="lightbox-img" src="" alt="Bild Vorschau">
    </div>
</body>
</html>
