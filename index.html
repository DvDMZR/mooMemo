<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#003366">
    <title>mooMemo (Cloud)</title>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        :root {
            --primary: #003366; 
            --secondary: #64748b; 
            --success: #10b981; 
            --success-bg: #d1fae5;
            --danger: #ef4444; 
            --danger-bg: #fee2e2;
            
            --status-fresh: #3b82f6; 
            --status-fresh-bg: #dbeafe;
            --status-warning: #f59e0b; 
            --status-warning-bg: #fff7ed; 
            --status-critical: #b91c1c; 
            --status-critical-bg: #fef2f2;

            --bg: #f3f4f6; 
            --card-bg: #ffffff; 
            --border-color: #e5e7eb;
            --text-main: #1f2937;
            --text-sub: #6b7280;
        }

        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            margin: 0;
            padding-bottom: 90px;
            color: var(--text-main);
            -webkit-tap-highlight-color: transparent;
            line-height: 1.5;
        }

        /* --- HEADER --- */
        .app-logo-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 12px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            position: sticky;
            top: 0;
            z-index: 110;
            height: 60px;
            box-sizing: border-box;
        }
        
        .app-logo-img { height: 32px; width: auto; }
        .header-title { font-weight: 700; font-size: 1.1rem; color: var(--primary); margin-left: 15px; letter-spacing: -0.01em; }
        .header-controls { display: flex; gap: 10px; align-items: center; }

        .back-btn {
            background: transparent; border: none; font-size: 0.95rem; color: var(--primary); cursor: pointer; display: none; font-weight: 600;
            padding: 8px 12px; border-radius: 8px; transition: background 0.2s; display: flex; align-items: center; gap: 6px;
        }
        .back-btn:active { background-color: var(--primary-light); }

        .icon-btn { background: transparent; border: none; color: var(--secondary); cursor: pointer; font-size: 1.1rem; padding: 8px; border-radius: 50%; transition: color 0.2s, background 0.2s; }
        .icon-btn:hover { color: var(--primary); background: #f1f5f9; }

        /* --- TABS --- */
        .nav-header {
            background: var(--card-bg); position: sticky; top: 60px; z-index: 100;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); display: none; justify-content: space-around;
            padding: 0 10px; border-bottom: 1px solid var(--border-color);
        }

        .nav-item {
            flex: 1; text-align: center; padding: 12px 5px; cursor: pointer;
            border-bottom: 2px solid transparent; color: var(--secondary); font-weight: 500; font-size: 0.8rem;
            transition: all 0.2s; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px;
        }
        .nav-item:hover { color: var(--primary); }
        .nav-item.active { border-bottom-color: var(--primary); color: var(--primary); }
        .nav-item i { font-size: 1.1rem; }

        /* --- SECTIONS --- */
        .section { display: none; width: 100%; max-width: 800px; margin: 20px auto; padding: 0 15px; box-sizing: border-box; }
        .section.active { display: block; animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1); }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .status-item-anim { animation: slideIn 0.3s ease-out forwards; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        h2 { font-size: 1.25rem; font-weight: 700; color: var(--text-main); margin-bottom: 1.5rem; display: flex; align-items: center; gap: 10px; }
        h2 i { color: var(--primary); }

        #dashboard { padding-top: 10px; }
        
        .filter-container { background: white; padding: 10px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); display: flex; flex-wrap: wrap; gap: 10px; align-items: center; justify-content: space-between; }
        
        /* SEARCH BOX */
        .search-container { width: 100%; margin-bottom: 10px; }
        .search-input { width: 100%; padding: 10px 14px; border: 1px solid var(--border-color); border-radius: 10px; font-size: 1rem; background: #f9fafb url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="%2364748b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>') no-repeat 10px center; padding-left: 36px; transition: all 0.2s; }
        .search-input:focus { outline: none; border-color: var(--primary); background-color: #fff; box-shadow: 0 0 0 3px rgba(0, 51, 102, 0.1); }

        .filter-tabs { display: flex; background: #f1f5f9; padding: 4px; border-radius: 8px; gap: 4px; }
        .filter-pill { border: none; background: transparent; padding: 6px 12px; font-size: 0.85rem; font-weight: 600; color: var(--text-sub); cursor: pointer; border-radius: 6px; transition: all 0.2s; }
        .filter-pill.active { background: white; color: var(--primary); box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .filter-control-group { display: flex; gap: 10px; align-items: center; }
        .year-select, .sort-select { padding: 6px 10px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 0.85rem; color: var(--text-main); background: white; min-width: 100px; }

        .report-list-item { background: white; border-radius: 12px; padding: 0; margin-bottom: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.1), 0 1px 2px rgba(0,0,0,0.06); display: flex; justify-content: space-between; align-items: stretch; border-left: 4px solid var(--secondary); transition: transform 0.2s, box-shadow 0.2s; overflow: hidden; position: relative; }
        .report-list-item:hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06); }
        .report-list-item.age-fresh { border-left-color: var(--status-fresh); }
        .report-list-item.age-warning { border-left-color: var(--status-warning); background-color: var(--status-warning-bg); }
        .report-list-item.age-critical { border-left-color: var(--status-critical); background-color: var(--status-critical-bg); }
        .report-list-item.all-resolved { border-left-color: var(--success); }
        
        .report-clickable-area { flex-grow: 1; padding: 16px; cursor: pointer; background: transparent; }
        .report-clickable-area:active { background-color: rgba(0,0,0,0.02); }
        
        .report-info h3 { margin: 0 0 6px 0; font-size: 1.05rem; color: var(--text-main); font-weight: 600; display: flex; justify-content: space-between; align-items: center; }
        .report-id { font-size: 0.75rem; font-weight: normal; color: var(--text-sub); background: #f1f5f9; padding: 2px 6px; border-radius: 4px; margin-left: 8px; }

        .report-info p { margin: 0; color: var(--text-sub); font-size: 0.9rem; margin-bottom: 4px; display: flex; align-items: center; gap: 6px; flex-wrap: wrap; }
        .report-info i { width: 16px; text-align: center; }
        
        .report-type-badge { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; font-weight: 700; background: #e2e8f0; color: #475569; margin-right: 6px; vertical-align: middle; }
        .report-age-badge { display: inline-block; font-size: 0.75rem; font-weight: 700; padding: 1px 6px; border-radius: 4px; margin-top: 0; white-space: nowrap; }
        .age-badge-warning { color: #92400e; background: rgba(245, 158, 11, 0.15); border: 1px solid rgba(245, 158, 11, 0.3); }
        .age-badge-critical { color: #7f1d1d; background: rgba(185, 28, 28, 0.1); border: 1px solid rgba(185, 28, 28, 0.3); }

        .report-actions { display: flex; align-items: center; justify-content: center; border-left: 1px solid var(--border-color); background: rgba(255,255,255,0.5); }
        
        .btn-action { background: transparent; border: none; width: 44px; height: 100%; font-size: 1.1rem; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; z-index: 50; color: var(--secondary); }
        .btn-action:hover { background-color: #e2e8f0; color: var(--primary); }
        .btn-action.delete:hover { background-color: var(--danger-bg); color: var(--danger); }

        .card { background: var(--card-bg); border-radius: 16px; padding: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 24px; border: 1px solid rgba(0,0,0,0.05); }

        label { display: block; font-weight: 600; margin-bottom: 8px; color: #374151; font-size: 0.95rem; }
        
        input, textarea, select { width: 100%; padding: 12px 14px; border: 1px solid #d1d5db; border-radius: 10px; font-size: 16px; box-sizing: border-box; transition: border-color 0.2s, box-shadow 0.2s; background: #f9fafb; color: #111827; }
        input:focus, textarea:focus, select:focus { outline: none; border-color: var(--primary); background: #fff; box-shadow: 0 0 0 3px rgba(0, 51, 102, 0.1); }

        .input-group { position: relative; }
        .mic-btn { position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: none; border: none; color: #9ca3af; cursor: pointer; font-size: 1.2rem; padding: 8px; z-index: 10; transition: color 0.2s; }
        .mic-btn:hover { color: var(--primary); }
        .mic-btn.listening { color: var(--danger); animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { transform: translateY(-50%) scale(1); } 50% { transform: translateY(-50%) scale(1.1); } 100% { transform: translateY(-50%) scale(1); } }
        
        .ai-btn { background: #4f46e5; color: white; border: none; padding: 8px 12px; border-radius: 8px; font-weight: 600; font-size: 0.85rem; cursor: pointer; transition: background-color 0.2s, transform 0.1s; margin-top: 10px; width: auto; display: inline-flex; align-items: center; gap: 8px; }
        .ai-btn:hover { background: #4338ca; }

        .participant-list { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px; }
        .participant-tag { background: var(--primary-light); color: var(--primary); padding: 6px 12px; border-radius: 20px; font-size: 0.9rem; font-weight: 500; display: flex; align-items: center; gap: 8px; }
        .participant-remove { cursor: pointer; font-weight: bold; font-size: 1.1rem; opacity: 0.6; }

        /* POINT ITEM STYLE - Reverted to spacious but with side arrows */
        .point-item { 
            background: white; border-radius: 12px; 
            padding: 16px; 
            margin-bottom: 16px; 
            border-left: 4px solid var(--secondary); 
            cursor: grab;
            transition: transform 0.2s, box-shadow 0.2s; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); 
            position: relative;
            display: flex; 
            align-items: flex-start;
        }
        .point-item:active { cursor: grabbing; }
        .point-item.dragging { opacity: 0.5; background: #f9fafb; border: 2px dashed var(--primary); }
        
        /* CONTENT PART (Left) */
        .point-content-wrapper { flex-grow: 1; }
        
        /* ACTIONS PART (Right) */
        .point-sort-column {
            display: flex;
            flex-direction: column;
            gap: 4px;
            margin-left: 12px;
            min-width: 24px;
            align-items: center;
            justify-content: flex-start;
            padding-top: 4px;
        }

        .sort-btn {
            background: #f1f5f9;
            border: none;
            color: var(--secondary);
            cursor: pointer;
            padding: 0;
            border-radius: 4px;
            font-size: 0.75rem;
            transition: all 0.1s;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 28px;
            width: 28px;
        }
        .sort-btn:hover { background: #e2e8f0; color: var(--primary); }

        .point-item:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .point-item.resolved { border-left-color: var(--success); }
        .point-item.age-fresh { border-left-color: var(--status-fresh); }
        .point-item.age-warning { border-left-color: var(--status-warning); }
        .point-item.age-critical { border-left-color: var(--status-critical); }
        
        /* Original Header Styles */
        .point-header-row { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
        .point-title { font-weight: 600; font-size: 1.1rem; color: #111827; }
        
        .point-meta-row { font-size: 0.85rem; color: var(--text-sub); display: flex; align-items: center; gap: 12px; margin-top: 8px; flex-wrap: wrap; }
        .point-desc { color: #4b5563; margin-bottom: 8px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

        .status-badge { padding: 4px 10px; border-radius: 99px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; display: inline-block; white-space: nowrap; }
        .status-resolved { background: var(--success-bg); color: #065f46; }
        .badge-fresh { background: var(--status-fresh-bg); color: #1e40af; }
        .badge-warning { background: #fef3c7; color: #b45309; border: 1px solid #fcd34d; }
        .badge-critical { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }

        .ticket-link { color: var(--primary); text-decoration: none; font-weight: 600; background: var(--primary-light); padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; display: inline-block; margin-right: 8px; margin-bottom: 4px; }

        .img-grid { display: flex; gap: 20px; flex-wrap: wrap; margin-top: 15px; } 
        
        .img-thumb-container { position: relative; display: inline-block; transition: transform 0.1s; }
        .img-thumb { width: 80px; height: 80px; object-fit: cover; border-radius: 8px; border: 2px solid var(--border-color); box-shadow: 0 2px 4px rgba(0,0,0,0.05); display: block; }
        .img-thumb-container.is-large .img-thumb { border-color: var(--success); box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2); }
        
        .img-btn-remove { position: absolute; top: -8px; right: -8px; background: #ef4444; color: white; border-radius: 50%; width: 22px; height: 22px; text-align: center; line-height: 22px; font-size: 14px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.2); z-index: 10; }
        
        .img-btn-size { position: absolute; bottom: -10px; right: -10px; background: var(--secondary); color: white; border-radius: 12px; padding: 3px 8px; text-align: center; font-size: 10px; font-weight: 700; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: center; gap: 4px; z-index: 10; transition: all 0.2s; border: 1px solid white; }
        .img-btn-size:hover { transform: scale(1.05); }
        .img-btn-size.active-large { background: var(--success); }

        .fab { position: fixed; bottom: 30px; right: 25px; width: 60px; height: 60px; background-color: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; box-shadow: 0 4px 15px rgba(0, 51, 102, 0.4); cursor: pointer; z-index: 90; display: none; transition: transform 0.2s, background-color 0.2s; }
        .fab:hover { transform: scale(1.05); background-color: #002850; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); display: none; justify-content: center; align-items: center; z-index: 200; }
        .modal-content { background: white; width: 90%; max-width: 800px; max-height: 85vh; overflow-y: auto; border-radius: 20px; padding: 30px; position: relative; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1); }
        .modal-content h3 { margin-top: 0; color: var(--text-main); font-size: 1.3rem; }
        .close-modal { position: absolute; top: 20px; right: 25px; font-size: 28px; cursor: pointer; color: #9ca3af; transition: color 0.2s; }
        
        .btn { padding: 14px 24px; border: none; border-radius: 12px; cursor: pointer; font-weight: 600; width: 100%; margin-top: 15px; font-size: 1rem; transition: filter 0.2s, transform 0.1s; }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 6px -1px rgba(0, 51, 102, 0.2); }
        .btn-secondary { background: white; color: var(--text-main); border: 1px solid var(--border-color); }
        .btn-success { background: var(--success); color: white; box-shadow: 0 4px 6px -1px rgba(16, 185, 129, 0.2); }

        .spinner { border: 3px solid #f3f3f3; border-top: 3px solid var(--primary); border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite; display: none; margin-left: 10px; vertical-align: middle; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        #toast { visibility: hidden; min-width: 250px; margin-left: -140px; background-color: #1f2937; color: #fff; text-align: center; border-radius: 50px; padding: 12px 20px; position: fixed; z-index: 1000; left: 50%; bottom: 30px; font-size: 0.95rem; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); font-weight: 500; }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }

        #pdf-preview { background: white; padding: 40px; min-height: 800px; border: 1px solid #e5e7eb; font-size: 14px; color: #374151; }
        .pdf-header { border-bottom: 2px solid #111827; padding-bottom: 20px; margin-bottom: 30px; }
        .pdf-row { display: flex; justify-content: space-between; margin-bottom: 8px; border-bottom: 1px dashed #f3f4f6; padding-bottom: 4px; }
        .pdf-row:last-child { border-bottom: none; }
        @media print { .nav-header, .fab, .section:not(#export), .btn, .app-logo-header, #dashboard { display: none !important; } #export { display: block !important; } #pdf-preview { border: none; padding: 0; } }

        #sync-status { position: fixed; top: 70px; right: 15px; font-size: 12px; padding: 5px 10px; border-radius: 12px; background: rgba(255,255,255,0.8); box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: none; align-items: center; gap: 5px; z-index: 99; }
        #sync-status.online { color: var(--success); display: flex; }
        #sync-status.offline { color: var(--danger); display: flex; }
        
        .lang-toggle-container { display: flex; gap: 10px; margin-top: 15px; justify-content: center; }
        .lang-btn { border: 2px solid var(--primary); background: white; color: var(--primary); padding: 8px 16px; border-radius: 8px; font-weight: bold; cursor: pointer; transition: all 0.2s; }
        .lang-btn.active { background: var(--primary); color: white; }
    </style>
</head>
<body>

    <!-- APP HEADER -->
    <div class="app-logo-header">
        <div style="display:flex; align-items:center;">
            <button class="back-btn" id="nav-back-btn" onclick="window.goToDashboard()" data-i18n="overview">
                <i class="fa-solid fa-chevron-left"></i> Übersicht
            </button>
            <img src="https://cdn.gea.com/-/jssmedia/common/logos/gea-logo.svg?mw=85" alt="GEA" class="app-logo-img" id="header-logo">
            <span id="app-title" class="header-title" style="display:none;" data-i18n="app_title">mooMemo</span>
        </div>
        <div class="header-controls">
            <button class="icon-btn" onclick="window.openSettings()" style="color:var(--primary);" title="Settings"><i class="fa-solid fa-gear"></i></button>
        </div>
    </div>

    <div id="sync-status"><i class="fas fa-cloud"></i> <span id="sync-text">Verbunden</span></div>

    <!-- TABS -->
    <div class="nav-header" id="tab-navigation">
        <div class="nav-item active" onclick="window.switchTab('header')"><i class="fa-solid fa-clipboard-user"></i> <span data-i18n="tab_base">Basis</span></div>
        <div class="nav-item" onclick="window.switchTab('points')"><i class="fa-solid fa-list-check"></i> <span data-i18n="tab_points">Punkte</span></div>
        <div class="nav-item" onclick="window.switchTab('status')"><i class="fa-solid fa-check-double"></i> <span data-i18n="tab_status">Status</span></div>
        <div class="nav-item" onclick="window.switchTab('export')"><i class="fa-solid fa-file-pdf"></i> <span data-i18n="tab_export">Export</span></div>
    </div>

    <!-- DASHBOARD -->
    <div id="dashboard" class="section active">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 1.5rem;">
            <h2 style="margin-bottom:0;"><i class="fa-solid fa-folder-open"></i> <span data-i18n="dash_title">Berichte (Cloud)</span></h2>
            <button class="icon-btn" onclick="window.askAdminTools()" style="color:var(--primary);" title="Admin Tools"><i class="fa-solid fa-user-shield"></i></button>
        </div>
        <div class="filter-container">
             <!-- NEW SEARCH INPUT -->
             <div class="search-container">
                <input type="text" class="search-input" id="search-input" placeholder="Suchen... (ID, Kunde, von:Name)" oninput="window.renderReportList()">
            </div>
            
            <div class="filter-tabs" id="filter-type-container">
                <button class="filter-pill active" onclick="window.setFilterType('all')" data-i18n="filter_all">Alle</button>
                <button class="filter-pill" onclick="window.setFilterType('AMS')">AMS</button>
                <button class="filter-pill" onclick="window.setFilterType('CMS')">CMS</button>
                <button class="filter-pill" onclick="window.setFilterType('AS')">AS</button>
            </div>
            <div class="filter-control-group">
                <select class="year-select" id="year-filter" onchange="window.setFilterYear(this.value)"><option value="all" data-i18n="filter_all_years">Alle Jahre</option></select>
                <select class="sort-select" id="sort-filter" onchange="window.setSortMethod(this.value)">
                    <option value="date_desc" data-i18n="sort_date_desc">Datum (Neu)</option>
                    <option value="date_asc" data-i18n="sort_date_asc">Datum (Alt)</option>
                    <option value="author" data-i18n="sort_author">Ersteller</option>
                    <option value="open_points" data-i18n="sort_open">Offene Punkte</option>
                </select>
            </div>
        </div>
        <button class="btn btn-primary" onclick="window.createNewReport()"><i class="fa-solid fa-plus"></i> <span data-i18n="btn_new">Neuer Bericht erstellen</span></button>
        <div id="report-list" style="margin-top:25px;">
            <div style="text-align:center; padding: 20px; color: #64748b;"><i class="fas fa-circle-notch fa-spin"></i> <span data-i18n="loading">Lade Daten aus der Cloud...</span></div>
        </div>
        <hr style="border:0; border-top:1px solid #e2e8f0; margin:35px 0 20px 0;">
        <h3 style="font-size:1rem; color:var(--text-sub); margin-bottom:10px;"><i class="fa-solid fa-screwdriver-wrench"></i> <span data-i18n="tools_title">Tools</span></h3>
        <button class="btn btn-secondary" onclick="document.getElementById('import-input').click()" style="width:auto; padding: 8px 16px; font-size: 0.85rem; margin-top:0;"><i class="fa-solid fa-file-import"></i> <span data-i18n="btn_import">Bericht importieren / Update</span></button>
        <input type="file" id="import-input" style="display:none" accept=".json" onchange="window.importBackup(this)">
    </div>

    <!-- HEADER DATA -->
    <div id="header" class="section">
        <h2><i class="fa-solid fa-info-circle"></i> <span data-i18n="h_base">Basisdaten</span></h2>
        <div class="card">
            <label data-i18n="lbl_area">Bereich</label>
            <select id="h_type" onchange="window.updateCurrentReportHeader()" style="margin-bottom: 20px;"><option value="AMS">AMS</option><option value="CMS">CMS</option><option value="AS">AS</option></select>
            <label data-i18n="lbl_customer">Kunde / Projekt</label>
            <div class="input-group"><input type="text" id="h_customer" placeholder="z.B. Müller GmbH" oninput="window.updateCurrentReportHeader()"><button class="mic-btn" onclick="window.listen('h_customer')"><i class="fa-solid fa-microphone"></i></button></div>
            <br><label data-i18n="lbl_date">Datum (von - bis)</label>
            <div style="display:flex; gap:15px;"><input type="date" id="h_date_from" onchange="window.updateCurrentReportHeader()"><input type="date" id="h_date_to" onchange="window.updateCurrentReportHeader()"></div>
            <br><label data-i18n="lbl_author">Verfasser</label><input type="text" id="h_author" placeholder="Name" oninput="window.updateCurrentReportHeader()">
            <br><hr style="border:0; border-top:1px solid #eee; margin:25px 0;"><label data-i18n="lbl_participants">Teilnehmer</label>
            <div id="participants-list" class="participant-list"></div>
            <div class="input-group" style="display:flex; gap:10px;"><input type="text" id="new_participant" placeholder="..." style="flex:1;"><button class="btn btn-primary" style="width:auto; margin:0;" onclick="window.addParticipant()"><i class="fa-solid fa-plus"></i></button></div>
        </div>
        <button class="btn btn-primary" onclick="window.switchTab('points')" data-i18n="btn_next_points">Weiter zu den Punkten</button>
    </div>

    <!-- POINTS LIST -->
    <div id="points" class="section">
        <h2><i class="fa-solid fa-list"></i> <span data-i18n="h_points">Besuchs-Punkte</span></h2>
        <p style="color:var(--text-sub); font-size:0.9rem; margin-bottom:15px;" data-i18n="points_hint">Tippe auf einen Punkt zum Bearbeiten.</p>
        <div id="points-list"></div>
        <div class="fab" id="fab-btn" onclick="window.openModal()"><i class="fa-solid fa-plus"></i></div>
    </div>

    <!-- STATUS OVERVIEW -->
    <div id="status" class="section">
        <h2><i class="fa-solid fa-tasks"></i> <span data-i18n="h_status">Status Übersicht</span></h2>
        <div style="display:flex; gap:20px; flex-wrap:wrap; align-items:flex-start;">
            <div style="flex:1 1 300px;">
                <div style="background:white; padding:20px; border-radius:16px; border-top:5px solid var(--danger); text-align:center; margin-bottom:20px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);"><div style="font-size:2.5rem; font-weight:800; color:var(--danger); line-height:1;" id="count-open">0</div><div style="font-size:0.85rem; color:var(--text-sub); font-weight:600; margin-top:5px;" data-i18n="status_open_uc">OFFEN</div></div>
                <div id="list-open"></div>
            </div>
            <div style="flex:1 1 300px;">
                <div style="background:white; padding:20px; border-radius:16px; border-top:5px solid var(--success); text-align:center; margin-bottom:20px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);"><div style="font-size:2.5rem; font-weight:800; color:var(--success); line-height:1;" id="count-resolved">0</div><div style="font-size:0.85rem; color:var(--text-sub); font-weight:600; margin-top:5px;" data-i18n="status_resolved_uc">GELÖST / INFO</div></div>
                <div id="list-resolved"></div>
            </div>
        </div>
    </div>

    <!-- EXPORT -->
    <div id="export" class="section">
        <h2><i class="fa-solid fa-print"></i> <span data-i18n="h_export">Bericht Abschließen</span></h2>
        <button class="btn btn-primary" style="margin-bottom:25px;" onclick="window.generatePDF()"><i class="fa-solid fa-download"></i> <span data-i18n="btn_download_pdf">Als PDF herunterladen</span></button>
        <div id="pdf-preview"></div>
    </div>

    <!-- MODALS & TOAST -->
    <div class="modal-overlay" id="settings-modal">
        <div class="modal-content" style="max-width:350px; text-align:center;"><span class="close-modal" onclick="window.closeSettings()">&times;</span><h3 style="color:var(--text-main)"><i class="fa-solid fa-gear"></i> <span data-i18n="settings_title">Einstellungen</span></h3><p data-i18n="settings_lang">Sprache / Language</p><div class="lang-toggle-container"><button class="lang-btn active" data-lang="de" onclick="window.setLanguage('de')">DE</button><button class="lang-btn" data-lang="en" onclick="window.setLanguage('en')">EN</button></div></div>
    </div>
    
    <div class="modal-overlay" id="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="window.closeModal()">&times;</span><h3 id="modal-title" data-i18n="modal_new_point">Neuer Punkt</h3><input type="hidden" id="edit-index" value="-1">
            <label data-i18n="lbl_ticket">Ticketnummer</label><div class="input-group"><input type="text" id="p_ticket" placeholder="z.B. 123456"><button class="mic-btn" onclick="window.listen('p_ticket')"><i class="fa-solid fa-microphone"></i></button></div><br>
            <label data-i18n="lbl_title">Titel / Thema</label><div class="input-group"><input type="text" id="p_title" placeholder="..."><button class="mic-btn" onclick="window.listen('p_title')"><i class="fa-solid fa-microphone"></i></button></div><br>
            <label data-i18n="lbl_desc">Beschreibung</label><div class="input-group"><textarea id="p_desc" rows="4" placeholder="..."></textarea><button class="mic-btn" onclick="window.listen('p_desc')"><i class="fa-solid fa-microphone"></i></button></div><button class="ai-btn" onclick="window.improveDescription()"><i class="fa-solid fa-wand-magic-sparkles"></i> ✨ Text überarbeiten</button><br>
            <label data-i18n="lbl_assignee">Adressat (Verantwortlich)</label><div class="input-group"><input type="text" id="p_assignee" placeholder="..."><button class="mic-btn" onclick="window.listen('p_assignee')"><i class="fa-solid fa-microphone"></i></button></div><br>
            <label data-i18n="lbl_status">Status</label><select id="p_status"><option value="open" data-i18n="opt_open">Offen (Zu erledigen)</option><option value="resolved" data-i18n="opt_resolved">Gelöst / Info</option></select><br>
            <label><span data-i18n="lbl_images">Bilder hinzufügen</span> <div class="spinner" id="img-spinner"></div></label><input type="file" id="p_images" multiple accept="image/*" capture="environment" onchange="window.handleImageUpload()"><div id="modal-img-preview" class="img-grid"></div>
            <button class="btn btn-success" onclick="window.savePoint()"><span data-i18n="btn_save">Speichern</span></button><button class="btn" style="background:#fee2e2; color:#991b1b; margin-top:10px;" onclick="window.askDeletePoint()" id="btn-delete"><span data-i18n="btn_delete">Löschen</span></button>
        </div>
    </div>
    
    <div class="modal-overlay" id="pin-auth-modal">
        <div class="modal-content" style="max-width:400px; text-align:center;"><div style="font-size:3rem; margin-bottom:10px;" id="pin-icon"><i class="fa-solid fa-lock"></i></div><h3 style="color:var(--text-main)" id="pin-title" data-i18n="admin_title">Admin Zugriff</h3><p style="color:var(--text-sub)" id="pin-desc" data-i18n="admin_desc">Bitte Admin-PIN eingeben.</p><div style="margin: 20px 0;"><label style="text-align:left; font-size:0.8rem; margin-bottom:5px;">Admin PIN</label><input type="password" id="auth-pin" placeholder="PIN" style="text-align:center; letter-spacing: 5px; font-size: 1.2rem; font-weight:bold;"></div><div style="display:flex; gap:10px; justify-content:center; margin-top:25px;"><button class="btn btn-secondary" onclick="window.closePinModal()" style="margin-top:0"><span data-i18n="btn_cancel">Abbrechen</span></button><button class="btn" id="pin-confirm-btn" style="color:white; margin-top:0" onclick="window.verifyPin()"><span data-i18n="btn_confirm">Bestätigen</span></button></div></div>
    </div>
    
    <div class="modal-overlay" id="delete-point-confirm-modal">
        <div class="modal-content" style="max-width:400px; text-align:center;"><div style="font-size:3rem; color:var(--danger); margin-bottom:10px;"><i class="fa-solid fa-trash-can"></i></div><h3 style="color:var(--text-main)" data-i18n="confirm_del_title">Punkt löschen?</h3><p style="color:var(--text-sub)" data-i18n="confirm_del_msg">Möchtest du diesen Punkt unwiderruflich entfernen?</p><div style="display:flex; gap:10px; justify-content:center; margin-top:25px;"><button class="btn btn-secondary" onclick="window.closeDeletePointModal()" style="margin-top:0"><span data-i18n="btn_cancel">Abbrechen</span></button><button class="btn" style="background:var(--danger); color:white; margin-top:0" onclick="window.executeDeletePoint()"><span data-i18n="btn_delete_confirm">Ja, Löschen</span></button></div></div>
    </div>
    
    <div class="modal-overlay" id="admin-tools-modal">
        <div class="modal-content" style="max-width:400px; text-align:center;"><span class="close-modal" onclick="window.closeAdminToolsModal()">&times;</span><div style="font-size:3rem; color:var(--primary); margin-bottom:10px;"><i class="fa-solid fa-toolbox"></i></div><h3 style="color:var(--text-main)" data-i18n="admin_area">Admin Bereich</h3><p style="color:var(--text-sub)" data-i18n="data_backup">Datensicherung & Wiederherstellung</p><div style="display:flex; flex-direction:column; gap:15px; margin-top:25px;"><button class="btn btn-secondary" onclick="window.performExport()" style="margin-top:0"><i class="fa-solid fa-download"></i> <span data-i18n="backup_save">Backup speichern (Export)</span></button><button class="btn btn-secondary" onclick="document.getElementById('import-input').click(); window.closeAdminToolsModal();" style="margin-top:0"><i class="fa-solid fa-upload"></i> <span data-i18n="backup_load">Backup importieren</span></button></div></div>
    </div>

    <div id="toast"></div>

    <!-- LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        // IMPORT STORAGE
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // --- KONFIGURATION START ---
        const myFirebaseConfig = {
            apiKey: "AIzaSyDw4L6j1QPHUsA9ExJdZwbmGyLWvo0VGBI",
            authDomain: "moomemo-a9012.firebaseapp.com",
            projectId: "moomemo-a9012",
            storageBucket: "moomemo-a9012.firebasestorage.app",
            messagingSenderId: "1096220000219",
            appId: "1:1096220000219:web:6abb389d502f93b6b271fe"
        };
        const myAppId = "moomemo-a9012"; 
        // --- KONFIGURATION ENDE ---

        let firebaseConfig;
        let appId;
        
        // --- ÄNDERUNG: ZWINGENDE VERWENDUNG DER USER-CONFIG ---
        // Wir ignorieren hier bewusst die __firebase_config der Preview-Umgebung,
        // damit die App immer auf das User-Projekt zugreift (wo die Regeln stimmen).
        firebaseConfig = myFirebaseConfig;
        appId = myAppId;

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app); // Init Storage

        let currentUser = null;
        let allReports = []; 
        let currentReportId = null;
        let points = []; 
        let tempImages = []; 
        let pendingPinAction = null; 
        let headerUpdateTimeout = null; 
        const LOGO_SRC = "https://cdn.gea.com/-/jssmedia/common/logos/gea-logo.svg?mw=85";
        
        let filterType = 'all';
        let filterYear = 'all';
        let sortMethod = 'date_desc'; 
        let currentLang = 'de';

        const translations = {
            de: {
                app_title: "mooMemo", overview: "Übersicht", tab_base: "Basis", tab_points: "Punkte", tab_status: "Status", tab_export: "Export", dash_title: "Berichte (Cloud)", filter_all: "Alle", filter_all_years: "Alle Jahre", sort_date_desc: "Datum (Neu)", sort_date_asc: "Datum (Alt)", sort_author: "Ersteller", sort_open: "Offene Punkte", btn_new: "Neuer Bericht erstellen", loading: "Lade Daten aus der Cloud...", tools_title: "Tools", btn_import: "Bericht importieren / Update", h_base: "Basisdaten", lbl_area: "Bereich", lbl_customer: "Kunde / Projekt", lbl_date: "Datum (von - bis)", lbl_author: "Verfasser", lbl_participants: "Teilnehmer", btn_next_points: "Weiter zu den Punkten", h_points: "Besuchs-Punkte", points_hint: "Tippe auf einen Punkt zum Bearbeiten.", h_status: "Status Übersicht", status_open_uc: "OFFEN", status_resolved_uc: "GELÖST / INFO", h_export: "Bericht Abschließen", btn_download_pdf: "Als PDF herunterladen", modal_new_point: "Neuer Punkt", lbl_ticket: "Ticketnummer", lbl_title: "Titel / Thema", lbl_desc: "Beschreibung", lbl_assignee: "Adressat (Verantwortlich)", lbl_status: "Status", opt_open: "Offen (Zu erledigen)", opt_resolved: "Gelöst / Info", lbl_images: "Bilder hinzufügen", btn_save: "Speichern", btn_delete: "Löschen", btn_delete_confirm: "Ja, Löschen", btn_cancel: "Abbrechen", btn_confirm: "Bestätigen", admin_title: "Admin Zugriff", admin_desc: "Bitte Admin-PIN eingeben.", confirm_del_title: "Punkt löschen?", confirm_del_msg: "Möchtest du diesen Punkt unwiderruflich entfernen?", admin_area: "Admin Bereich", data_backup: "Datensicherung & Wiederherstellung", backup_save: "Backup speichern (Export)", backup_load: "Backup importieren", status_open: "OFFEN", status_resolved: "GELÖST / INFO", no_assignee: "Nicht zugewiesen", no_points: "Keine Punkte.", no_open_points: "Keine offenen Punkte", no_resolved_points: "Keine gelösten Punkte", overdue: "Überfällig", months_short: "Mon.", new: "Neu", settings_title: "Einstellungen", settings_lang: "Sprache / Language", delete_report_title: "Bericht löschen?", delete_report_msg: "Möchtest du diesen Bericht unwiderruflich aus der Cloud löschen?", toast_saved: "Gespeichert", toast_deleted: "Gelöscht", toast_removed: "Bericht wurde entfernt", ai_generating: "Generiere Titel...", ai_improving: "Überarbeite Text...", ai_error: "Fehler bei der Überarbeitung.", pdf_title: "Besuchsbericht", lbl_responsible: "Verantwortlich", search_placeholder: "Suchen... (ID, Kunde, von:Name)"
            },
            en: {
                app_title: "mooMemo", overview: "Overview", tab_base: "Basic", tab_points: "Points", tab_status: "Status", tab_export: "Export", dash_title: "Reports (Cloud)", filter_all: "All", filter_all_years: "All Years", sort_date_desc: "Date (New)", sort_date_asc: "Date (Old)", sort_author: "Author", sort_open: "Open Points", btn_new: "Create New Report", loading: "Loading cloud data...", tools_title: "Tools", btn_import: "Import Report / Update", h_base: "Basic Data", lbl_area: "Area", lbl_customer: "Customer / Project", lbl_date: "Date (from - to)", lbl_author: "Author", lbl_participants: "Participants", btn_next_points: "Go to Points", h_points: "Visit Points", points_hint: "Tap on a point to edit.", h_status: "Status Overview", status_open_uc: "OPEN", status_resolved_uc: "RESOLVED / INFO", h_export: "Complete Report", btn_download_pdf: "Download as PDF", modal_new_point: "New Point", lbl_ticket: "Ticket Number", lbl_title: "Title / Topic", lbl_desc: "Description", lbl_assignee: "Assignee (Responsible)", lbl_status: "Status", opt_open: "Open (To do)", opt_resolved: "Resolved / Info", lbl_images: "Add Images", btn_save: "Save", btn_delete: "Delete", btn_delete_confirm: "Yes, Delete", btn_cancel: "Cancel", btn_confirm: "Confirm", admin_title: "Admin Access", admin_desc: "Please enter Admin PIN.", confirm_del_title: "Delete Point?", confirm_del_msg: "Do you want to permanently delete this point?", admin_area: "Admin Area", data_backup: "Backup & Restore", backup_save: "Save Backup (Export)", backup_load: "Import Backup", status_open: "OPEN", status_resolved: "RESOLVED / INFO", no_assignee: "Unassigned", no_points: "No points yet.", no_open_points: "No open points", no_resolved_points: "No resolved points", overdue: "Overdue", months_short: "mo.", new: "New", settings_title: "Settings", settings_lang: "Sprache / Language", delete_report_title: "Delete Report?", delete_report_msg: "Do you want to permanently delete this report from the cloud?", toast_saved: "Saved", toast_deleted: "Deleted", toast_removed: "Report was removed", ai_generating: "Generating Title...", ai_improving: "Improving Text...", ai_error: "Error improving text.", pdf_title: "Visit Report", lbl_responsible: "Responsible", search_placeholder: "Search... (ID, Customer, from:Name)"
            }
        };

        // --- AUTHENTIFIZIERUNG ---
        const initAuth = async () => {
            try {
                // Wir erzwingen hier Anonymen Login, da wir auf das eigene Projekt zugreifen wollen
                // und der Preview-Token oft für das System-Projekt gilt.
                await signInAnonymously(auth);
            } catch(e) { 
                console.error("Auth failed", e);
                let msg = "Fehler bei der Anmeldung: " + e.message;
                alert(msg);
                document.getElementById('sync-text').textContent = "Auth Fehler";
                document.getElementById('sync-status').classList.add('offline');
            }
        };

        // Init App on Load
        document.addEventListener('DOMContentLoaded', () => {
            // Start on Dashboard
            window.goToDashboard();
            window.setLanguage('de');
        });

        initAuth();

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                updateSyncStatus(true);
                setupRealtimeListener();
            } else {
                updateSyncStatus(false);
            }
        });

        function updateSyncStatus(isOnline) {
            const el = document.getElementById('sync-status');
            const txt = document.getElementById('sync-text');
            if(!el || !txt) return; // Safety check
            if(isOnline) {
                el.classList.add('online'); el.classList.remove('offline');
                txt.textContent = "Cloud Verbunden";
            } else {
                el.classList.add('offline'); el.classList.remove('online');
                txt.textContent = "Offline";
            }
        }

        function setupRealtimeListener() {
            // Using Public Data path so everyone sees everything
            const q = collection(db, 'artifacts', appId, 'public', 'data', 'reports');
            
            onSnapshot(q, (snapshot) => {
                const newReports = [];
                snapshot.forEach(doc => newReports.push(doc.data()));
                // Raw data update, no sorting here anymore, done in render
                allReports = newReports;
                
                // NUR die Liste neu rendern, NICHT die Ansicht wechseln!
                window.renderReportList();

                // If currently viewing a report, refresh its data in memory
                if (currentReportId) {
                    const r = allReports.find(x => x.id === currentReportId);
                    if (r) {
                        points = r.points; // Update reference
                        // Refresh views if they are active
                        if(document.getElementById('points').classList.contains('active')) window.renderPointsList();
                        if(document.getElementById('status').classList.contains('active')) window.renderStatusList();
                        // Header inputs not refreshed to avoid overwriting while typing
                    } else {
                        // Report was deleted remotely
                        window.goToDashboard();
                        window.showToast(translations[currentLang].toast_removed);
                    }
                }
            }, (error) => {
                console.error("Sync error:", error);
                if (error.code === 'permission-denied') {
                    alert("⚠️ ZUGRIFF VERWEIGERT: Bitte stelle sicher, dass in der Firebase Konsole unter 'Firestore Database' -> 'Rules' der Zugriff erlaubt ist (allow read, write: if true;).");
                }
                updateSyncStatus(false);
            });
        }

        // --- FIRESTORE OPERATIONS ---
        
        async function saveReportToFirestore(report) {
            if (!currentUser) return;
            try {
                // Public collection for shared access
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'reports', report.id), report);
            } catch(e) {
                console.error("Save failed", e);
                if(e.code === 'storage/quota-exceeded') {
                     alert("Speicher voll.");
                } else if (e.message && e.message.includes("exceeds the maximum allowed size")) {
                     alert("Fehler: Der Bericht ist zu groß (max. 1 MB). Das passiert bei zu vielen Bildern. Bitte lösche ein paar Bilder, damit gespeichert werden kann.");
                } else if(e.code === 'permission-denied') {
                     alert("Speichern fehlgeschlagen: Keine Berechtigung (Firebase Rules prüfen).");
                } else {
                     alert("Fehler beim Speichern: " + e.message);
                }
            }
        }

        async function deleteReportFromFirestore(id) {
            if (!currentUser) return;
            try {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'reports', id));
            } catch(e) { 
                console.error("Delete failed", e);
                alert("Löschen fehlgeschlagen: " + e.message);
            }
        }

        // --- EXPORTED WINDOW FUNCTIONS ---
        // We attach these to window because they are called from HTML onclick attributes

        window.showToast = function(message) {
            const x = document.getElementById("toast");
            x.className = "show";
            x.textContent = message;
            setTimeout(function(){ x.className = x.className.replace("show", ""); }, 3000);
        }

        // --- FILTER LOGIC ---
        window.setFilterType = function(type) {
            filterType = type;
            // UI Update active class
            document.querySelectorAll('#filter-type-container .filter-pill').forEach(btn => {
                if(btn.innerText === type || (type === 'all' && btn.innerText === 'Alle')) btn.classList.add('active');
                else btn.classList.remove('active');
            });
            window.renderReportList();
        }

        window.setFilterYear = function(year) {
            filterYear = year;
            window.renderReportList();
        }

        // --- SORT LOGIC ---
        window.setSortMethod = function(method) {
            sortMethod = method;
            window.renderReportList();
        }

        // --- I18N LOGIC ---
        window.openSettings = function() {
            document.getElementById('settings-modal').style.display = 'flex';
        };
        window.closeSettings = function() {
            document.getElementById('settings-modal').style.display = 'none';
        };
        window.setLanguage = function(lang) {
            currentLang = lang;
            const t = translations[lang];
            
            // Update simple text elements
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if(t[key]) {
                    // Special case for elements with icons inside
                    if(el.children.length > 0 && el.tagName === 'BUTTON') {
                        // Preserving icon implies logic, easier to rebuild innerHTML for specific buttons or just span wrap text
                        // For simplicity in this layout, we wrap text in spans in HTML and target spans, or rebuild:
                        const icon = el.querySelector('i');
                        if(icon) {
                            el.innerHTML = '';
                            el.appendChild(icon);
                            el.appendChild(document.createTextNode(' ' + t[key]));
                        } else {
                            el.innerText = t[key];
                        }
                    } else if(el.tagName === 'SPAN' || el.tagName === 'H2' || el.tagName === 'H3' || el.tagName === 'LABEL' || el.tagName === 'P' || el.tagName === 'OPTION' || el.tagName === 'DIV') {
                        el.innerText = t[key];
                    }
                }
            });
            
            // Search Placeholder Update
            document.getElementById('search-input').placeholder = t.search_placeholder;

            // Update placeholders
            // ... (can be added if needed, for now standard)

            // UI Toggle
            document.querySelectorAll('.lang-btn').forEach(btn => btn.classList.remove('active'));
            // Fix: Use a safer selector to find the active button
            const activeBtn = document.querySelector(`.lang-btn[data-lang="${lang}"]`);
            if(activeBtn) activeBtn.classList.add('active');

            // Re-render lists to update dynamic text (dates, status)
            window.renderReportList();
            if(document.getElementById('points').classList.contains('active')) window.renderPointsList();
            if(document.getElementById('status').classList.contains('active')) window.renderStatusList();
            
            window.closeSettings();
        }

        // --- HELPER: AGE CALCULATION ---
        function getAgeInMonths(dateStr) {
            if (!dateStr) return 0;
            const start = new Date(dateStr);
            const now = new Date();
            if(isNaN(start.getTime())) return 0;
            
            // Difference in months
            let months = (now.getFullYear() - start.getFullYear()) * 12;
            months -= start.getMonth();
            months += now.getMonth();
            return months <= 0 ? 0 : months;
        }

        function getAgeClass(dateStr) {
            const months = getAgeInMonths(dateStr);
            if (months >= 6) return 'age-critical';
            if (months >= 3) return 'age-warning';
            return 'age-fresh';
        }

        function getAgeBadge(dateStr) {
            const months = getAgeInMonths(dateStr);
            const t = translations[currentLang];
            if (months >= 6) return `<span class="status-badge badge-critical"><i class="fa-solid fa-triangle-exclamation"></i> ${months} ${t.months_short}</span>`;
            if (months >= 3) return `<span class="status-badge badge-warning"><i class="fa-solid fa-clock"></i> ${months} ${t.months_short}</span>`;
            return `<span class="status-badge badge-fresh">${t.new}</span>`;
        }
        
        function getDashboardAgeBadge(dateStr) {
            const months = getAgeInMonths(dateStr);
            const t = translations[currentLang];
            // Display inline with other info, removed absolute positioning or distinct block styling if needed
            if (months >= 6) return `<span style="color:#7f1d1d; font-weight:700; margin-left:8px; font-size:0.85rem;"><i class="fa-solid fa-triangle-exclamation"></i> ${t.overdue}: ${months}. ${t.months_short}</span>`;
            if (months >= 3) return `<span style="color:#92400e; font-weight:700; margin-left:8px; font-size:0.85rem;"><i class="fa-solid fa-clock"></i> ${t.overdue}: ${months}. ${t.months_short}</span>`;
            return '';
        }
        
        // --- GEMINI API CALL: Text Improvement ---
        window.improveDescription = async function() {
            const descField = document.getElementById('p_desc');
            const desc = descField.value.trim();
            
            if (desc.length < 10) {
                window.showToast("Bitte geben Sie mehr Text zur Überarbeitung ein.");
                return;
            }

            const oldText = desc;
            const originalButtonHTML = document.querySelector('.ai-btn').innerHTML;
            document.querySelector('.ai-btn').innerHTML = `<i class="fas fa-spinner fa-spin"></i> ${translations[currentLang].ai_improving}`;

            const userPrompt = `Review and professionalize the following maintenance or inspection report text. Correct spelling and grammar errors. Improve flow and clarity without losing the technical content. The output must be solely the rewritten text, formatted as a single paragraph or bullet points if appropriate for clarity. The language must be: ${currentLang === 'de' ? 'German' : 'English'}.
            
            Original Text: "${desc}"
            
            Rewritten Text:`;

            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: userPrompt }] }],
                systemInstruction: {
                    parts: [{ text: `Act as a professional technical copywriter. Output only the rewritten text in ${currentLang === 'de' ? 'German' : 'English'}.` }]
                },
                config: {
                    temperature: 0.2
                }
            };
            
            let resultText = oldText;
            let success = false;
            let retries = 0;
            const maxRetries = 3;

            while (!success && retries < maxRetries) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.status === 429) {
                        retries++;
                        const delay = Math.pow(2, retries) * 1000;
                        console.warn(`Rate limit exceeded. Retrying in ${delay / 1000}s...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue;
                    }
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    const candidate = result.candidates?.[0];

                    if (candidate && candidate.content?.parts?.[0]?.text) {
                        resultText = candidate.content.parts[0].text.trim();
                        success = true;
                    } else {
                        throw new Error("Invalid response structure from API.");
                    }
                } catch (error) {
                    console.error("Gemini API Error:", error);
                    window.showToast(translations[currentLang].ai_error);
                    resultText = oldText;
                    break;
                }
            }
            
            descField.value = resultText;
            document.querySelector('.ai-btn').innerHTML = originalButtonHTML;
            if (success) {
                window.showToast("Text erfolgreich überarbeitet!");
            }
        }


        // --- DASHBOARD & DELETE LOGIC ---

        // Neue Funktion: Nur die Liste rendern (ohne Navigation)
        window.renderReportList = function() {
            const t = translations[currentLang];
            // Populate Year Filter (only unique years)
            const yearSelect = document.getElementById('year-filter');
            const uniqueYears = [...new Set(allReports.map(r => r.header.date_from ? r.header.date_from.substring(0,4) : ''))].filter(y => y).sort().reverse();
            // Store current value to restore it
            const currentVal = yearSelect.value;
            yearSelect.innerHTML = `<option value="all">${t.filter_all_years}</option>`;
            uniqueYears.forEach(y => {
                yearSelect.innerHTML += `<option value="${y}">${y}</option>`;
            });
            // Restore selection if still valid, otherwise default to filterYear state
            if(uniqueYears.includes(filterYear)) yearSelect.value = filterYear;
            else if(filterYear !== 'all') yearSelect.value = 'all';
            else yearSelect.value = currentVal;
            
            // SEARCH FILTERING
            const searchInput = document.getElementById('search-input');
            const searchQuery = searchInput ? searchInput.value.toLowerCase().trim() : '';

            const list = document.getElementById('report-list');
            if(allReports.length === 0) {
                list.innerHTML = `<div style="text-align:center; padding:20px;">${t.no_points}</div>`; // Reusing no_points or add no_reports
                return;
            }

            // FILTERING LOGIC (Type, Year AND Search)
            let filteredReports = allReports.filter(r => {
                const rType = r.header.type || 'AMS'; // Default backward compatibility
                const rYear = r.header.date_from ? r.header.date_from.substring(0,4) : '';
                
                // Base filters
                const matchType = (filterType === 'all') || (rType === filterType);
                const matchYear = (filterYear === 'all') || (rYear === filterYear);
                
                // Search Logic
                let matchSearch = true;
                if(searchQuery) {
                    const rId = (r.readable_id || r.id).toLowerCase(); // Check Readable ID first
                    const rCustomer = (r.header.customer || '').toLowerCase();
                    const rAuthor = (r.header.author || '').toLowerCase();
                    
                    // Specific Search: "von:max"
                    if(searchQuery.startsWith('von:')) {
                        const authorQuery = searchQuery.replace('von:', '').trim();
                        matchSearch = rAuthor.includes(authorQuery);
                    } else {
                        // General Search: ID, Customer, Content in Points
                        let inPoints = false;
                        if(r.points) {
                            inPoints = r.points.some(p => 
                                (p.title && p.title.toLowerCase().includes(searchQuery)) || 
                                (p.desc && p.desc.toLowerCase().includes(searchQuery))
                            );
                        }
                        
                        matchSearch = rId.includes(searchQuery) || rCustomer.includes(searchQuery) || inPoints;
                    }
                }
                
                return matchType && matchYear && matchSearch;
            });

            // SORTING LOGIC
            filteredReports.sort((a, b) => {
                switch(sortMethod) {
                    case 'date_asc':
                        return (new Date(a.header.date_from || 0)) - (new Date(b.header.date_from || 0));
                    case 'author':
                        return (a.header.author || '').localeCompare(b.header.author || '');
                    case 'open_points':
                        const openA = (a.points || []).filter(p => p.status === 'open').length;
                        const openB = (b.points || []).filter(p => p.status === 'open').length;
                        return openB - openA; // Most open points first
                    case 'date_desc':
                    default:
                        return (new Date(b.header.date_from || 0)) - (new Date(a.header.date_from || 0));
                }
            });

            if(filteredReports.length === 0) {
                 list.innerHTML = '<div style="text-align:center; color:#94a3b8; padding:20px;">Keine Berichte für diesen Filter.</div>';
                 return;
            }

            list.innerHTML = filteredReports.map(r => {
                let title = r.header.customer || "Neuer Bericht";
                if(r.header.date_from) {
                    const d1 = new Date(r.header.date_from);
                    if(!isNaN(d1.getTime())) {
                        const [w1, y1] = getWeekNumber(d1);
                        let ts = `KW ${w1}`;
                        let ys = ` ${y1}`;
                        if(r.header.date_to) {
                             const d2 = new Date(r.header.date_to);
                             if(!isNaN(d2.getTime()) && d2 >= d1) {
                                const [w2, y2] = getWeekNumber(d2);
                                if(y1===y2 && w1!==w2) ts += `-${w2}`;
                                else if(y1!==y2) { ts += ` (${y1}) - KW ${w2}`; ys = ` (${y2})`; }
                             }
                        }
                        if(!ts.includes('(')) ts += ys;
                        title = `${ts} - ${r.header.customer || 'Unbekannt'}`;
                    }
                }
                
                const openCount = (r.points || []).filter(p => p.status === 'open').length;
                const total = (r.points || []).length;
                
                // Readable ID Logic (Fallback to sliced ID if new field is missing)
                const displayId = r.readable_id ? `#${r.readable_id}` : `#${r.id.slice(-5)}`;
                
                // Determine CSS Class based on open points and age
                let statusClass = '';
                let dashboardBadge = '';
                
                if (total > 0 && openCount === 0) {
                    statusClass = 'all-resolved';
                } else if (openCount > 0) {
                    // Has open points, check age
                    statusClass = getAgeClass(r.header.date_from);
                    dashboardBadge = getDashboardAgeBadge(r.header.date_from);
                }

                const pointsTxt = total > 0 ? `${total} ${t.tab_points} (${openCount > 0 ? openCount + ' ' + t.opt_open.split(' ')[0] : 'alle gelöst'})` : t.no_points;
                const rType = r.header.type || 'AMS';

                return `
                <div class="report-list-item ${statusClass}">
                    <div class="report-clickable-area" onclick="window.openReport('${r.id}')">
                        <div class="report-info">
                            <h3>
                                <span><span class="report-type-badge">${rType}</span> ${title}</span>
                                <span class="report-id">${displayId}</span>
                            </h3>
                            <p><i class="fa-solid fa-user"></i> ${r.header.author || '-'}</p>
                            <p>
                                <i class="fa-solid fa-list-check"></i> 
                                <span>${pointsTxt}</span>
                                ${dashboardBadge}
                            </p>
                        </div>
                    </div>
                    <div class="report-actions">
                        <button type="button" class="btn-action" onclick="window.exportSingleReport(event, '${r.id}')" title="Exportieren">
                            <i class="fa-solid fa-file-export"></i>
                        </button>
                        <button type="button" class="btn-action delete" onclick="window.askDeleteReport(event, '${r.id}')" title="Löschen">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </div>
                </div>
            `}).join('');
        };

        window.exportSingleReport = function(event, id) {
            if(event) { event.stopPropagation(); }
            const r = allReports.find(x => x.id === id);
            if(!r) return;
            const a = document.createElement('a');
            const fileName = `bericht_${(r.header.customer || 'unbekannt').replace(/[^a-z0-9]/gi, '_')}_${r.id}.json`;
            a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(r)); 
            a.download = fileName;
            document.body.appendChild(a); a.click(); a.remove();
        };

        window.askDeleteReport = function(event, id) {
            if(event) {
                event.stopPropagation();
                event.stopImmediatePropagation();
                event.preventDefault();
            }
            const t = translations[currentLang];
            // Konfiguriere das PIN-Modal für "Löschen"
            configurePinModal(
                t.delete_report_title, 
                t.delete_report_msg,
                'var(--danger)',
                'fa-triangle-exclamation',
                () => {
                    deleteReportFromFirestore(id).then(() => {
                        window.showToast(t.toast_deleted);
                    });
                }
            );
        };

        window.askAdminTools = function() {
             const t = translations[currentLang];
             configurePinModal(
                t.admin_title, 
                t.admin_desc,
                'var(--primary)',
                'fa-user-shield',
                () => {
                    document.getElementById('admin-tools-modal').style.display = 'flex';
                }
            );
        };

        window.closeAdminToolsModal = function() {
            document.getElementById('admin-tools-modal').style.display = 'none';
        };

        window.askExportBackup = function() {
             const t = translations[currentLang];
             configurePinModal(
                t.backup_save, 
                t.admin_desc, // Reusing admin desc or add new key
                'var(--primary)',
                'fa-file-export',
                () => {
                    window.performExport();
                }
            );
        };

        window.askImportBackup = function() {
            const t = translations[currentLang];
            configurePinModal(
                t.backup_load, 
                t.admin_desc,
                'var(--primary)',
                'fa-file-import',
                () => {
                    document.getElementById('import-input').click();
                }
            );
        };

        // Hilfsfunktion zum Konfigurieren und Anzeigen des PIN-Modals
        function configurePinModal(title, desc, color, icon, callback) {
            document.getElementById('pin-title').innerText = title;
            document.getElementById('pin-desc').innerText = desc;
            
            const iconEl = document.getElementById('pin-icon');
            iconEl.style.color = color;
            iconEl.innerHTML = `<i class="fa-solid ${icon}"></i>`;
            
            const btn = document.getElementById('pin-confirm-btn');
            btn.style.background = color;
            
            document.getElementById('auth-pin').value = '';
            pendingPinAction = callback;
            
            document.getElementById('pin-auth-modal').style.display = 'flex';
            setTimeout(() => document.getElementById('auth-pin').focus(), 100);
        }

        window.closePinModal = function() {
            document.getElementById('pin-auth-modal').style.display = 'none';
            pendingPinAction = null;
        };

        window.verifyPin = function() {
            const pin = document.getElementById('auth-pin').value;
            if (pin === '0000') {
                if (pendingPinAction) pendingPinAction();
                window.closePinModal();
            } else {
                alert('Falsche PIN! Zugriff verweigert.');
                document.getElementById('auth-pin').value = '';
            }
        };

        window.executeDelete = function() {
            // Deprecated func, logic moved to verifyPin/pendingAction
        };

        window.closeDeleteModal = function() {
            // Deprecated helper, kept for compatibility if needed
            window.closePinModal();
        };

        window.openReport = function(id) {
            currentReportId = id;
            const report = allReports.find(r => String(r.id) === String(id));
            if(!report) return;
            points = report.points || [];
            
            document.getElementById('h_type').value = report.header.type || 'AMS';
            document.getElementById('h_customer').value = report.header.customer || '';
            document.getElementById('h_date_from').value = report.header.date_from || '';
            document.getElementById('h_date_to').value = report.header.date_to || '';
            document.getElementById('h_author').value = report.header.author || '';
            window.renderParticipantsList(report.header.participants || []);

            document.getElementById('dashboard').classList.remove('active');
            document.getElementById('tab-navigation').style.display = 'flex';
            document.getElementById('nav-back-btn').style.display = 'inline-block';
            document.getElementById('header-logo').style.display = 'none';
            document.getElementById('app-title').style.display = 'inline-block';
            window.switchTab('header');
        };

        window.createNewReport = function() {
            // NEW: Generate Readable ID (5 digits random)
            const readableId = Math.floor(10000 + Math.random() * 90000).toString();
            
            const newReport = {
                id: Date.now().toString(),
                readable_id: readableId, // Store it
                created_at: Date.now(),
                header: { 
                    type: 'AMS', 
                    customer: '', 
                    date_from: new Date().toISOString().split('T')[0], 
                    date_to: '', 
                    author: '', 
                    participants: [] 
                },
                points: []
            };
            // Save to Firestore first
            saveReportToFirestore(newReport).then(() => {
                window.openReport(newReport.id);
            });
        };

        window.goToDashboard = function() {
            currentReportId = null;
            points = [];
            
            // UI RESET LOGIC (ehemals in renderDashboard)
            document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
            document.getElementById('dashboard').classList.add('active');
            document.getElementById('tab-navigation').style.display = 'none';
            document.getElementById('nav-back-btn').style.display = 'none';
            document.getElementById('header-logo').style.display = 'inline-block';
            document.getElementById('app-title').style.display = 'none';

            window.renderReportList();
        };

        window.updateCurrentReportHeader = function() {
            if(!currentReportId) return;
            
            // 1. Clear any existing timeout
            if (headerUpdateTimeout) {
                clearTimeout(headerUpdateTimeout);
            }

            // 2. Set a new timeout to save after 500ms of inactivity
            headerUpdateTimeout = setTimeout(() => {
                const report = allReports.find(r => r.id === currentReportId);
                if(report) {
                    // Update local obj
                    report.header.type = document.getElementById('h_type').value;
                    report.header.customer = document.getElementById('h_customer').value;
                    report.header.date_from = document.getElementById('h_date_from').value;
                    report.header.date_to = document.getElementById('h_date_to').value;
                    report.header.author = document.getElementById('h_author').value;
                    // Sync
                    saveReportToFirestore(report);
                }
            }, 500); // 500ms debounce delay
        };

        // --- TABS & LISTS ---
        window.switchTab = function(tabId) {
            document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            
            const map = {'header':0, 'points':1, 'status':2, 'export':3};
            document.querySelectorAll('.nav-item')[map[tabId]].classList.add('active');
            
            const fab = document.getElementById('fab-btn');
            // FAB nur im Punkte-Tab anzeigen
            if(tabId === 'points') fab.style.display = 'flex'; else fab.style.display = 'none';

            if(tabId === 'points') window.renderPointsList();
            if(tabId === 'status') window.renderStatusList();
            if(tabId === 'export') window.renderPDFPreview();
        };

        // NEW: DRAG & DROP LOGIC
        let draggedItemIndex = null;

        window.handleDragStart = (e, i) => {
            draggedItemIndex = i;
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', i);
            e.target.classList.add('dragging');
            // Required for Firefox
            setTimeout(() => { e.target.style.opacity = '0.5'; }, 0);
        };

        window.handleDragOver = (e) => {
            e.preventDefault(); // Necessary to allow dropping
            e.dataTransfer.dropEffect = 'move';
            return false;
        };
        
        window.handleDragEnd = (e) => {
             e.target.classList.remove('dragging');
             e.target.style.opacity = '1';
             draggedItemIndex = null;
        };

        window.handleDrop = (e, newIndex) => {
            e.stopPropagation();
            if (draggedItemIndex !== null && draggedItemIndex !== newIndex) {
                // Swap elements in local array
                const item = points[draggedItemIndex];
                points.splice(draggedItemIndex, 1);
                points.splice(newIndex, 0, item);
                
                // Save to Firestore
                const r = allReports.find(x => x.id === currentReportId);
                if(r) { r.points = points; saveReportToFirestore(r); }
                
                // Re-render
                window.renderPointsList();
            }
            return false;
        };
        
        // NEW: MOVE UP/DOWN Logic (Mobile Fallback)
        window.movePoint = (index, direction) => {
            const newIndex = index + direction;
            if (newIndex >= 0 && newIndex < points.length) {
                const item = points[index];
                points.splice(index, 1);
                points.splice(newIndex, 0, item);
                
                const r = allReports.find(x => x.id === currentReportId);
                if(r) { r.points = points; saveReportToFirestore(r); }
                window.renderPointsList();
            }
        };

        window.renderPointsList = function() {
            const container = document.getElementById('points-list');
            const t = translations[currentLang];
            if(points.length === 0) {
                container.innerHTML = `<div style="text-align:center; padding:40px; color:#9ca3af;">${t.no_points}</div>`;
                return;
            }
            
            // Need report date to calculate age for individual points
            const report = allReports.find(x => x.id === currentReportId);
            const reportDate = report ? report.header.date_from : new Date();

            container.innerHTML = points.map((p, i) => {
                let ageClass = '';
                let ageBadge = '';
                if(p.status === 'open') {
                    ageClass = getAgeClass(reportDate);
                    ageBadge = getAgeBadge(reportDate);
                } else {
                    ageClass = 'resolved';
                    ageBadge = `<span class="status-badge status-resolved">${t.status_resolved}</span>`;
                }

                // Add Move Buttons
                const moveUp = i > 0 ? `<button class="sort-btn" onclick="event.stopPropagation(); window.movePoint(${i}, -1)"><i class="fa-solid fa-chevron-up"></i></button>` : '';
                const moveDown = i < points.length - 1 ? `<button class="sort-btn" onclick="event.stopPropagation(); window.movePoint(${i}, 1)"><i class="fa-solid fa-chevron-down"></i></button>` : '';

                return `
                <div class="point-item ${ageClass}" draggable="true" ondragstart="window.handleDragStart(event, ${i})" ondragover="window.handleDragOver(event)" ondrop="window.handleDrop(event, ${i})" ondragend="window.handleDragEnd(event)" onclick="window.openModal(${i})">
                    <div class="point-content-wrapper">
                        <div class="point-header-row">
                            <div class="point-title">
                                ${p.ticket ? `<span class="ticket-link"><i class="fa-solid fa-ticket"></i> CRM ${p.ticket}</span>` : ''}
                                ${p.title}
                            </div>
                            <div>${ageBadge}</div>
                        </div>
                        <div class="point-desc">${(p.desc || '').substring(0, 80)}...</div>
                        <div class="point-meta-row">
                            <span><i class="fa-solid fa-user"></i> ${p.assignee || t.no_assignee}</span>
                            ${p.images && p.images.length ? `<span><i class="fa-solid fa-image"></i> ${p.images.length}</span>` : ''}
                        </div>
                    </div>
                    <div class="point-sort-column">
                        ${moveUp}
                        ${moveDown}
                    </div>
                </div>
            `}).join('');
        };

        window.renderStatusList = function() {
            const listOpen = document.getElementById('list-open');
            const listResolved = document.getElementById('list-resolved');
            const t = translations[currentLang];
            let cOpen = 0, cRes = 0;
            let htmlOpen = '', htmlResolved = '';

            points.forEach((p, i) => {
                const btnText = p.status === 'open' ? t.status_open : t.status_resolved;
                const btnBg = p.status === 'open' ? 'var(--danger-bg)' : 'var(--success-bg)'; 
                const btnColor = p.status === 'open' ? '#991b1b' : '#065f46';
                
                // Add image count logic
                const imgCount = p.images && p.images.length > 0 
                    ? `<span style="margin-left:8px; opacity:0.8;"><i class="fa-solid fa-image"></i> ${p.images.length}</span>` 
                    : '';
                
                // Add Ticket Display Logic
                const ticketDisplay = p.ticket 
                    ? `<span style="font-size:0.75rem; background:#eff6ff; color:#1d4ed8; padding:1px 6px; border-radius:4px; margin-right:6px; border:1px solid #bfdbfe; vertical-align:middle; display:inline-block;"><i class="fa-solid fa-ticket"></i> CRM ${p.ticket}</span>` 
                    : '';

                const item = `
                <div class="status-item-anim" style="background:white; padding:15px; margin-bottom:10px; border-radius:12px; display:flex; justify-content:space-between; align-items:center; border-left:4px solid ${p.status==='open'?'var(--danger)':'var(--success)'}; cursor:pointer; box-shadow: 0 1px 3px rgba(0,0,0,0.05);" onclick="window.openModal(${i})">
                    <div style="flex:1">
                        <div style="margin-bottom:2px;">${ticketDisplay}<strong style="vertical-align:middle;">${p.title}</strong></div>
                        <div style="font-size:0.8rem; color:gray; margin-top:2px;">
                             <i class="fa-solid fa-user" style="font-size:0.7rem;"></i> ${p.assignee || t.no_assignee}
                             ${imgCount}
                        </div>
                    </div>
                    <button class="btn" style="width:auto; margin:0; margin-left:10px; font-size:0.75rem; padding:6px 12px; background:${btnBg}; color:${btnColor}; font-weight:700; border-radius:8px;" 
                    onclick="event.stopPropagation(); window.toggleStatus(${i})">${btnText}</button>
                </div>`;
                
                if(p.status === 'open') { 
                    cOpen++; 
                    htmlOpen += item; 
                } else { 
                    cRes++; 
                    htmlResolved += item; 
                }
            });
            
            listOpen.innerHTML = htmlOpen || `<div style="text-align:center; color:#9ca3af; font-style:italic;">${t.no_open_points}</div>`;
            listResolved.innerHTML = htmlResolved || `<div style="text-align:center; color:#9ca3af; font-style:italic;">${t.no_resolved_points}</div>`;
            document.getElementById('count-open').innerText = cOpen;
            document.getElementById('count-resolved').innerText = cRes;
        };

        window.toggleStatus = function(i) {
            // Update local first for response
            points[i].status = points[i].status === 'open' ? 'resolved' : 'open';
            // Sync entire report
            const r = allReports.find(x => x.id === currentReportId);
            if(r) saveReportToFirestore(r);
            // Render locally immediately
            setTimeout(() => { window.renderStatusList(); window.renderPointsList(); }, 10);
        };

        // --- PARTICIPANTS ---
        window.renderParticipantsList = function(list) {
            const container = document.getElementById('participants-list');
            if(!list || list.length === 0) { container.innerHTML = '<span style="color:#aaa;">Keine Teilnehmer</span>'; return; }
            container.innerHTML = list.map((p, i) => `
                <div class="participant-tag">${p} <span class="participant-remove" onclick="window.removeParticipant(${i})">&times;</span></div>
            `).join('');
        };
        window.addParticipant = function() {
            const input = document.getElementById('new_participant');
            const name = input.value.trim();
            if(!name || !currentReportId) return;
            const r = allReports.find(x => x.id === currentReportId);
            if(!r.header.participants) r.header.participants = [];
            r.header.participants.push(name);
            input.value = '';
            saveReportToFirestore(r);
            window.renderParticipantsList(r.header.participants);
        };
        window.removeParticipant = function(i) {
            const r = allReports.find(x => x.id === currentReportId);
            r.header.participants.splice(i, 1);
            saveReportToFirestore(r);
            window.renderParticipantsList(r.header.participants);
        };

        // --- MODAL ---
        window.openModal = function(index = -1) {
            document.getElementById('edit-index').value = index;
            tempImages = [];
            if(index > -1) {
                const p = points[index];
                document.getElementById('p_ticket').value = p.ticket || "";
                document.getElementById('p_title').value = p.title || "";
                document.getElementById('p_desc').value = p.desc || "";
                document.getElementById('p_assignee').value = p.assignee || "";
                document.getElementById('p_status').value = p.status || "open";
                
                tempImages = (p.images || []).map(img => {
                    if (typeof img === 'string') {
                        return { src: img, isLarge: false };
                    }
                    return img;
                });
            } else {
                document.getElementById('p_ticket').value = "";
                document.getElementById('p_title').value = "";
                document.getElementById('p_desc').value = "";
                document.getElementById('p_assignee').value = "";
                document.getElementById('p_status').value = "open";
            }
            window.renderModalImages();
            document.getElementById('modal').style.display = 'flex';
        };
        window.closeModal = function() { document.getElementById('modal').style.display = 'none'; };
        
        window.savePoint = function() {
            const idx = parseInt(document.getElementById('edit-index').value);
            const p = {
                ticket: document.getElementById('p_ticket').value,
                title: document.getElementById('p_title').value,
                desc: document.getElementById('p_desc').value,
                assignee: document.getElementById('p_assignee').value,
                status: document.getElementById('p_status').value,
                images: tempImages // Now storing objects {src, isLarge}
            };
            
            // Update local array first
            if(idx === -1) points.push(p); else points[idx] = p;
            
            // Save entire report to cloud
            const r = allReports.find(x => x.id === currentReportId);
            if(r) {
                r.points = points;
                saveReportToFirestore(r).then(() => {
                    window.showToast(translations[currentLang].toast_saved);
                });
            }

            window.closeModal();
            window.renderPointsList();
            window.renderStatusList();
        };

        // NEW DELETE POINT CONFIRMATION LOGIC
        window.askDeletePoint = function() {
            // Show confirmation modal for point deletion
            document.getElementById('delete-point-confirm-modal').style.display = 'flex';
        };

        window.closeDeletePointModal = function() {
            document.getElementById('delete-point-confirm-modal').style.display = 'none';
        };

        window.executeDeletePoint = function() {
            const idx = parseInt(document.getElementById('edit-index').value);
            if(idx > -1) {
                points.splice(idx, 1);
                const r = allReports.find(x => x.id === currentReportId);
                if(r) {
                    r.points = points;
                    saveReportToFirestore(r).then(() => {
                        window.showToast(translations[currentLang].toast_deleted);
                    });
                }
                window.closeModal(); // Close the edit modal
                window.renderPointsList();
                window.renderStatusList();
            }
            window.closeDeletePointModal(); // Close confirm modal
        };

        // --- IMAGES ---
        window.handleImageUpload = async function() {
            const files = document.getElementById('p_images').files;
            if(!files.length) return;
            
            document.getElementById('img-spinner').style.display = 'inline-block';
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                
                // 1. Resize/Compress using Canvas
                const processedBlob = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = e => {
                        const img = new Image();
                        img.onload = () => {
                            const cvs = document.createElement('canvas');
                            let w = img.width, h = img.height;
                            // 2K Resolution
                            if(w > 2048) { h *= 2048/w; w = 2048; } 
                            cvs.width = w; cvs.height = h;
                            const ctx = cvs.getContext('2d');
                            ctx.drawImage(img, 0, 0, w, h);
                            
                            cvs.toBlob(blob => {
                                if (blob) resolve(blob);
                                else reject(new Error("Canvas to Blob failed"));
                            }, 'image/jpeg', 0.8); 
                        };
                        img.onerror = reject;
                        img.src = e.target.result;
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });

                // 2. Upload to Firebase Storage
                try {
                    const reportId = currentReportId || 'temp_uploads'; 
                    const path = `images/${reportId}/${Date.now()}_${Math.random().toString(36).substr(2, 9)}.jpg`;
                    const storageRef = ref(storage, path);
                    
                    await uploadBytes(storageRef, processedBlob);
                    const downloadURL = await getDownloadURL(storageRef);
                    
                    // 3. Add to local state
                    tempImages.push({
                        src: downloadURL,
                        isLarge: false
                    });
                    
                } catch (error) {
                    console.error("Upload failed", error);
                    alert("Upload fehlgeschlagen: " + error.message);
                }
            }
            
            document.getElementById('img-spinner').style.display = 'none';
            window.renderModalImages();
        };

        window.renderModalImages = () => document.getElementById('modal-img-preview').innerHTML = tempImages.map((img,i)=>`<div class="img-thumb-container ${img.isLarge?'is-large':''}"><img src="${img.src}" class="img-thumb"><div class="img-btn-remove" onclick="window.removeTempImage(${i})">&times;</div><div class="img-btn-size ${img.isLarge?'active-large':''}" onclick="window.toggleImageSize(${i})"><i class="fa-solid ${img.isLarge?'fa-compress':'fa-expand'}"></i> <span>${img.isLarge?'GROSS':'NORMAL'}</span></div></div>`).join('');
        window.removeTempImage = (i) => { tempImages.splice(i,1); window.renderModalImages(); };
        window.toggleImageSize = (i) => { if(tempImages[i]) { tempImages[i].isLarge=!tempImages[i].isLarge; window.renderModalImages(); } };

        window.performExport = () => { const a=document.createElement('a'); a.href="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(allReports)); a.download=`backup_${new Date().toISOString().slice(0,10)}.json`; document.body.appendChild(a); a.click(); a.remove(); };
        window.importBackup = (input) => { const f=input.files[0]; if(!f)return; const r=new FileReader(); r.onload=e=>{ try { const d=JSON.parse(e.target.result); if(Array.isArray(d)) { if(confirm('OK=Überschreiben, Abbrechen=Anfügen')) d.forEach(x=>saveReportToFirestore(x)); else d.forEach(x=>{ if(!allReports.find(y=>y.id===x.id))saveReportToFirestore(x); }); alert("Import verarbeitet."); } else if(d.id) { saveReportToFirestore(d); alert("Importiert."); } } catch(err){alert("Fehler");} }; r.readAsText(f); input.value=''; };

        window.generatePDF = () => {
             const r=allReports.find(x=>x.id===currentReportId);
             let fn='Bericht.pdf';
             if(r) { const d=r.header.date_from||''; const c=(r.header.customer||'Kunde').replace(/[^a-z0-9äöüß]/gi,'_'); fn=`Bericht_${c}_${d}.pdf`; }
             const opt = { 
                 margin: 15, 
                 filename: fn, 
                 image: { type: 'jpeg', quality: 0.90 }, 
                 html2canvas: { scale: 2, useCORS: true }, 
                 jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
                 pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
             };
             html2pdf().set(opt).from(document.getElementById('pdf-preview')).save().catch(e=>console.error(e));
        };
        
        function getWeekNumber(d) { d=new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate())); d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7)); var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1)); return [Math.ceil((((d - yearStart) / 86400000) + 1) / 7), d.getUTCFullYear()]; }
        window.listen = (id) => { if(!('webkitSpeechRecognition' in window)) return alert('Browser nicht unterstützt'); const r=new webkitSpeechRecognition(); r.lang=currentLang==='de'?"de-DE":"en-US"; const btn=document.querySelector(`button[onclick*="${id}"]`); btn.classList.add('listening'); r.start(); r.onresult=e=>{ document.getElementById(id).value+=" "+e.results[0][0].transcript; btn.classList.remove('listening'); if(id.startsWith('h_'))window.updateCurrentReportHeader(); }; r.onerror=()=>{btn.classList.remove('listening');}; r.onend=()=>{btn.classList.remove('listening');}; };

        window.renderPDFPreview = () => {
             const r=allReports.find(x=>x.id===currentReportId); if(!r)return;
             const h=r.header; const pList=r.header.participants?r.header.participants.join(', '):'-'; const t=translations[currentLang];
             const formatDate=(d)=>{if(!d)return'';const p=d.split('-');if(p.length===3)return`${p[2]}.${p[1]}.${p[0]}`;return d;};
             
             const html = points.map(p => {
                 const safeImages = (p.images||[]).map(img => { const src=typeof img==='string'?img:img.src; const isLarge=typeof img==='string'?false:img.isLarge; return {src,isLarge}; });
                 const stTxt = p.status==='open'?t.status_open:t.status_resolved;
                 const assHtml = p.assignee ? `<p style="font-size:0.9rem;"><strong>${t.lbl_responsible}:</strong> ${p.assignee}</p>` : '';
                 return `<div style="margin-bottom:25px; page-break-inside: avoid;"><div style="border-bottom:1px solid #ddd; padding-bottom:5px; margin-bottom:10px; display:flex; justify-content:space-between;"><div>${p.ticket?`<b><i class="fa-solid fa-ticket" style="color:#666; margin-right:4px;"></i> CRM ${p.ticket}</b> `:''}<span style="font-size:1.2rem; font-weight:bold; color:${p.status==='open'?'#dc2626':'#16a34a'}">${p.title}</span></div><span style="font-size:0.8rem; border:1px solid #ccc; padding:2px 6px;">${stTxt}</span></div><p>${p.desc}</p>${assHtml}<div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;">${safeImages.map(img=>{ const s=img.isLarge?'width:100%; height:auto; margin-bottom:10px; border:1px solid #ddd; border-radius:4px; max-height: 250mm; object-fit: contain; page-break-inside: avoid; display: block;' : 'width:48%; height:auto; border:1px solid #ddd; border-radius:4px; max-height: 250mm; object-fit: contain; page-break-inside: avoid; display: block;'; return `<img src="${img.src}" style="${s}">`; }).join('')}</div></div>`;
             }).join('');
             
             document.getElementById('pdf-preview').innerHTML = `<div class="pdf-header" style="display:flex; justify-content:space-between;"><div><h1 style="margin:0;">${t.pdf_title}</h1><p style="color:#666;">${new Date().toLocaleDateString(currentLang==='de'?'de-DE':'en-US')}</p></div><img src="${LOGO_SRC}" style="height:40px;"></div><div style="background:#f8fafc; padding:15px; margin-bottom:30px; border-radius:8px;"><div><strong>${t.lbl_customer}:</strong> ${h.customer}</div><div><strong>${t.lbl_date}:</strong> ${formatDate(h.date_from)} bis ${formatDate(h.date_to)}</div><div><strong>${t.lbl_author}:</strong> ${h.author}</div><div><strong>${t.lbl_participants}:</strong> ${pList}</div></div>${html}`;
        };
        window.toggleFullScreen = () => { if(!document.fullscreenElement) document.documentElement.requestFullscreen().catch(e=>{}); else if(document.exitFullscreen) document.exitFullscreen().catch(e=>{}); };
    </script>
</body>
</html>
